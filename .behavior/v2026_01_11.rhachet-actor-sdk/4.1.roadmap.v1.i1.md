# roadmap: brain choice for review and reflect skills

checklist-style execution plan with ordered dependencies and behavioral acceptance criteria.

---

## phase.0 = foundation: genContextBrainChoice

### step.0.1 = install rhachet brain dependencies

- [ ] install `rhachet` package
- [ ] install `rhachet-brain-xai` package
- [ ] install `rhachet-brain-anthropic` package
- [ ] install `rhachet-brain-openai` package

**acceptance criteria:**
- `npm run build` passes with no type errors from new dependencies

**verification:**
```bash
npm run build
npm run test:types
```

---

### step.0.2 = create genContextBrainChoice function

**depends on:** step.0.1

- [ ] create `src/_topublish/rhachet/genContextBrainChoice.ts`
- [ ] implement brain ref parse (`{provider}/{family}/{model}`)
- [ ] implement brain lookup from `context.brain` registry
- [ ] implement api key validation for provider
- [ ] implement `BadRequestError` on invalid brain ref (shows available brains)
- [ ] implement `BadRequestError` on absent api key (shows env var name)

**acceptance criteria:**
- given a valid brain ref (`xai/grok/code-fast-1`)
  - when `genContextBrainChoice` is called
  - then returns `ContextBrainChoice` with `brain.choice` set

- given an invalid brain ref (`invalid/model/name`)
  - when `genContextBrainChoice` is called
  - then throws `BadRequestError` with list of available brains

- given a valid brain ref but absent api key
  - when `genContextBrainChoice` is called
  - then throws `BadRequestError` with env var name

**verification:**
```bash
npm run test:unit -- genContextBrainChoice
```

---

### step.0.3 = unit tests for genContextBrainChoice

**depends on:** step.0.2

- [ ] create `src/_topublish/rhachet/genContextBrainChoice.test.ts`
- [ ] test: valid brain ref parse (`xai/grok/code-fast-1` → provider=xai, family=grok, model=code-fast-1)
- [ ] test: invalid brain ref format throws `BadRequestError`
- [ ] test: brain not found throws `BadRequestError` with available list
- [ ] test: api key absent throws `BadRequestError` with env var name
- [ ] test: error message contains all available brains

**acceptance criteria:**
- all unit tests pass
- tests cover valid, invalid, and error paths

**verification:**
```bash
npm run test:unit -- genContextBrainChoice
```

---

### step.0.4 = integration tests for genContextBrainChoice

**depends on:** step.0.3

- [ ] create `src/_topublish/rhachet/genContextBrainChoice.integration.test.ts`
- [ ] test: resolve xai brain from registry (requires `XAI_API_KEY`)
- [ ] test: resolve anthropic brain from registry (requires `ANTHROPIC_API_KEY`)
- [ ] test: resolve openai brain from registry (requires `OPENAI_API_KEY`)

**acceptance criteria:**
- given `XAI_API_KEY` is set
  - when `genContextBrainChoice({ brain: 'xai/grok/code-fast-1' })` is called
  - then returns valid `ContextBrainChoice`

**verification:**
```bash
npm run test:integration -- genContextBrainChoice
```

---

## phase.1 = cli brain flag

### step.1.1 = add brain arg to review cli schema

**depends on:** step.0.4

- [ ] modify `src/contract/cli/review.ts`
- [ ] add `brain: z.string().optional()` to schema
- [ ] parse brain arg with default `xai/grok/code-fast-1`

**acceptance criteria:**
- given cli invoked with `--brain anthropic/claude/sonnet`
  - when args are parsed
  - then `args.named.brain` equals `anthropic/claude/sonnet`

- given cli invoked without `--brain`
  - when args are parsed
  - then brain defaults to `xai/grok/code-fast-1`

**verification:**
```bash
npm run test:unit -- review
```

---

### step.1.2 = add brain arg to reflect cli schema

**depends on:** step.0.4

- [ ] modify `src/contract/cli/reflect.ts`
- [ ] add `brain: z.string().optional()` to schema
- [ ] remove `rapid: z.string().optional()` from schema
- [ ] parse brain arg with default `xai/grok/code-fast-1`

**acceptance criteria:**
- given cli invoked with `--brain xai/grok/3`
  - when args are parsed
  - then `args.named.brain` equals `xai/grok/3`

- given cli invoked without `--brain`
  - when args are parsed
  - then brain defaults to `xai/grok/code-fast-1`

- given cli invoked with `--rapid true`
  - when args are parsed
  - then `rapid` is ignored (removed from schema)

**verification:**
```bash
npm run test:unit -- reflect
```

---

### step.1.3 = implement brain help output

**depends on:** step.1.1, step.1.2

- [ ] implement `--brain help` handler in review cli
- [ ] implement `--brain help` handler in reflect cli
- [ ] output shows all available brains with provider requirements

**acceptance criteria:**
- given cli invoked with `--brain help`
  - when executed
  - then prints list of available brains with api key requirements
  - then exits with code 0

**verification:**
```bash
npx tsx ./src/contract/cli/review.ts --brain help
npx tsx ./src/contract/cli/reflect.ts --brain help
```

---

## phase.2 = stepReview with brain choice

### step.2.1 = add brain input to stepReview

**depends on:** step.1.1

- [ ] modify `src/domain.operations/review/stepReview.ts`
- [ ] add `brain?: string` to input type
- [ ] default brain to `xai/grok/code-fast-1`
- [ ] call `genContextBrain()` to load brain registry
- [ ] call `genContextBrainChoice()` to resolve brain

**acceptance criteria:**
- `stepReview` accepts `brain?: string` input
- `stepReview` defaults brain to `xai/grok/code-fast-1` when not provided

**verification:**
```bash
npm run test:types
```

---

### step.2.2 = replace invokeClaudeCode with brain.choice.ask

**depends on:** step.2.1

- [ ] replace `invokeClaudeCode()` call with `context.brain.choice.ask()`
- [ ] adapt prompt format to brain.choice.ask requirements
- [ ] extract response from brain.choice result

**acceptance criteria:**
- given `stepReview` called with default brain
  - when review executes
  - then uses `context.brain.choice.ask()` for llm call
  - then returns review result with blockers/nitpicks

**verification:**
```bash
npm run test:integration -- stepReview
```

---

### step.2.3 = integration tests for stepReview brain choice

**depends on:** step.2.2

- [ ] create `src/domain.operations/review/stepReview.caseBrainChoice.integration.test.ts`
- [ ] test: default brain (`xai/grok/code-fast-1`) produces valid review
- [ ] test: explicit brain (`anthropic/claude/sonnet`) produces valid review
- [ ] test: invalid brain throws `BadRequestError` with available brains

**acceptance criteria:**
- given valid rules and paths
  - when `stepReview({ brain: 'xai/grok/code-fast-1' })` is called
  - then returns `StepReviewResult` with review content

- given invalid brain ref
  - when `stepReview({ brain: 'invalid/brain' })` is called
  - then throws `BadRequestError` with available brains in message

**verification:**
```bash
npm run test:integration -- stepReview.caseBrainChoice
```

---

### step.2.4 = wire review cli to stepReview brain arg

**depends on:** step.2.3

- [ ] modify `src/contract/cli/review.ts` main function
- [ ] pass `brain` arg to `stepReview({ brain })`

**acceptance criteria:**
- given cli invoked with `--brain anthropic/claude/sonnet`
  - when review executes
  - then uses anthropic/claude/sonnet for llm call

**verification:**
```bash
npx tsx ./src/contract/cli/review.ts --rules "**/*.md" --paths "src/**/*.ts" --output /tmp/review.md --brain xai/grok/code-fast-1
```

---

### step.2.5 = deprecate invokeClaudeCode

**depends on:** step.2.4

- [ ] mark `src/domain.operations/review/invokeClaudeCode.ts` as deprecated
- [ ] add deprecation comment: `// @deprecated use context.brain.choice.ask() instead`
- [ ] update or remove `invokeClaudeCode.integration.test.ts`

**acceptance criteria:**
- `invokeClaudeCode` is marked deprecated
- no active code paths use `invokeClaudeCode`

**verification:**
```bash
grep -r "invokeClaudeCode" src/domain.operations/review/*.ts
```

---

## phase.3 = stepReflect with brain choice

### step.3.1 = add brain input to stepReflect

**depends on:** step.2.4

- [ ] modify `src/domain.operations/reflect/stepReflect.ts`
- [ ] add `brain?: string` to input type
- [ ] remove `rapid?: boolean` from input type
- [ ] default brain to `xai/grok/code-fast-1`
- [ ] call `genContextBrain()` to load brain registry
- [ ] call `genContextBrainChoice()` to resolve brain

**acceptance criteria:**
- `stepReflect` accepts `brain?: string` input
- `stepReflect` no longer accepts `rapid?: boolean` input
- `stepReflect` defaults brain to `xai/grok/code-fast-1`

**verification:**
```bash
npm run test:types
```

---

### step.3.2 = replace invokeClaudeCodeForReflect with brain.choice.act

**depends on:** step.3.1

- [ ] replace `invokeClaudeCodeForReflect()` calls with `context.brain.choice.act()`
- [ ] adapt step1 prompt to brain.choice.act
- [ ] adapt step2 prompt to brain.choice.act
- [ ] extract results from brain.choice responses

**acceptance criteria:**
- given `stepReflect` called with default brain
  - when reflect executes
  - then uses `context.brain.choice.act()` for llm calls
  - then returns reflect result with rules created/updated

**verification:**
```bash
npm run test:integration -- stepReflect
```

---

### step.3.3 = remove rapid flag from compileReflectStep2Prompt

**depends on:** step.3.2

- [ ] modify `src/domain.operations/reflect/step2/compileReflectStep2Prompt.ts`
- [ ] remove `rapid?: boolean` from input type
- [ ] remove haiku-specific SET_UPDATE disable logic
- [ ] prompt is now uniform for all brains

**acceptance criteria:**
- `compileReflectStep2Prompt` no longer accepts `rapid` input
- prompt includes SET_UPDATE for all brains (no special haiku treatment)

**verification:**
```bash
npm run test:unit -- compileReflectStep2Prompt
```

---

### step.3.4 = integration tests for stepReflect brain choice

**depends on:** step.3.3

- [ ] create `src/domain.operations/reflect/stepReflect.caseBrainChoice.integration.test.ts`
- [ ] test: default brain (`xai/grok/code-fast-1`) produces valid rules
- [ ] test: explicit brain (`anthropic/claude/sonnet`) produces valid rules
- [ ] test: invalid brain throws `BadRequestError` with available brains

**acceptance criteria:**
- given valid source and target
  - when `stepReflect({ brain: 'xai/grok/code-fast-1' })` is called
  - then returns `StepReflectResult` with rules in draft directories

- given invalid brain ref
  - when `stepReflect({ brain: 'invalid/brain' })` is called
  - then throws `BadRequestError` with available brains in message

**verification:**
```bash
npm run test:integration -- stepReflect.caseBrainChoice
```

---

### step.3.5 = migrate haiku test to grok test

**depends on:** step.3.4

- [ ] rename `stepReflect.casePriorRules.haiku.integration.test.ts` to `stepReflect.casePriorRules.grok.integration.test.ts`
- [ ] change `rapid: true` to `brain: 'xai/grok/code-fast-1'`
- [ ] update assertions for grok capabilities
- [ ] update timeout appropriately

**acceptance criteria:**
- test file renamed from haiku to grok
- test uses `brain: 'xai/grok/code-fast-1'` instead of `rapid: true`
- test passes with grok brain

**verification:**
```bash
npm run test:integration -- stepReflect.casePriorRules.grok
```

---

### step.3.6 = migrate sonnet test to brain arg

**depends on:** step.3.4

- [ ] modify `stepReflect.casePriorRules.sonnet.integration.test.ts`
- [ ] change `rapid: false` to `brain: 'anthropic/claude/sonnet'`
- [ ] update timeout appropriately

**acceptance criteria:**
- test uses `brain: 'anthropic/claude/sonnet'` instead of `rapid: false`
- test passes with sonnet brain

**verification:**
```bash
npm run test:integration -- stepReflect.casePriorRules.sonnet
```

---

### step.3.7 = wire reflect cli to stepReflect brain arg

**depends on:** step.3.6

- [ ] modify `src/contract/cli/reflect.ts` main function
- [ ] pass `brain` arg to `stepReflect({ brain })`
- [ ] remove `rapid` arg passthrough

**acceptance criteria:**
- given cli invoked with `--brain anthropic/claude/sonnet`
  - when reflect executes
  - then uses anthropic/claude/sonnet for llm call

**verification:**
```bash
npx tsx ./src/contract/cli/reflect.ts --source /path/to/source --target /path/to/target --brain xai/grok/code-fast-1
```

---

### step.3.8 = deprecate invokeClaudeCodeForReflect

**depends on:** step.3.7

- [ ] mark `src/domain.operations/reflect/invokeClaudeCodeForReflect.ts` as deprecated
- [ ] add deprecation comment: `// @deprecated use context.brain.choice.act() instead`

**acceptance criteria:**
- `invokeClaudeCodeForReflect` is marked deprecated
- no active code paths use `invokeClaudeCodeForReflect`

**verification:**
```bash
grep -r "invokeClaudeCodeForReflect" src/domain.operations/reflect/*.ts
```

---

## phase.4 = cleanup: remove deprecated patterns

### step.4.1 = comment out price rate logic in reflect metrics

**depends on:** step.3.8

- [ ] modify `src/domain.operations/reflect/metrics/computeMetricsExpected.ts`
  - comment out cost calculation (lines 22-30)
  - add: `// todo: expose prices via rhachet BrainAtom and BrainRepl on responses`
- [ ] modify `src/domain.operations/reflect/metrics/computeMetricsRealized.ts`
  - comment out cost calculation (lines 77-96)
  - add: `// todo: expose prices via rhachet BrainAtom and BrainRepl on responses`

**acceptance criteria:**
- cost calculation logic is commented out
- todo comment documents upstream dependency
- tests still pass (metrics structure unchanged, cost values may be 0)

**verification:**
```bash
npm run test:unit -- computeMetrics
npm run test:integration -- stepReflect
```

---

### step.4.2 = comment out price rate logic in stepReview

**depends on:** step.3.8

- [ ] modify `src/domain.operations/review/stepReview.ts`
  - comment out realizedCosts calculation (lines 358-368)
  - add: `// todo: expose prices via rhachet BrainAtom and BrainRepl on responses`

**acceptance criteria:**
- realizedCosts calculation is commented out
- todo comment documents upstream dependency
- tests still pass

**verification:**
```bash
npm run test:integration -- stepReview
```

---

### step.4.3 = comment out usage extraction logic

**depends on:** step.3.8

- [ ] modify `src/domain.operations/reflect/invokeClaudeCodeForReflect.ts`
  - comment out ReflectClaudeUsage interface (lines 10-15)
  - comment out usage extraction (lines 174-185)
  - add: `// todo: expose usage via rhachet BrainAtom and BrainRepl on responses`

**acceptance criteria:**
- usage extraction logic is commented out
- todo comment documents upstream dependency

**verification:**
```bash
npm run test:types
```

---

### step.4.4 = remove rapid flag from reflect cli

**depends on:** step.3.7

- [ ] modify `src/contract/cli/reflect.ts`
- [ ] remove `rapid` from schemaOfArgs.named
- [ ] remove any `rapid` arg handler logic

**acceptance criteria:**
- `--rapid` flag no longer recognized by cli
- cli help no longer mentions `rapid`

**verification:**
```bash
npx tsx ./src/contract/cli/reflect.ts --help
```

---

## phase.5 = validation: backward compatibility

### step.5.1 = verify stepReview backward compatibility

**depends on:** step.4.4

- [ ] run all prior stepReview integration tests
- [ ] verify output format identical to prior version
- [ ] verify log structure identical to prior version

**acceptance criteria:**
- given `stepReview()` called without `brain` arg
  - when review executes
  - then uses default brain (`xai/grok/code-fast-1`)
  - then output format matches prior version

**verification:**
```bash
npm run test:integration -- stepReview
```

---

### step.5.2 = verify stepReflect backward compatibility

**depends on:** step.4.4

- [ ] run all prior stepReflect integration tests
- [ ] verify output format identical to prior version
- [ ] verify log structure identical to prior version

**acceptance criteria:**
- given `stepReflect()` called without `brain` arg
  - when reflect executes
  - then uses default brain (`xai/grok/code-fast-1`)
  - then output format matches prior version

**verification:**
```bash
npm run test:integration -- stepReflect
```

---

### step.5.3 = verify cli backward compatibility

**depends on:** step.5.1, step.5.2

- [ ] verify review cli works without `--brain` flag
- [ ] verify reflect cli works without `--brain` flag

**acceptance criteria:**
- given cli invoked without `--brain` flag
  - when executed
  - then uses default brain
  - then produces valid output

**verification:**
```bash
npx tsx ./src/contract/cli/review.ts --rules "**/*.md" --paths "src/**/*.ts" --output /tmp/review.md
npx tsx ./src/contract/cli/reflect.ts --source /path/to/source --target /path/to/target
```

---

### step.5.4 = run full test suite

**depends on:** step.5.3

- [ ] run all unit tests
- [ ] run all integration tests
- [ ] run all acceptance tests

**acceptance criteria:**
- all prior tests continue to pass
- no regressions introduced

**verification:**
```bash
npm run test:unit
npm run test:integration
npm run test:acceptance
```

---

## completion checklist

### phase.0 = foundation
- [ ] step.0.1 = install rhachet brain dependencies
- [ ] step.0.2 = create genContextBrainChoice function
- [ ] step.0.3 = unit tests for genContextBrainChoice
- [ ] step.0.4 = integration tests for genContextBrainChoice

### phase.1 = cli brain flag
- [ ] step.1.1 = add brain arg to review cli schema
- [ ] step.1.2 = add brain arg to reflect cli schema
- [ ] step.1.3 = implement brain help output

### phase.2 = stepReview with brain choice
- [ ] step.2.1 = add brain input to stepReview
- [ ] step.2.2 = replace invokeClaudeCode with brain.choice.ask
- [ ] step.2.3 = integration tests for stepReview brain choice
- [ ] step.2.4 = wire review cli to stepReview brain arg
- [ ] step.2.5 = deprecate invokeClaudeCode

### phase.3 = stepReflect with brain choice
- [ ] step.3.1 = add brain input to stepReflect
- [ ] step.3.2 = replace invokeClaudeCodeForReflect with brain.choice.act
- [ ] step.3.3 = remove rapid flag from compileReflectStep2Prompt
- [ ] step.3.4 = integration tests for stepReflect brain choice
- [ ] step.3.5 = migrate haiku test to grok test
- [ ] step.3.6 = migrate sonnet test to brain arg
- [ ] step.3.7 = wire reflect cli to stepReflect brain arg
- [ ] step.3.8 = deprecate invokeClaudeCodeForReflect

### phase.4 = cleanup
- [ ] step.4.1 = comment out price rate logic in reflect metrics
- [ ] step.4.2 = comment out price rate logic in stepReview
- [ ] step.4.3 = comment out usage extraction logic
- [ ] step.4.4 = remove rapid flag from reflect cli

### phase.5 = validation
- [ ] step.5.1 = verify stepReview backward compatibility
- [ ] step.5.2 = verify stepReflect backward compatibility
- [ ] step.5.3 = verify cli backward compatibility
- [ ] step.5.4 = run full test suite

---

## dependency graph

```
step.0.1
    └── step.0.2
            └── step.0.3
                    └── step.0.4
                            ├── step.1.1 ──────────────────────┐
                            │       └── step.2.1               │
                            │               └── step.2.2       │
                            │                       └── step.2.3
                            │                               └── step.2.4
                            │                                       └── step.2.5
                            │
                            └── step.1.2 ──────────────────────┤
                                    │                          │
                                    └── step.1.3 ◄─────────────┘
                                            │
                                            └── step.3.1
                                                    └── step.3.2
                                                            └── step.3.3
                                                                    └── step.3.4
                                                                            ├── step.3.5
                                                                            ├── step.3.6
                                                                            └── step.3.7
                                                                                    └── step.3.8
                                                                                            │
                                                                                            ├── step.4.1
                                                                                            ├── step.4.2
                                                                                            ├── step.4.3
                                                                                            └── step.4.4
                                                                                                    │
                                                                                                    ├── step.5.1
                                                                                                    ├── step.5.2
                                                                                                    └── step.5.3
                                                                                                            └── step.5.4
```

---

## total: 23 steps across 6 phases
