# research: test code patterns for init.research

## summary

the rhachet-roles-bhrain codebase has established test patterns for unit, integration, and acceptance tests. init.research will [REUSE] most patterns and [EXTEND] the fixture structure for research-specific tests.

---

## pattern.1 = BDD test structure

### given/when/then from test-fns

**[REUSE]** behavior-driven development pattern with `given`, `when`, `then` from `test-fns` [1]

```typescript
import { given, then, when } from 'test-fns';

describe('stepRouteStoneGet.integration', () => {
  given('[case1] route.approved fixture (complete route)', () => {
    const routePath = path.join(ASSETS_DIR, 'route.approved');

    when('[t0] query is @next-one', () => {
      then('returns empty because stone is passed', async () => {
        const result = await stepRouteStoneGet({
          stone: '@next-one',
          route: routePath,
        });
        expect(result.stones).toHaveLength(0);
        expect(result.emit?.stdout).toContain('all stones passed');
      });
    });
  });
});
```

> "use `given('[caseN]')` for scenario setup, `when('[tN]')` for time/event, `then()` for assertions"

**init.research adaptation**: use BDD pattern for integration tests of `initResearchDir`, `setResearchBind`, etc.

---

## pattern.2 = test file name conventions

### file extension conventions

**[REUSE]** test file name by scope [2]

| extension | scope | example |
|-----------|-------|---------|
| `.test.ts` | unit tests | `formatReviewOutput.test.ts` |
| `.integration.test.ts` | integration tests | `stepRouteStoneGet.integration.test.ts` |
| `.acceptance.test.ts` | blackbox acceptance | `driver.route.bind.acceptance.test.ts` |

> "unit tests in `.test.ts`, integration in `.integration.test.ts`, acceptance in `.acceptance.test.ts`"

**init.research adaptation**: create `initResearchDir.test.ts` for unit, `initResearchDir.integration.test.ts` for integration

---

## pattern.3 = test assets directory

### `.test/assets/` structure

**[REUSE]** test assets in collocated `.test/assets/` directory [3]

```
src/domain.operations/route/
├── stepRouteStoneGet.ts
├── stepRouteStoneGet.integration.test.ts
└── .test/
    ├── setup.ts               # fixture paths
    └── assets/
        ├── route.simple/
        ├── route.parallel/
        ├── route.guarded/
        └── route.approved/
```

> "test fixtures in `.test/assets/` directory, collocated with the code they test"

**init.research adaptation**: create `.test/assets/` with research directory fixtures

---

## pattern.4 = fixture centralization

### setup.ts for fixture paths

**[REUSE]** centralized fixture paths via `setup.ts` [4]

```typescript
/**
 * .what = test fixtures path for route operations
 * .why = centralizes path resolution for test assets
 */
export const ASSETS_DIR = path.join(__dirname, 'assets');

/**
 * .what = route fixture paths
 * .why = enables consistent reference to test fixtures
 */
export const FIXTURES = {
  simple: path.join(ASSETS_DIR, 'route.simple'),
  parallel: path.join(ASSETS_DIR, 'route.parallel'),
  guarded: path.join(ASSETS_DIR, 'route.guarded'),
  approved: path.join(ASSETS_DIR, 'route.approved'),
  reviewed: path.join(ASSETS_DIR, 'route.reviewed'),
  alternate: path.join(ASSETS_DIR, 'route.alternate'),
} as const;
```

> "centralizes path resolution for test assets, enables consistent reference to test fixtures"

**init.research adaptation**: create `FIXTURES` constant with research directory variants

---

## pattern.5 = temp directory pattern

### beforeEach/afterEach cleanup

**[REUSE]** temp directory creation and cleanup for tests that modify state [5]

```typescript
given('[case2] route with partial completion', () => {
  const tempDir = path.join(os.tmpdir(), `test-get-partial-${Date.now()}`);

  beforeEach(async () => {
    await fs.cp(path.join(ASSETS_DIR, 'route.parallel'), tempDir, {
      recursive: true,
    });
    // complete first stone
    await fs.writeFile(path.join(tempDir, '2.criteria.md'), '# Criteria');
    await fs.mkdir(path.join(tempDir, '.route'), { recursive: true });
    await fs.writeFile(path.join(tempDir, '.route', '2.criteria.passed'), '');
  });

  afterEach(async () => {
    await fs.rm(tempDir, { recursive: true, force: true });
  });

  when('[t0] query is @next-one', () => {
    then('returns first 3.1.x stone', async () => {
      // test against tempDir
    });
  });
});
```

> "copy fixture to temp dir in beforeEach, clean up in afterEach, enables state mutation tests"

**init.research adaptation**: use temp directories for `initResearchDir` tests that create files

---

## pattern.6 = context generator pattern

### genContext* helpers

**[REUSE]** context generator helpers for test setup [6]

```typescript
import { ContextLogTrail } from 'as-procedure';
import { pick } from 'type-fns';

export const genContextLogTrail = (): ContextLogTrail => ({
  log: {
    ...pick(console, ['debug', 'log', 'info', 'warn', 'error']),
    trail: [],
  },
});
```

> "context generators provide test-ready dependency injection for operations"

**init.research adaptation**: reuse `genContextLogTrail` for research operation tests

---

## pattern.7 = acceptance test structure

### blackbox/ directory

**[REUSE]** acceptance tests in separate `blackbox/` directory [7]

```
blackbox/
├── .test/
│   ├── assets/
│   │   └── route-driver/        # fixture directory
│   ├── invokeRouteSkill.ts      # skill invocation helper
│   └── invokeReviewSkill.ts     # skill invocation helper
├── driver.route.bind.acceptance.test.ts
├── driver.route.get.acceptance.test.ts
└── review.representative-clean.acceptance.test.ts
```

> "acceptance tests invoke skills via shell entrypoints, verify blackbox behavior"

**init.research adaptation**: create `init.research.acceptance.test.ts` in `blackbox/`

---

## pattern.8 = genTempDirForRhachet

### temp directory with rhachet setup

**[REUSE]** temp directory creation with rhachet roles link [8]

```typescript
/**
 * .what = creates a temp directory ready for rhachet roles link
 * .why = enables acceptance tests with git repo and node_modules symlink
 */
export const genTempDirForRhachet = (input: {
  slug: string;
  clone: string;
}): string => {
  return genTempDir({
    slug: input.slug,
    clone: input.clone,
    git: true,
    symlink: [
      // symlink rhachet-roles-bhrain package for the driver role
      {
        at: 'node_modules/rhachet-roles-bhrain/package.json',
        to: 'package.json',
      },
      { at: 'node_modules/rhachet-roles-bhrain/dist', to: 'dist' },
      // symlink .bin for npx to find rhx/rhachet commands
      { at: 'node_modules/.bin', to: 'node_modules/.bin' },
    ],
  });
};
```

> "creates a temp directory ready for rhachet roles link, enables acceptance tests with git repo and node_modules symlink"

**init.research adaptation**: use `genTempDirForRhachet` for acceptance tests of init.research skill

---

## pattern.9 = skill invocation helper

### invokeRouteSkill / invokeReviewSkill

**[EXTEND]** skill invocation helpers for acceptance tests [9]

```typescript
/**
 * .what = invokes a route skill via its shell entrypoint
 * .why = enables blackbox acceptance tests against the skill as invoked by rhachet
 */
export const invokeRouteSkill = async (input: {
  skill: 'route.bind' | 'route.stone.get' | 'route.stone.set' | 'route.stone.del' | 'route.stone.judge';
  args: Record<string, string | boolean | undefined>;
  cwd: string;
}): Promise<{ stdout: string; stderr: string; code: number }> => {
  const skillFile = `${input.skill}.sh`;
  const skillPath = path.join(
    input.cwd,
    '.agent/repo=bhrain/role=driver/skills',
    skillFile,
  );
  // ... invocation logic
};
```

> "invokes a skill via its shell entrypoint, enables blackbox acceptance tests"

**init.research adaptation**: create `invokeResearchSkill` helper or extend pattern for librarian role

---

## pattern.10 = useThen for shared results

### to avoid redundant operations

**[REUSE]** `useThen` from test-fns for shared operation results [10]

```typescript
when('[t0] route.bind --route <path>', () => {
  const res = useThen('invoke bind skill', async () => {
    const tempDir = genTempDirForRhachet({
      slug: 'driver-bind-set',
      clone: ASSETS_DIR,
    });

    await execAsync('npx rhachet roles link --role driver', {
      cwd: tempDir,
    });
    await execAsync('git checkout -b vlad/test-bind', { cwd: tempDir });

    const cli = await invokeRouteSkill({
      skill: 'route.bind',
      args: { route: '.' },
      cwd: tempDir,
    });

    return { cli, tempDir };
  });

  then('exit code is 0', () => {
    expect(res.cli.code).toEqual(0);
  });

  then('stdout confirms bound route', () => {
    expect(res.cli.stdout).toContain('bound route');
  });
});
```

> "useThen calls the operation once and shares result across adjacent then blocks"

**init.research adaptation**: use `useThen` to prevent redundant skill invocations in tests

---

## pattern summary

| pattern | file/directory | action | notes |
|---------|----------------|--------|-------|
| BDD structure | `test-fns` | [REUSE] | given/when/then pattern |
| file name conventions | `*.test.ts`, etc | [REUSE] | unit/integration/acceptance |
| test assets | `.test/assets/` | [REUSE] | fixture directories |
| fixture centralization | `.test/setup.ts` | [REUSE] | `FIXTURES` constant |
| temp directory | `beforeEach/afterEach` | [REUSE] | cleanup pattern |
| context generators | `genContextLogTrail` | [REUSE] | dependency injection |
| acceptance structure | `blackbox/` | [REUSE] | separate directory |
| rhachet temp dir | `genTempDirForRhachet` | [REUSE] | symlink setup |
| skill invocation | `invokeRouteSkill` | [EXTEND] | add `invokeResearchSkill` |
| shared results | `useThen` | [REUSE] | prevent redundant calls |

---

## citations

| # | source | description |
|---|--------|-------------|
| 1 | `src/domain.operations/route/stepRouteStoneGet.integration.test.ts` | BDD test structure |
| 2 | various test files | file name conventions |
| 3 | `src/domain.operations/route/.test/assets/` | test assets structure |
| 4 | `src/domain.operations/route/.test/setup.ts` | fixture centralization |
| 5 | `src/domain.operations/route/stepRouteStoneGet.integration.test.ts:27-41` | temp directory pattern |
| 6 | `src/.test/genContextLogTrail.ts` | context generator pattern |
| 7 | `blackbox/` directory | acceptance test structure |
| 8 | `blackbox/.test/invokeRouteSkill.ts:9-32` | genTempDirForRhachet |
| 9 | `blackbox/.test/invokeRouteSkill.ts:38-81` | skill invocation helper |
| 10 | `blackbox/driver.route.bind.acceptance.test.ts:15-45` | useThen pattern |
