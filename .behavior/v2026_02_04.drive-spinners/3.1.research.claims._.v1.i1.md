# research: claims for drive-spinners

## focus: multi-line overwrite vs single-line spinner

the central question: can we reliably overwrite a 10-20 line guard tree in-place, or should we only animate the last line?

---

## claims about multi-line overwrite

### [FACT] 1. log-update supports stderr via dedicated export

log-update provides `logUpdateStderr()` and `createLogUpdate(stream)` for arbitrary writable streams.

> "Log by overwrite of the previous output in the terminal."

source: [sindresorhus/log-update readme](https://github.com/sindresorhus/log-update) [1]

### [FACT] 2. log-update does partial redraws to reduce flicker

> "Performs partial redraws when possible to reduce flicker."

source: [sindresorhus/log-update readme](https://github.com/sindresorhus/log-update) [1]

### [FACT] 3. line wraps break multi-line overwrite math

when a logical line wraps to two visual lines, the cursor-up count is wrong — the library counts logical lines, not visual lines.

> "When the terminal is small enough so that the line of progress would wrap, it creates a new line instead of overwrite of the current line of progress."

source: [webpack/webpack#9221](https://github.com/webpack/webpack/issues/9221) [2]

### [FACT] 4. log-update had a specific line-wrap count bug

> "Lines that exceed the console width are not accounted for in the line count calculation."

fixed via `wrap-ansi` hard-wrap mode.

source: [sindresorhus/log-update#19](https://github.com/sindresorhus/log-update/issues/19) [3]

### [FACT] 5. content that exceeds terminal height clips silently

log-update clips output to terminal height. this is not optional.

> "When handed output with more rows than the terminal has, log-update at best wastes time on invisible data, and at worst causes scroll."

source: [sindresorhus/log-update#30](https://github.com/sindresorhus/log-update/issues/30) [4]

### [FACT] 6. scrolled content cannot be updated

once lines scroll into the scrollback buffer, cursor-up cannot reach them. this is a fundamental terminal constraint.

> "The problem of duplicate lines in the output is related to the restriction, within which it is not possible to change the value of a line outside the work area."

source: [listr2/listr2#296](https://github.com/listr2/listr2/issues/296) [5]

### [FACT] 7. multiple blank lines at the end collapse into one

> "Multiple blank lines at the end will become one"

source: [sindresorhus/log-update#62](https://github.com/sindresorhus/log-update/issues/62) [6]

### [FACT] 8. listr2 breaks when tasks overflow terminal height

this is inherited from log-update and remains unsolved.

> "Listr2 breaks if number of tasks overflow the terminal height" [...] "I could not come up with a good solution to this problem"

source: [listr2/listr2#296](https://github.com/listr2/listr2/issues/296) [5]

### [FACT] 9. listr2 truncates lines because of log-update issues

> "The main reason for truncation of strings as the default is that `log-update` [...] can show some weird behavior if you exceed the terminal height or width."

source: [listr2/listr2#260](https://github.com/listr2/listr2/issues/260) [7]

---

## claims about non-tty / ci environments

### [FACT] 10. github actions runs in non-tty mode

multi-line overwrite cannot work. cursor-up sequences have no effect.

> `echo "$(tty)"` produces "not a tty". "Multiple tools that can provide pretty coloured logs do not work as expected."

source: [actions/runner#241](https://github.com/actions/runner/issues/241) [8]

### [FACT] 11. log-update does NOT gate on isatty()

unlike ora (which disables spinners in non-tty), log-update emits ansi escape sequences regardless.

> ora: "The spinner will be enabled if the stream is run inside a TTY context (not spawned or piped) and/or not in a CI environment."

source: [sindresorhus/ora readme](https://github.com/sindresorhus/ora) [9]

### [SUMP] 12. in piped/non-tty contexts, log-update will emit raw escape sequences

since log-update does not check isatty(), piped output will contain garbled escape codes.

> "output ANSI escape sequences into the logs, hard to read output"

source: [moby/buildkit#4534](https://github.com/moby/buildkit/issues/4534) [10]

---

## claims about stderr vs stdout

### [FACT] 13. the unix convention is stderr for progress, stdout for data

> "The accepted practice is to keep the program's final output on stdout and all else to stderr."

source: [julien harbulot - how and when to use stdout and stderr](https://julienharbulot.com/python-cli-streams.html) [11]

### [FACT] 14. both streams go through the same pty — terminal cannot tell them apart

> "Both stdout (fd 1) and stderr (fd 2) are typically connected to the same PTY. The terminal emulator receives a single merged stream of bytes."

source: [aram drevekenin - anatomy of a terminal emulator](https://poor.dev/blog/terminal-anatomy/) [12]

### [FACT] 15. ansi escape codes work identically on both streams when connected to a tty

> "When both stdout and stderr point to the same terminal, ANSI escape codes work identically on both streams."

source: [evan klitzke - color and ttys](https://eklitzke.org/ansi-color-codes) [13]

### [OPIN] 16. interleave of spinner on stderr with data on stdout can cause garbled output

> "ora swallows stdout that precedes `.stop()`. Since ora writes to stderr by default while `console.log` writes to stdout, the two streams can interact in unexpected ways."

source: [sindresorhus/ora#90](https://github.com/sindresorhus/ora/issues/90) [14]

---

## claims about single-line approach

### [FACT] 17. the codebase already has a single-line spinner that works

`stepReview.ts` lines 104-139 use `process.stdout.write('\r...')` to overwrite one line. braille frames at 100ms intervals. ~25-30 chars per line — never wraps.

source: local file `src/domain.operations/review/stepReview.ts` [15]

### [FACT] 18. ora explicitly chose single-line by design

> "Ora is designed to display a single spinner at a time."

source: [sindresorhus/ora readme](https://github.com/sindresorhus/ora) [9]

### [OPIN] 19. braille spinners are best for short sequential tasks

> "Braille alphabet characters are quite a popular choice for spinners. They're best suited for one or a few sequential tasks that should wrap up quickly."

source: [evil martians - cli ux best practices](https://evilmartians.com/chronicles/cli-ux-best-practices-3-patterns-for-improving-progress-displays) [16]

### [OPIN] 20. spinners should tick on meaningful events, not just time

> "The spinner could tick each time it finishes another file. This way, the spinner shows activity and also signals if the process has been stuck for too long."

source: [evil martians - cli ux best practices](https://evilmartians.com/chronicles/cli-ux-best-practices-3-patterns-for-improving-progress-displays) [16]

---

## claims about claude code's experience

### [FACT] 21. claude code had multi-line overwrite flicker bugs

> "The entire terminal buffer redraws with each update of the status indicator, the screen flashes text from earlier in the session instead of only a refresh of the status line."

source: [anthropics/claude-code#769](https://github.com/anthropics/claude-code/issues/769) [17]

### [FACT] 22. the fix was line-specific updates, not full redraws

> "The implementation should use line-specific updates (via terminal control sequences) rather than a full buffer redraw for each status change."

source: [anthropics/claude-code#769](https://github.com/anthropics/claude-code/issues/769) [17]

---

## claims about terminal compatibility

### [FACT] 23. terminals support different subsets of ansi escape codes

> "Various terminals support different subsets of these codes, and it's difficult to find an 'authoritative' list of what every code does."

source: [li haoyi - build your own command line with ansi escape codes](https://www.lihaoyi.com/post/BuildyourownCommandLinewithANSIescapecodes.html) [18]

### [FACT] 24. terminal multiplexers (tmux, screen) may not support all sequences

> "While these modes may be supported by most terminals, some may not work in multiplexers like tmux."

source: [ansi escape codes gist](https://gist.github.com/fnky/458719343aabd01cfb17a3a4f7296797) [19]

---

## the central question

### [KHUE] 25. is multi-line tree display worth the complexity for our use case?

the guard tree has at most ~15-20 lines (artifacts + reviews + judges). reviews and judges run sequentially. the tree structure is static after enumeration — only the status line of the active item changes.

trade-off matrix:

| approach | terminal compat | ci/non-tty | line-wrap risk | complexity | info density |
|---|---|---|---|---|---|
| single-line `\r` | excellent | degrades gracefully | none (short lines) | ~35 lines | low (one item at a time) |
| multi-line log-update | good in tty | emits garbled escape codes | known issues | ~100-200 lines + dep | high (full tree) |
| multi-line diy | good in tty | must gate on isatty() | must implement wrap math | ~150-250 lines | high (full tree) |
| hybrid: print tree once, animate last line | excellent | degrades gracefully | none | ~80 lines | medium (tree + active item) |

### [KHUE] 26. should we use the hybrid approach?

print the full guard tree structure once (non-animated), then animate only the active line with `\r` overwrite. when a review/judge completes, print its result line and move the spinner to the next active item.

this avoids:
- multi-line overwrite complexity
- terminal height overflow
- line-wrap math
- non-tty garbled output
- log-update dependency

while still shown:
- full tree structure
- which item is active + elapsed time
- results as they complete
- cached indicators

---

## citations

1. [sindresorhus/log-update readme](https://github.com/sindresorhus/log-update)
2. [webpack/webpack#9221](https://github.com/webpack/webpack/issues/9221)
3. [sindresorhus/log-update#19](https://github.com/sindresorhus/log-update/issues/19)
4. [sindresorhus/log-update#30](https://github.com/sindresorhus/log-update/issues/30)
5. [listr2/listr2#296](https://github.com/listr2/listr2/issues/296)
6. [sindresorhus/log-update#62](https://github.com/sindresorhus/log-update/issues/62)
7. [listr2/listr2#260](https://github.com/listr2/listr2/issues/260)
8. [actions/runner#241](https://github.com/actions/runner/issues/241)
9. [sindresorhus/ora readme](https://github.com/sindresorhus/ora)
10. [moby/buildkit#4534](https://github.com/moby/buildkit/issues/4534)
11. [julien harbulot - stdout and stderr](https://julienharbulot.com/python-cli-streams.html)
12. [aram drevekenin - anatomy of a terminal emulator](https://poor.dev/blog/terminal-anatomy/)
13. [evan klitzke - color and ttys](https://eklitzke.org/ansi-color-codes)
14. [sindresorhus/ora#90](https://github.com/sindresorhus/ora/issues/90)
15. local: `src/domain.operations/review/stepReview.ts` lines 104-139
16. [evil martians - cli ux best practices](https://evilmartians.com/chronicles/cli-ux-best-practices-3-patterns-for-improving-progress-displays)
17. [anthropics/claude-code#769](https://github.com/anthropics/claude-code/issues/769)
18. [li haoyi - ansi escape codes](https://www.lihaoyi.com/post/BuildyourownCommandLinewithANSIescapecodes.html)
19. [ansi escape codes gist](https://gist.github.com/fnky/458719343aabd01cfb17a3a4f7296797)
