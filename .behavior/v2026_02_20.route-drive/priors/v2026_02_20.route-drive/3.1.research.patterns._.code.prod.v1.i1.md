# research: production code patterns for route.drive

## overview

this document identifies production code patterns in this repo relevant to implementing route.drive. each pattern is marked as [REUSE], [EXTEND], or [REPLACE] based on how it relates to the wish.

---

## pattern 1: role registration

**[REUSE]**

roles are registered via `Role.build()` with hooks defined in the `hooks.onBrain` object.

> src/domain.roles/behaver/getBehaverRole.ts:3-33
> ```typescript
> export const ROLE_BEHAVER: Role = Role.build({
>   slug: 'behaver',
>   name: 'Behaver',
>   purpose: 'declare clear, buildable, and testable behaviors',
>   ...
>   hooks: {
>     onBrain: {
>       onBoot: [
>         {
>           command:
>             './node_modules/.bin/rhachet run --repo bhuild --role behaver --init claude.hooks/sessionstart.boot-behavior',
>           timeout: 'PT10S',
>         },
>       ],
>       onTool: [],
>       onStop: [],
>     },
>   },
> });
> ```

**relevance to wish**: route.drive needs an `onStop` hook registered in `hooks.onBrain.onStop` to fire when the session ends.

---

## pattern 2: hook shell dispatcher as thin wrapper

**[REUSE]**

hook shell files delegate to TypeScript via `node -e "import('rhachet-roles-bhuild').then(m => m.cli.xxx())"`.

> src/domain.roles/behaver/inits/claude.hooks/sessionstart.boot-behavior.sh:19-21
> ```bash
> # note: no set -e because we must exit 0 always
> set -uo pipefail
>
> # delegate to TypeScript implementation via package export
> node -e "import('rhachet-roles-bhuild').then(m => m.cli.bootBehavior())" -- "$@" || exit 0
> ```

**relevance to wish**: route.drive hook will follow this same pattern — a thin shell file in `inits/claude.hooks/` that delegates to a TypeScript CLI entry point.

---

## pattern 3: skill shell dispatcher as thin wrapper

**[REUSE]**

skill shell files also delegate to TypeScript using the same pattern.

> src/domain.roles/behaver/skills/bind.behavior.sh:19-23
> ```bash
> set -euo pipefail
>
> exec node -e "import('rhachet-roles-bhuild').then(m => m.cli.bindBehavior())" -- "$@"
> ```

**relevance to wish**: route.stone.set and route.stone.get skills will follow this pattern.

---

## pattern 4: cli entry point with zod schema

**[REUSE]**

cli entry points use `getCliArgs({ schema })` for type-safe arg parsing.

> src/contract/cli/bind.behavior.ts:24-36
> ```typescript
> const schemaOfArgs = z.object({
>   named: z.object({
>     // skill-specific args
>     behavior: z.string().optional(),
>     dir: z.string().optional(),
>     // rhachet passthrough args (optional, ignored)
>     repo: z.string().optional(),
>     role: z.string().optional(),
>     skill: z.string().optional(),
>     s: z.string().optional(),
>   }),
>   ordered: z.array(z.string()).default([]),
> });
> ```

> src/contract/cli/bind.behavior.ts:42-43
> ```typescript
> export const bindBehavior = (): void => {
>   const { named, ordered } = getCliArgs({ schema: schemaOfArgs });
> ```

**relevance to wish**: route.stone.set will need args like `--stone`, `--as` (passed|promised), and `--that` (for slug). this pattern handles all arg parsing.

---

## pattern 5: cli export via index.ts

**[EXTEND]**

all cli entry points are exported from `src/index.ts` under the `cli` object.

> src/index.ts:16-30
> ```typescript
> export const cli = {
>   bindBehavior: () => withEmojiSpaceShim({ logic: async () => bindBehavior() }),
>   bootBehavior: () => withEmojiSpaceShim({ logic: async () => bootBehavior() }),
>   ...
> };
> ```

**relevance to wish**: new entry points will be added:
- `cli.routeDrive` — the onStop hook
- `cli.routeStoneGet` — get stone info
- `cli.routeStoneSet` — set stone as passed/promised

---

## pattern 6: branch-to-behavior bind

**[REUSE]**

binds are stored as flag files in `.behavior/{name}/.bind/{branch}.flag`.

> src/domain.operations/behavior/bind/getBranchBehaviorBind.ts:11-57
> ```typescript
> export const getBranchBehaviorBind = (
>   input: { branchName?: string },
>   context?: { cwd?: string },
> ): { behaviorDir: string | null; binds: string[] } => {
>   ...
>   // search for .behavior/*/.bind/${flagFileName}
>   const behaviorRoot = join(cwd, '.behavior');
>   ...
>   for (const behaviorDirName of behaviorDirs) {
>     const bindDir = join(behaviorRoot, behaviorDirName, '.bind');
>     const flagPath = join(bindDir, flagFileName);
>     if (existsSync(flagPath)) {
>       binds.push(join(behaviorRoot, behaviorDirName));
>     }
>   }
>   ...
> };
> ```

**relevance to wish**: route.drive uses `getBranchBehaviorBind` to discover if a route is bound. this operation is already complete.

---

## pattern 7: boot behavior context output

**[EXTEND]**

boot behavior outputs structured context with xml tags.

> src/contract/cli/boot.behavior.ts:21-35
> ```typescript
> const outputBehaviorFile = (
>   tag: string,
>   filepath: string,
>   isRequired: boolean,
> ): void => {
>   if (existsSync(filepath)) {
>     const relpath = relative(process.cwd(), filepath);
>     console.log(`<behavior-${tag} path="${relpath}">`);
>     console.log(readFileSync(filepath, 'utf-8'));
>     console.log(`</behavior-${tag}>`);
>     console.log('');
>   } else if (isRequired) {
>     console.error(`⚠️  required file not found: ${filepath}`);
>   }
> };
> ```

**relevance to wish**: route.drive needs similar output format — a `<stone>` tag containing the current stone's content. the vision specifies tree-style output with owl emoji header.

---

## pattern 8: behavior artifact directory structure

**[EXTEND]**

behaviors follow a structured directory layout.

> inferred from boot.behavior.ts:86-106
> ```
> .behavior/{name}/
>   ├─ 0.wish.md
>   ├─ 1.vision.md
>   ├─ 2.1.criteria.blackbox.md
>   ├─ 2.3.criteria.blueprint.md
>   ├─ 3.*.md (research, blueprint, roadmap, etc.)
>   ├─ .bind/
>   │   └─ {branch}.flag
>   └─ (future: .guard/ for promise tracking)
> ```

**relevance to wish**: route.drive needs to:
1. enumerate stones in the behavior directory
2. determine which is "current" (first unpassed)
3. read stone content for echo
4. store promise artifacts in `.guard/` or similar

---

## pattern 9: domain object with domain-objects library

**[EXTEND]**

domain objects use `DomainLiteral` or `DomainEntity` from the `domain-objects` package.

> src/domain.objects/BehaviorArtifact.ts:7-41
> ```typescript
> interface BehaviorArtifact {
>   path: string;
>   name: string;
>   version: number | null;
>   attempt: number | null;
>   filename: string;
> }
> class BehaviorArtifact
>   extends DomainLiteral<BehaviorArtifact>
>   implements BehaviorArtifact
> {
>   public static primary = ['path'] as const;
>   public static unique = ['path'] as const;
> }
> ```

**relevance to wish**: new domain objects needed:
- `Stone` — a waypoint in a route (entity)
- `StonePromise` — record of a self-review attestation (event)
- `ReviewSelf` — configuration for a self-review guard (literal)

---

## pattern 10: domain operation get/set/del

**[REUSE]**

domain operations follow get/set/del naming convention.

> src/domain.operations/behavior/bind/index.ts
> ```typescript
> export { getBranchBehaviorBind } from './getBranchBehaviorBind';
> export { setBranchBehaviorBind } from './setBranchBehaviorBind';
> export { delBranchBehaviorBind } from './delBranchBehaviorBind';
> ```

**relevance to wish**: new operations needed:
- `getStoneByRoute` — get current stone for a route
- `getAllStonesByRoute` — enumerate stones in a route
- `setStoneStatus` — mark stone as passed
- `getStonePromises` — get promise artifacts for a stone
- `setStonePromise` — record a promise for a review.self slug

---

## pattern 11: flattenBranchName for filesystem safety

**[REUSE]**

branch names are flattened for filesystem use.

> src/domain.operations/behavior/bind/flattenBranchName.ts (referenced)
> ```typescript
> // converts "vlad/route-drive" -> "vlad.route-drive"
> ```

**relevance to wish**: promises may need branch-scoped storage; this utility is already available.

---

## pattern 12: yaml frontmatter parsing (needed)

**[NEW — not yet implemented]**

stones can have yaml frontmatter with guard configuration.

> from vision 1.vision.md (expected format)
> ```yaml
> ---
> guard:
>   review:
>     self:
>       - slug: all-done
>         say: |
>           did you complete everything requested in this stone?
> ---
> ```

**relevance to wish**: need to implement yaml frontmatter parsing for stone files to extract `guard.review.self` configuration.

---

## summary: pattern disposition

| pattern | action | reason |
|---------|--------|--------|
| role registration | [REUSE] | add `onStop` hook to behaver role |
| hook shell dispatcher | [REUSE] | create `sessionstop.route-drive.sh` |
| skill shell dispatcher | [REUSE] | create `route.stone.set.sh`, `route.stone.get.sh` |
| cli entry with zod | [REUSE] | standard arg parsing pattern |
| cli export via index | [EXTEND] | add new entry points |
| branch-to-behavior bind | [REUSE] | route.drive checks bind status |
| boot behavior output | [EXTEND] | route.drive outputs stone context |
| behavior artifact dirs | [EXTEND] | add `.guard/` for promises |
| domain-objects library | [EXTEND] | add Stone, StonePromise, ReviewSelf |
| get/set/del operations | [REUSE] | create stone operations |
| flattenBranchName | [REUSE] | available for promise storage |
| yaml frontmatter | [NEW] | implement for guard config |

---

## key implementation files to create

based on pattern analysis:

### hooks
- `src/domain.roles/behaver/inits/claude.hooks/sessionstop.route-drive.sh`

### skills
- `src/domain.roles/behaver/skills/route.drive.sh`
- `src/domain.roles/behaver/skills/route.stone.get.sh`
- `src/domain.roles/behaver/skills/route.stone.set.sh`

### cli entry points
- `src/contract/cli/route.drive.ts`
- `src/contract/cli/route.stone.get.ts`
- `src/contract/cli/route.stone.set.ts`

### domain objects
- `src/domain.objects/Stone.ts`
- `src/domain.objects/StonePromise.ts`
- `src/domain.objects/ReviewSelf.ts`

### domain operations
- `src/domain.operations/route/getStoneByRoute.ts`
- `src/domain.operations/route/getAllStonesByRoute.ts`
- `src/domain.operations/route/setStoneStatus.ts`
- `src/domain.operations/route/getStonePromises.ts`
- `src/domain.operations/route/setStonePromise.ts`
- `src/domain.operations/route/parseStoneYamlFrontmatter.ts`

---

## citations

1. src/domain.roles/behaver/getBehaverRole.ts — role registration with hooks
2. src/domain.roles/behaver/inits/claude.hooks/sessionstart.boot-behavior.sh — hook dispatcher pattern
3. src/domain.roles/behaver/skills/bind.behavior.sh — skill dispatcher pattern
4. src/contract/cli/bind.behavior.ts — cli entry point pattern
5. src/index.ts — cli export pattern
6. src/domain.operations/behavior/bind/getBranchBehaviorBind.ts — bind discovery
7. src/contract/cli/boot.behavior.ts — context output pattern
8. src/domain.objects/BehaviorArtifact.ts — domain object pattern
9. src/infra/cli/getCliArgs.ts — arg parsing utility
