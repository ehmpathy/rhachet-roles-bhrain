# roadmap for portable-skills

execution checklist for the blueprint in [3.3.blueprint.v1.i1.md](./3.3.blueprint.v1.i1.md).

---

## references

- [0.wish.md](./0.wish.md) — replicate portable skills pattern from bhuild PR #27
- [3.3.blueprint.v1.i1.md](./3.3.blueprint.v1.i1.md) — implementation phases and target state

---

## milestone 0: foundation infrastructure

**depends on**: nothing (first milestone)

### step 0.1: add devDependencies self-reference

- [ ] **task**: add `"rhachet-roles-bhrain": "file:."` to `devDependencies` in `package.json`
- [ ] **task**: run `npm install` to create symlink in `node_modules/`

**acceptance criteria**:
```
given(package.json has self-reference in devDependencies)
  when(npm install completes)
    then(node_modules/rhachet-roles-bhrain exists)
    then(node_modules/rhachet-roles-bhrain is a symlink to repo root)
```

**verification**:
```bash
# verify symlink exists and points to repo root
ls -la node_modules/rhachet-roles-bhrain
# expected: lrwxrwxrwx ... node_modules/rhachet-roles-bhrain -> ../..

# verify package resolves
node -e "console.log(require.resolve('rhachet-roles-bhrain'))"
# expected: /path/to/repo/dist/index.js (after build)
```

---

### step 0.2: create getCliArgs utility

- [ ] **task**: create directory `src/infra/cli/`
- [ ] **task**: create `src/infra/cli/getCliArgs.ts` with arg parse logic
- [ ] **task**: create `src/infra/cli/index.ts` barrel export

**acceptance criteria**:
```
given(getCliArgs utility exists)
  when(imported with a zod schema)
    then(parses --key value args into named object)
    then(parses -k value short args into named object)
    then(parses --key=value args into named object)
    then(parses positional args into ordered array)
    then(strips rhachet passthrough args (--repo, --role, --skill, -s, --))
    then(validates against zod schema)
    then(exits with error on invalid args)
```

**verification**:
```bash
# verify types compile
npm run test:types
# expected: no errors

# verify file exists
ls src/infra/cli/getCliArgs.ts
# expected: file listed
```

---

### step 0.3: verify foundation builds

- [ ] **task**: run `npm run build`
- [ ] **task**: verify `dist/infra/cli/` exists

**acceptance criteria**:
```
given(foundation infrastructure created)
  when(npm run build completes)
    then(dist/infra/cli/getCliArgs.js exists)
    then(dist/infra/cli/index.js exists)
    then(no type errors)
```

**verification**:
```bash
npm run build
ls dist/infra/cli/
# expected: getCliArgs.js index.js
```

---

## milestone 1: review skill conversion

**depends on**: milestone 0 (foundation infrastructure)

### step 1.1: create review cli entry point

- [ ] **task**: create directory `src/contract/cli/`
- [ ] **task**: create `src/contract/cli/review.ts` with zod schema and stepReview invocation

**acceptance criteria**:
```
given(review cli entry point exists)
  when(imported and called)
    then(parses --rules, --diffs, --paths, --output, --mode, --rapid args)
    then(ignores rhachet passthrough args)
    then(invokes stepReview with parsed args)
```

**verification**:
```bash
# verify types compile
npm run test:types
# expected: no errors

# verify file exists
ls src/contract/cli/review.ts
# expected: file listed
```

---

### step 1.2: update review shell script

- [ ] **task**: update `src/domain.roles/reviewer/skills/review/review.sh`
- [ ] **task**: replace `exec npx tsx "$SCRIPT_DIR/review.ts"` with `exec npx tsx -e "import('rhachet-roles-bhrain').then(m => m.cli.review())"`
- [ ] **task**: remove `SCRIPT_DIR` and `REPO_ROOT` logic (no longer needed)

**acceptance criteria**:
```
given(review.sh uses package import pattern)
  when(executed from repo root)
    then(resolves rhachet-roles-bhrain from node_modules)
    then(invokes cli.review() entry point)
    then(passes all args via -- "$@")
  when(executed from symlinked .agent/ location)
    then(still resolves rhachet-roles-bhrain correctly)
    then(skill functions identically)
```

**verification** (after milestone 3):
```bash
# direct invocation from repo root
./src/domain.roles/reviewer/skills/review/review.sh --help
# expected: should not error (may show usage or run skill)
```

---

## milestone 2: reflect skill conversion

**depends on**: milestone 1 (review skill proves pattern works)

### step 2.1: create reflect cli entry point

- [ ] **task**: create `src/contract/cli/reflect.ts` with zod schema and stepReflect invocation

**acceptance criteria**:
```
given(reflect cli entry point exists)
  when(imported and called)
    then(parses --source, --target, --mode, --force, --rapid args)
    then(ignores rhachet passthrough args)
    then(invokes stepReflect with parsed args)
```

**verification**:
```bash
# verify types compile
npm run test:types
# expected: no errors

# verify file exists
ls src/contract/cli/reflect.ts
# expected: file listed
```

---

### step 2.2: update reflect shell script

- [ ] **task**: update `src/domain.roles/reviewer/skills/reflect/reflect.sh`
- [ ] **task**: replace `exec npx tsx "$SCRIPT_DIR/reflect.ts"` with `exec npx tsx -e "import('rhachet-roles-bhrain').then(m => m.cli.reflect())"`
- [ ] **task**: remove `SCRIPT_DIR` and `REPO_ROOT` logic (no longer needed)

**acceptance criteria**:
```
given(reflect.sh uses package import pattern)
  when(executed from repo root)
    then(resolves rhachet-roles-bhrain from node_modules)
    then(invokes cli.reflect() entry point)
    then(passes all args via -- "$@")
  when(executed from symlinked .agent/ location)
    then(still resolves rhachet-roles-bhrain correctly)
    then(skill functions identically)
```

**verification** (after milestone 3):
```bash
# direct invocation from repo root
./src/domain.roles/reviewer/skills/reflect/reflect.sh --help
# expected: should not error (may show usage or run skill)
```

---

## milestone 3: wire up exports

**depends on**: milestone 2 (all cli entry points created)

### step 3.1: update src/index.ts

- [ ] **task**: import review and reflect from `./contract/cli/`
- [ ] **task**: export `cli` namespace object with both entry points

**acceptance criteria**:
```
given(src/index.ts exports cli namespace)
  when(package is imported)
    then(cli.review is a function)
    then(cli.reflect is a function)
  when(package is built)
    then(dist/index.js exports cli namespace)
```

**verification**:
```bash
# verify types compile
npm run test:types
# expected: no errors

# verify build
npm run build
# expected: completes without errors

# verify exports work (via node repl)
node -e "const m = require('./dist'); console.log(typeof m.cli.review, typeof m.cli.reflect)"
# expected: function function
```

---

### step 3.2: verify portable dispatch works

- [ ] **task**: run review skill via package import pattern
- [ ] **task**: run reflect skill via package import pattern

**acceptance criteria**:
```
given(cli namespace exported and built)
  when(npx tsx -e "import('rhachet-roles-bhrain').then(m => m.cli.review())" is executed)
    then(review skill runs without module resolution errors)
  when(npx tsx -e "import('rhachet-roles-bhrain').then(m => m.cli.reflect())" is executed)
    then(reflect skill runs without module resolution errors)
```

**verification**:
```bash
# rebuild to ensure dist/ is current
npm run build

# test review via package import
npx tsx -e "import('rhachet-roles-bhrain').then(m => console.log('review loaded:', typeof m.cli.review))"
# expected: review loaded: function

# test reflect via package import
npx tsx -e "import('rhachet-roles-bhrain').then(m => console.log('reflect loaded:', typeof m.cli.reflect))"
# expected: reflect loaded: function
```

---

## milestone 4: end-to-end validation

**depends on**: milestone 3 (exports wired up)

### step 4.1: verify shell scripts work from repo root

- [ ] **task**: execute review.sh from repo root
- [ ] **task**: execute reflect.sh from repo root

**acceptance criteria**:
```
given(shell scripts updated with package import pattern)
  when(./src/domain.roles/reviewer/skills/review/review.sh executed)
    then(does not error on module resolution)
    then(skill logic executes or shows usage)
  when(./src/domain.roles/reviewer/skills/reflect/reflect.sh executed)
    then(does not error on module resolution)
    then(skill logic executes or shows usage)
```

**verification**:
```bash
# test review.sh
./src/domain.roles/reviewer/skills/review/review.sh 2>&1 | head -5
# expected: no "Cannot find module" errors

# test reflect.sh
./src/domain.roles/reviewer/skills/reflect/reflect.sh 2>&1 | head -5
# expected: no "Cannot find module" errors
```

---

### step 4.2: verify skills work via rhachet

- [ ] **task**: run `rhachet roles link` to update symlinks
- [ ] **task**: execute skills via `npx rhachet run --skill`

**acceptance criteria**:
```
given(rhachet symlinks skills to .agent/)
  when(npx rhachet run --skill review --repo bhrain --role reviewer executed)
    then(skill resolves via package import)
    then(skill executes without module resolution errors)
  when(npx rhachet run --skill reflect --repo bhrain --role reviewer executed)
    then(skill resolves via package import)
    then(skill executes without module resolution errors)
```

**verification**:
```bash
# update symlinks
rhachet roles link --role reviewer

# test via rhachet (may need actual args for full execution)
npx rhachet run --skill review --repo bhrain --role reviewer 2>&1 | head -10
# expected: no "Cannot find module" errors, skill begins execution

npx rhachet run --skill reflect --repo bhrain --role reviewer 2>&1 | head -10
# expected: no "Cannot find module" errors, skill begins execution
```

---

### step 4.3: verify skills work when symlinked

- [ ] **task**: execute skill via `.agent/` symlink path

**acceptance criteria**:
```
given(skill shell script symlinked to .agent/repo=bhrain/role=reviewer/skills/)
  when(.agent/repo=bhrain/role=reviewer/skills/review/review.sh executed)
    then(package import resolves from consumer's node_modules)
    then(skill functions identically to repo-root execution)
```

**verification**:
```bash
# verify symlink exists
ls -la .agent/repo=bhrain/role=reviewer/skills/review/review.sh
# expected: symlink to dist/domain.roles/reviewer/skills/review/review.sh

# execute via symlink path
.agent/repo=bhrain/role=reviewer/skills/review/review.sh 2>&1 | head -5
# expected: no "Cannot find module" errors
```

---

### step 4.4: verify tests pass

- [ ] **task**: run type checks
- [ ] **task**: run unit tests
- [ ] **task**: run integration tests

**acceptance criteria**:
```
given(all changes complete)
  when(npm run test:types executed)
    then(no type errors)
  when(npm run test:unit executed)
    then(all unit tests pass)
  when(npm run test:integration executed)
    then(all integration tests pass)
```

**verification**:
```bash
npm run test:types
# expected: exit 0

npm run test:unit
# expected: all tests pass

npm run test:integration
# expected: all tests pass
```

---

## milestone 5: documentation (optional)

**depends on**: milestone 4 (validation complete)

### step 5.1: create portable-skills-pattern brief

- [ ] **task**: create `src/domain.roles/reviewer/briefs/portable-skills-pattern.md`
- [ ] **task**: document the dispatch pattern, self-reference rationale, and arg schema requirements

**acceptance criteria**:
```
given(brief created)
  when(brief read by developer)
    then(explains isomorphic shell dispatch pattern)
    then(explains devDependencies self-reference purpose)
    then(explains cli entry point structure)
    then(explains zod schema requirements for rhachet args)
```

**verification**:
```bash
# verify file exists
ls src/domain.roles/reviewer/briefs/portable-skills-pattern.md
# expected: file listed

# verify included in build
npm run build
ls dist/domain.roles/reviewer/briefs/portable-skills-pattern.md
# expected: file listed
```

---

## dependency graph

```
milestone 0: foundation
    └── step 0.1: devDependencies self-reference
    └── step 0.2: getCliArgs utility
    └── step 0.3: verify build
            │
            ▼
milestone 1: review skill
    └── step 1.1: review cli entry point
    └── step 1.2: review shell script
            │
            ▼
milestone 2: reflect skill
    └── step 2.1: reflect cli entry point
    └── step 2.2: reflect shell script
            │
            ▼
milestone 3: wire exports
    └── step 3.1: update src/index.ts
    └── step 3.2: verify portable dispatch
            │
            ▼
milestone 4: e2e validation
    └── step 4.1: shell scripts from repo root
    └── step 4.2: skills via rhachet
    └── step 4.3: skills when symlinked
    └── step 4.4: tests pass
            │
            ▼
milestone 5: documentation (optional)
    └── step 5.1: portable-skills-pattern brief
```

---

## rollback plan

if issues arise after deployment:

1. **revert shell scripts** — restore `$SCRIPT_DIR` pattern
2. **remove cli exports** — restore original `src/index.ts`
3. **remove cli entry points** — delete `src/contract/cli/`
4. **remove infra** — delete `src/infra/cli/`
5. **remove self-reference** — delete from `devDependencies`

all changes are additive and non-destructive to core skill logic.

---

## success criteria

the wish is fulfilled when:

- [ ] shell scripts use `exec npx tsx -e "import('rhachet-roles-bhrain')..."` pattern
- [ ] `src/index.ts` exports `cli.review` and `cli.reflect`
- [ ] `package.json` has `"rhachet-roles-bhrain": "file:."` in devDependencies
- [ ] skills work identically when invoked from:
  - repo root (`./src/.../review.sh`)
  - rhachet (`npx rhachet run --skill review`)
  - symlink (`.agent/.../review.sh`)
- [ ] all tests pass
