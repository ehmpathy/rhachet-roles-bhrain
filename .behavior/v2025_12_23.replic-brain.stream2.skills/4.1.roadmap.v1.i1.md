# execution roadmap: bhrain.struct.v1

---

## references

- wish: `0.wish.md`
- vision: `1.vision.md`
- criteria: `2.criteria.md`
- distillation: `3.2.distill.domain._.v1.i1.md`
- blueprint: `3.3.blueprint.v1.i1.md`

---

## execution principles

1. **ordered dependencies**: each step depends on prior steps being complete
2. **behavioral acceptance**: each step has criteria from `2.criteria.md`
3. **verification required**: each step must pass its tests before proceeding
4. **no skipping**: steps must be completed in order

---

## phase 0: foundation (domain objects)

### step 0.1: core literals

**depends on:** nothing

**deliverables:**
- [ ] `src/domain.objects/Bhrain/BhrainAtom.ts`
- [ ] `src/domain.objects/Bhrain/BhrainContext.ts`
- [ ] `src/domain.objects/BhrainMemory/BhrainMemoryTokenUsage.ts`

**acceptance criteria:**
```
given('a valid bhrain.struct.v1 configuration')
  given('an llm atom is specified (e.g., claude, qwen)')
    then('BhrainAtom captures provider + model')
    then('BhrainContext captures provider-keyed credentials')
```

**verification:**
- [ ] `npm run test:types` passes
- [ ] domain objects instantiate without error
- [ ] serialization round-trips correctly

---

### step 0.2: message literals

**depends on:** step 0.1

**deliverables:**
- [ ] `src/domain.objects/BhrainSession/BhrainSessionMessage.ts`
- [ ] `src/domain.objects/BhrainTool/BhrainToolCall.ts`
- [ ] `src/domain.objects/BhrainTool/BhrainToolResult.ts`
- [ ] `src/domain.objects/BhrainTool/BhrainToolDefinition.ts`

**acceptance criteria:**
```
given('the brain generates valid tool calls')
  then('BhrainToolCall captures id, name, input')
  then('BhrainToolResult captures callId, success, output')
  then('BhrainSessionMessage captures role, content, toolCalls')
```

**verification:**
- [ ] `npm run test:types` passes
- [ ] message literals support all role types (system, user, assistant, tool)
- [ ] tool call/result pairing works via callId

---

### step 0.3: plugin interfaces

**depends on:** step 0.2

**deliverables:**
- [ ] `src/domain.objects/BhrainTool/BhrainToolBox.ts`
- [ ] `src/domain.objects/BhrainMemory/BhrainMemoryManager.ts`
- [ ] `src/domain.objects/BhrainMemory/BhrainMemoryCompactionResult.ts`
- [ ] `src/domain.objects/BhrainPermission/BhrainPermissionGuard.ts`
- [ ] `src/domain.objects/BhrainPermission/BhrainPermissionDecision.ts`

**acceptance criteria:**
```
given('bhrain.struct.v1 supports pluggable toolboxes')
  then('BhrainToolBox defines name, definitions, execute')

given('bhrain.struct.v1 supports pluggable memory managers')
  then('BhrainMemoryManager defines shouldUpdate, getUpdate')

given('bhrain.struct.v1 supports pluggable permission guards')
  then('BhrainPermissionGuard defines check returning allow/deny/prompt')
```

**verification:**
- [ ] `npm run test:types` passes
- [ ] plugin interfaces are callable
- [ ] decision types cover all cases (allow, deny, prompt)

---

### step 0.4: session and loop entities

**depends on:** step 0.3

**deliverables:**
- [ ] `src/domain.objects/BhrainSession/BhrainSession.ts`
- [ ] `src/domain.objects/BhrainLoop/BhrainLoopIteration.ts`
- [ ] `src/domain.objects/BhrainLoop/BhrainLoopResult.ts`
- [ ] `src/domain.objects/Bhrain/BhrainConfig.ts`

**acceptance criteria:**
```
given('a bhrain executing an agentic loop')
  then('BhrainSession tracks status, iterationCount, tokenUsage')
  then('BhrainLoopIteration tracks hadToolCalls, toolCallCount')
  then('BhrainLoopResult captures finalResponse, terminationReason')
  then('BhrainConfig captures atom, toolBoxes, memoryManager, permissionGuard')
```

**verification:**
- [ ] `npm run test:types` passes
- [ ] session status transitions work (ACTIVE → COMPLETED | TERMINATED)
- [ ] termination reasons cover all cases (NATURAL_COMPLETION, MAX_ITERATIONS, ERROR)

---

### step 0.5: domain events

**depends on:** step 0.4

**deliverables:**
- [ ] `src/domain.objects/BhrainLoop/BhrainLoopIterationCompletedEvent.ts`
- [ ] `src/domain.objects/BhrainTool/BhrainToolExecutionCompletedEvent.ts`
- [ ] `src/domain.objects/BhrainMemory/BhrainMemoryCompactedEvent.ts`

**acceptance criteria:**
```
given('a bhrain executing')
  when('the agentic loop iterates')
    then('iteration count is tracked')
    then('context token usage is tracked')
  when('tools are called')
    then('tool calls are logged with inputs')
    then('tool results are logged with outputs')
```

**verification:**
- [ ] `npm run test:types` passes
- [ ] events have unique keys for deduplication
- [ ] events capture timing (occurredAt)

---

## phase 1: access layer (sdks)

### step 1.1: anthropic sdk

**depends on:** step 0.2, step 0.3

**deliverables:**
- [ ] `src/access/sdks/anthropic/sdkAnthropic.ts`
- [ ] `src/access/sdks/anthropic/sdkAnthropic.integration.test.ts`

**acceptance criteria:**
```
given('bhrain.struct.v1 is configured')
  when('the atom is set to "claude"')
    then('anthropic claude API is used for generation')
    then('tool calls follow claude's format')

given('a bhrain executing an agentic loop')
  when('the llm API returns an error')
    then('the error is caught')
    then('retry logic is applied if appropriate')
```

**verification:**
- [ ] `npm run test:integration -- sdkAnthropic` passes
- [ ] generates text response for simple prompt
- [ ] generates tool_use blocks when tools provided
- [ ] handles API errors gracefully

---

### step 1.2: openai sdk (tool support)

**depends on:** step 0.2, step 0.3

**deliverables:**
- [ ] update `src/access/sdk/sdkOpenAi.ts` with tool calling
- [ ] `src/access/sdk/sdkOpenAi.integration.test.ts`

**acceptance criteria:**
```
given('bhrain.struct.v1 is configured')
  when('the atom is set to "openai"')
    then('openai API is used for generation')
    then('tool calls follow openai's format')
```

**verification:**
- [ ] `npm run test:integration -- sdkOpenAi` passes
- [ ] generates function_call blocks when tools provided
- [ ] casts to BhrainSessionMessage correctly

---

### step 1.3: qwen sdk

**depends on:** step 1.2

**deliverables:**
- [ ] `src/access/sdks/qwen/sdkQwen.ts`
- [ ] `src/access/sdks/qwen/sdkQwen.integration.test.ts`

**acceptance criteria:**
```
given('bhrain.struct.v1 is configured')
  when('the atom is set to "qwen"')
    then('qwen API is used for generation')
    then('tool calls follow qwen's format')
    then('the agentic loop behaves identically')
```

**verification:**
- [ ] `npm run test:integration -- sdkQwen` passes
- [ ] uses openai-compatible endpoint
- [ ] handles qwen-specific quirks

---

## phase 2: core operations

### step 2.1: llm response generation

**depends on:** step 1.1, step 1.2, step 1.3

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/llm/generateBhrainLlmResponse.ts`
- [ ] `src/domain.operations/brain.replic.arch1/llm/generateBhrainLlmResponse.test.ts`

**acceptance criteria:**
```
given('bhrain.struct.v1 is configured')
  when('invoked with a simple input requiring no tools')
    then('the brain produces a text response')
    then('the response is coherent and addresses the input')
    then('no tool calls are made')

  when('invoked with an input requiring tool use')
    then('the brain identifies which tools are needed')
    then('the brain generates valid tool calls')
```

**verification:**
- [ ] `npm run test:unit -- generateBhrainLlmResponse` passes
- [ ] routes to correct provider based on atom
- [ ] returns normalized BhrainSessionMessage

---

### step 2.2: tool execution

**depends on:** step 0.3

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/tool/executeBhrainToolCall.ts`
- [ ] `src/domain.operations/brain.replic.arch1/tool/executeBhrainToolCall.test.ts`
- [ ] `src/domain.operations/brain.replic.arch1/tool/mergeBhrainToolBoxes.ts`
- [ ] `src/domain.operations/brain.replic.arch1/tool/mergeBhrainToolBoxes.test.ts`

**acceptance criteria:**
```
given('a bhrain with a permission configuration')
  when('the brain attempts a pre-approved operation')
    then('the operation executes without prompting')
  when('the brain attempts a blocked operation')
    then('the operation is rejected')
    then('the brain receives a rejection result')

given('a bhrain with a limited tool set')
  when('the llm generates a call to a non-existent tool')
    then('an error result is returned')
    then('available tools are listed in the error')
```

**verification:**
- [ ] `npm run test:unit -- executeBhrainToolCall` passes
- [ ] `npm run test:unit -- mergeBhrainToolBoxes` passes
- [ ] permission guard is consulted before execution
- [ ] tool not found returns helpful error

---

### step 2.3: loop iteration

**depends on:** step 2.1, step 2.2

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/loop/iterateBhrainLoop.ts`
- [ ] `src/domain.operations/brain.replic.arch1/loop/iterateBhrainLoop.test.ts`

**acceptance criteria:**
```
given('a bhrain with tools available (files, bash, websearch)')
  when('the input requires multi-step reasoning')
    then('each iteration: generates response → checks for tool calls → executes tools → appends results')

  when('the brain generates multiple tool calls in one response')
    then('all tool calls are executed')
    then('all results are appended to context')
```

**verification:**
- [ ] `npm run test:unit -- iterateBhrainLoop` passes
- [ ] single iteration completes generate → tools → append cycle
- [ ] multiple tool calls are all executed
- [ ] returns hadToolCalls flag correctly

---

### step 2.4: loop orchestration

**depends on:** step 2.3

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/loop/runBhrainLoop.ts`
- [ ] `src/domain.operations/brain.replic.arch1/loop/runBhrainLoop.integration.test.ts`

**acceptance criteria:**
```
given('a bhrain with tools available')
  when('the input requires multi-step reasoning')
    then('the brain enters an agentic loop')
    then('the loop continues until no tool calls are generated')
    then('the final response is returned to the caller')

  when('the loop exceeds max iterations')
    then('the loop terminates gracefully')
    then('the brain returns a partial response with explanation')
```

**verification:**
- [ ] `npm run test:integration -- runBhrainLoop` passes
- [ ] loop terminates on no tool calls (NATURAL_COMPLETION)
- [ ] loop terminates on max iterations (MAX_ITERATIONS)
- [ ] memory manager is consulted between iterations

---

### step 2.5: brain invocation

**depends on:** step 2.4, step 0.4

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/core/invokeBhrain.ts`
- [ ] `src/domain.operations/brain.replic.arch1/core/invokeBhrain.integration.test.ts`
- [ ] `src/domain.operations/brain.replic.arch1/readme.md`

**acceptance criteria:**
```
given('a valid bhrain.struct.v1 configuration')
  given('an llm atom is specified')
    when('invoked with a simple input requiring no tools')
      then('the brain produces a text response')
      then('the response is coherent and addresses the input')

given('a bhrain is invoked')
  when('the input is empty string')
    then('the brain responds with a clarification request')

given('a bhrain with a context window limit')
  when('the input exceeds the context window')
    then('an error is returned before execution')
```

**verification:**
- [ ] `npm run test:integration -- invokeBhrain` passes
- [ ] creates session, builds messages, runs loop
- [ ] handles empty input gracefully
- [ ] handles oversized input with clear error

---

## phase 3: plugins

### step 3.1: allowAll permission guard

**depends on:** step 0.3

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/plugins/permissionGuards/allowAll.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/permissionGuards/allowAll.test.ts`

**acceptance criteria:**
```
given('bhrain.struct.v1 supports pluggable permission guards')
  when('no permission guard is provided')
    then('all tool calls are allowed')

  when('the permission guard returns "allow"')
    then('the tool executes immediately')
```

**verification:**
- [ ] `npm run test:unit -- allowAll` passes
- [ ] always returns { decision: 'allow' }

---

### step 3.2: files toolbox

**depends on:** step 0.3, step 3.1

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/files/read.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/files/write.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/files/edit.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/files/glob.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/files/grep.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/files/index.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/files/toolBoxFiles.integration.test.ts`

**acceptance criteria:**
```
given('the files tool is available')
  when('the brain calls read with a valid file path')
    then('the file contents are returned')
    then('the result is appended to context')

  when('the brain calls read with a non-existent file')
    then('an error result is returned')
    then('the brain can reason about the error and recover')

  when('the brain calls write with content')
    then('the file is written to disk')
    then('a success result is returned')

  when('the brain calls edit with old_string and new_string')
    then('the replacement is performed')
    then('the updated content is confirmed in result')

  when('the brain calls glob with a pattern')
    then('matching file paths are returned')

  when('the brain calls grep with a pattern')
    then('matching lines and file paths are returned')
```

**verification:**
- [ ] `npm run test:integration -- toolBoxFiles` passes
- [ ] read returns file contents
- [ ] read error on missing file
- [ ] write creates/overwrites file
- [ ] edit performs replacement
- [ ] glob returns matching paths
- [ ] grep returns matching lines

---

### step 3.3: bash toolbox

**depends on:** step 0.3, step 3.1

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/bash/execute.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/bash/index.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/bash/toolBoxBash.integration.test.ts`

**acceptance criteria:**
```
given('the bash tool is available')
  when('the brain calls bash with a valid command')
    then('the command is executed in a shell')
    then('stdout and stderr are captured')
    then('the exit code is returned')
    then('the result is appended to context')

  when('the brain calls bash with a command that fails')
    then('the error output is returned')
    then('the non-zero exit code is returned')
    then('the brain can reason about the failure and recover')

  when('the brain calls bash with a long-running command')
    then('a timeout is enforced')
    then('the command is killed if it exceeds the timeout')
    then('a timeout error is returned')

  when('the brain calls bash with a command producing large output')
    then('output is truncated at a configurable limit')
    then('a truncation notice is included')
```

**verification:**
- [ ] `npm run test:integration -- toolBoxBash` passes
- [ ] captures stdout, stderr, exit code
- [ ] handles command failure gracefully
- [ ] enforces timeout
- [ ] truncates large output

---

### step 3.4: truncate memory manager

**depends on:** step 0.3

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/plugins/memoryManagers/truncate.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/memoryManagers/truncate.test.ts`

**acceptance criteria:**
```
given('builtin strategy: truncate')
  when('context approaches the limit')
    then('oldest messages are dropped')
    then('no llm call is made')
```

**verification:**
- [ ] `npm run test:unit -- truncate` passes
- [ ] drops oldest messages first
- [ ] preserves system message
- [ ] no llm call made

---

### step 3.5: summarizeOnLimit memory manager

**depends on:** step 2.1, step 3.4

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/plugins/memoryManagers/summarizeOnLimit.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/memoryManagers/summarizeOnLimit.integration.test.ts`

**acceptance criteria:**
```
given('builtin strategy: summarize-on-limit')
  when('context approaches the limit')
    then('earlier messages are summarized by the llm')
    then('tool results are condensed')

given('bhrain.struct.v1 supports pluggable memory managers')
  when('no memory manager is provided')
    then('a default summarization-on-limit manager is used')
```

**verification:**
- [ ] `npm run test:integration -- summarizeOnLimit` passes
- [ ] summarizes via llm call
- [ ] reduces token count
- [ ] preserves recent context

---

### step 3.6: websearch toolbox

**depends on:** step 0.3, step 3.1

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/websearch/search.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/websearch/index.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/toolBoxes/websearch/toolBoxWebsearch.integration.test.ts`

**acceptance criteria:**
```
given('the websearch tool is available')
  when('the brain calls websearch with a query')
    then('search results are returned')
    then('results include titles, urls, and snippets')

  when('the search returns no results')
    then('an empty result set is returned')
    then('the brain can adjust its approach')

  when('the search fails (network error)')
    then('an error result is returned')
    then('the brain can retry or proceed without')
```

**verification:**
- [ ] `npm run test:integration -- toolBoxWebsearch` passes
- [ ] returns titles, urls, snippets
- [ ] handles empty results
- [ ] handles network errors

---

### step 3.7: promptForWrites permission guard

**depends on:** step 3.1

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/plugins/permissionGuards/promptForWrites.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/permissionGuards/promptForWrites.test.ts`

**acceptance criteria:**
```
given('a bhrain with a permission configuration')
  when('the brain attempts an operation requiring approval')
    then('the operation is paused')
    then('the user is prompted for approval')
    then('the operation proceeds only if approved')

  when('the user denies an approval request')
    then('the operation is not executed')
    then('a denial result is returned to the brain')
    then('the brain can proceed with an alternative approach')
```

**verification:**
- [ ] `npm run test:unit -- promptForWrites` passes
- [ ] read operations return 'allow'
- [ ] write operations return 'prompt'

---

### step 3.8: denyDangerous permission guard

**depends on:** step 3.7

**deliverables:**
- [ ] `src/domain.operations/brain.replic.arch1/plugins/permissionGuards/denyDangerous.ts`
- [ ] `src/domain.operations/brain.replic.arch1/plugins/permissionGuards/denyDangerous.test.ts`

**acceptance criteria:**
```
given('a bhrain with a permission configuration')
  when('the brain attempts a blocked operation')
    then('the operation is rejected')
    then('the brain receives a rejection result')
    then('the brain can reason about the rejection and adjust')

given('the permission guard returns "deny"')
  then('the tool is not executed')
  then('a denial result is returned to the brain')
```

**verification:**
- [ ] `npm run test:unit -- denyDangerous` passes
- [ ] dangerous patterns return 'deny'
- [ ] denial includes reason

---

## phase 4: rhachet integration

### step 4.1: role definition

**depends on:** step 2.5

**deliverables:**
- [ ] `src/roles/bhrain/getBhrainRole.ts`
- [ ] `src/roles/bhrain/briefs/` (directory)

**acceptance criteria:**
```
given('rhachet is installed')
  then('bhrain role is registered')
  then('role has slug, name, purpose, skills')
```

**verification:**
- [ ] `npm run test:types` passes
- [ ] role builds without error
- [ ] role exports correctly

---

### step 4.2: skill definition

**depends on:** step 4.1

**deliverables:**
- [ ] `src/roles/bhrain/skills/act/skillAct.ts`
- [ ] `src/roles/bhrain/skills/act/stepAct.ts`

**acceptance criteria:**
```
given('rhachet is installed')
  when('invoked with: npx rhachet run --repo bhrain --skill act --arch bhrain.struct.v1 --atom qwen --input "..."')
    then('the bhrain is instantiated with specified config')
    then('the input is passed to the brain')
    then('the brain executes its agentic loop')
    then('the result is printed to stdout')

  when('invoked without required arguments')
    then('a helpful error message is shown')
    then('the process exits with non-zero code')

  when('invoked with an unknown atom')
    then('an error is returned')
    then('available atoms are listed')
```

**verification:**
- [ ] `npm run test:types` passes
- [ ] skill defines threads lookup correctly
- [ ] skill defines context lookup correctly

---

### step 4.3: registry integration

**depends on:** step 4.2

**deliverables:**
- [ ] update `src/roles/getRoleRegistry.ts`
- [ ] update `rhachet.use.ts`

**acceptance criteria:**
```
given('rhachet is installed')
  then('bhrain role is discoverable via registry')
  then('act skill is invocable via cli')
```

**verification:**
- [ ] `npm run test:types` passes
- [ ] role appears in registry

---

### step 4.4: acceptance tests

**depends on:** step 4.3

**deliverables:**
- [ ] `src/roles/bhrain/skills/act/skillAct.acceptance.test.ts`

**acceptance criteria:**
```
given('rhachet is installed')
  when('invoked with: npx rhachet run --repo bhrain --skill act ...')
    then('the brain executes its agentic loop')
    then('the result is printed to stdout')
```

**verification:**
- [ ] `npm run test:acceptance -- skillAct` passes
- [ ] cli invocation works end-to-end
- [ ] output is printed to stdout

---

## milestone gates

### gate: mvp complete

**requires:**
- [ ] step 0.1 through 0.5 (all domain objects)
- [ ] step 1.1 (anthropic sdk)
- [ ] step 2.1 through 2.5 (all core operations)
- [ ] step 3.1 (allowAll permission guard)
- [ ] step 3.2 (files toolbox)

**verification:**
```sh
npm run test:types
npm run test:unit
npm run test:integration -- invokeBhrain
```

**acceptance:**
- brain invokes with anthropic atom
- brain uses files toolbox
- loop completes naturally

---

### gate: v1.0 complete

**requires:**
- [ ] all mvp steps
- [ ] step 1.2, 1.3 (openai, qwen sdks)
- [ ] step 3.3 through 3.8 (all plugins)
- [ ] step 4.1 through 4.4 (rhachet integration)

**verification:**
```sh
npm run test:types
npm run test:unit
npm run test:integration
npm run test:acceptance
```

**acceptance:**
- brain works with all atoms (claude, openai, qwen)
- all toolboxes functional (files, bash, websearch)
- memory managers work (truncate, summarize)
- permission guards work (allowAll, promptForWrites, denyDangerous)
- cli invocation works

---

## execution checklist

```
phase 0: foundation
  [ ] 0.1 core literals
  [ ] 0.2 message literals
  [ ] 0.3 plugin interfaces
  [ ] 0.4 session and loop entities
  [ ] 0.5 domain events

phase 1: access layer
  [ ] 1.1 anthropic sdk
  [ ] 1.2 openai sdk (tool support)
  [ ] 1.3 qwen sdk

phase 2: core operations
  [ ] 2.1 llm response generation
  [ ] 2.2 tool execution
  [ ] 2.3 loop iteration
  [ ] 2.4 loop orchestration
  [ ] 2.5 brain invocation

phase 3: plugins
  [ ] 3.1 allowAll permission guard
  [ ] 3.2 files toolbox
  [ ] 3.3 bash toolbox
  [ ] 3.4 truncate memory manager
  [ ] 3.5 summarizeOnLimit memory manager
  [ ] 3.6 websearch toolbox
  [ ] 3.7 promptForWrites permission guard
  [ ] 3.8 denyDangerous permission guard

phase 4: rhachet integration
  [ ] 4.1 role definition
  [ ] 4.2 skill definition
  [ ] 4.3 registry integration
  [ ] 4.4 acceptance tests

gates
  [ ] mvp complete
  [ ] v1.0 complete
```
