# research: test codepath patterns

## overview

this document enumerates the test codepath patterns relevant to the `--refs` feature for the review skill.

---

## pattern.1 = acceptance test structure (bdd) [REUSE]

### what
acceptance tests use `given/when/then` from `test-fns` with `[caseN]` and `[tN]` labels.

### relation to wish
can reuse this structure for new `--refs` acceptance tests.

### citations

[1] `blackbox/review.representative-clean.acceptance.test.ts:11-59`
```typescript
describe('review.acceptance', () => {
  given('[case1] mechanic codebase with clean code', () => {
    when('[t0] review skill on clean.ts with goal=representative', () => {
      const res = useThen('invoke review skill on clean code', async () => {
        // ...
      });

      then('cli completes successfully', async () => {
        expect(res.cli.stderr).not.toContain('Error');
      });

      then('review contains no blockers', async () => {
        expect(res.review.toLowerCase()).not.toContain('blocker');
      });
    });
  });
});
```

---

## pattern.2 = test assets directory structure [EXTEND]

### what
test fixtures organized in `.test/assets/` with subdirectories for rules and source files.

### relation to wish
must add ref fixture files (e.g., criteria docs, style guides) to test assets.

### citations

[2] `blackbox/.test/assets/codebase-mechanic/` (directory structure)
```
codebase-mechanic/
â”œâ”€â”€ rules/
â”‚   â”œâ”€â”€ rule.require.arrow-only.md
â”‚   â””â”€â”€ rule.require.what-why-headers.md
â””â”€â”€ src/
    â”œâ”€â”€ clean.ts
    â””â”€â”€ dirty.ts
```

[3] `src/domain.operations/review/.test/assets/` (directory structure)
```
example.repo/
â”œâ”€â”€ typescript-quality/
â”œâ”€â”€ prose-author/
â””â”€â”€ rules/
```

---

## pattern.3 = invokeReviewSkill helper [EXTEND]

### what
helper function invokes review skill via shell with named parameters.

### relation to wish
must add `refs` parameter to input shape and command construction.

### citations

[4] `blackbox/.test/invokeReviewSkill.ts:16-56`
```typescript
export const invokeReviewSkill = async (input: {
  rules: string;
  paths: string;
  output: string;
  focus: 'push' | 'pull';
  goal: 'exhaustive' | 'representative';
  brain?: string;
  cwd: string;
}): Promise<{ stdout: string; stderr: string }> => {
  const skillPath = path.join(
    input.cwd,
    '.agent/repo=bhrain/role=reviewer/skills/review.sh',
  );
  const cmd = [
    `bash "${skillPath}"`,
    `--rules "${input.rules}"`,
    `--paths "${input.paths}"`,
    `--output "${input.output}"`,
    `--mode ${input.mode}`,
    `--goal ${input.goal}`,
    input.brain ? `--brain "${input.brain}"` : '',
  ]
    .filter(Boolean)
    .join(' ');

  try {
    const result = await execAsync(cmd, {
      cwd: input.cwd,
      env: { ...process.env },
    });
    return result;
  } catch (error) {
    const execError = error as { stdout?: string; stderr?: string };
    return {
      stdout: execError.stdout ?? '',
      stderr: execError.stderr ?? '',
    };
  }
};
```

---

## pattern.4 = useThen for shared async results [REUSE]

### what
`useThen` executes async setup once and shares result across multiple `then` blocks.

### relation to wish
can reuse for new tests that invoke review with refs.

### citations

[5] `blackbox/review.representative-clean.acceptance.test.ts:14-31`
```typescript
const res = useThen('invoke review skill on clean code', async () => {
  // Step 1: Clone fixture to temp dir
  const tempDir = genTempDir({
    slug: 'review-rep-clean',
    clone: ASSETS_DIR
  });
  const outputPath = path.join(tempDir, 'review-representative-clean.md');

  // Step 2: Link the reviewer role via rhachet
  await execAsync('npx rhachet roles link --role reviewer', { cwd: tempDir });

  // Step 3: Invoke skill
  const cli = await invokeReviewSkill({
    rules: 'rules/*.md',
    paths: 'src/clean.ts',
    output: outputPath,
    focus: 'push',
    goal: 'representative',
    brain: 'xai/grok/code-fast-1',
    cwd: tempDir,
  });

  // Step 4: Read output
  const review = await fs.readFile(outputPath, 'utf-8');
  logOutputHead({ label: 'review-representative-clean.md', output: review });

  return { cli, review };
});
```

---

## pattern.5 = genTempDir with clone [REUSE]

### what
creates isolated temp directory and clones fixture assets into it.

### relation to wish
can reuse for tests that need temp dir with refs fixtures.

### citations

[6] `blackbox/review.representative-clean.acceptance.test.ts:16-17`
```typescript
const tempDir = genTempDir({
  slug: 'review-rep-clean',
  clone: ASSETS_DIR
});
```

---

## pattern.6 = rhachet roles link setup [REUSE]

### what
links reviewer role into temp directory before skill invocation.

### relation to wish
can reuse same setup step for refs tests.

### citations

[7] `blackbox/review.representative-clean.acceptance.test.ts:20`
```typescript
await execAsync('npx rhachet roles link --role reviewer', { cwd: tempDir });
```

---

## pattern.7 = logOutputHead utility [REUSE]

### what
logs first N lines of output for test observability.

### relation to wish
can reuse to log ref content and review output in new tests.

### citations

[8] `src/.test/logOutputHead.ts:1-13`
```typescript
export const logOutputHead = (input: {
  label: string;
  output: string;
  lines?: number;
}): void => {
  const lines = input.lines ?? 30;
  const head = input.output.split('\n').slice(0, lines).join('\n');
  console.log(`\nðŸ“‹ ${input.label} (head ${lines} lines):\n${head}\n`);
};
```

---

## pattern.8 = cli output validation [REUSE]

### what
asserts cli stderr does not contain error strings.

### relation to wish
can reuse for refs error case tests.

### citations

[9] `blackbox/review.representative-clean.acceptance.test.ts:34-36`
```typescript
then('cli completes successfully', async () => {
  expect(res.cli.stderr).not.toContain('Error');
});
```

---

## pattern.9 = review content validation [REUSE]

### what
asserts review output contains or excludes expected strings.

### relation to wish
can reuse to verify refs content appears in review output.

### citations

[10] `blackbox/review.representative-clean.acceptance.test.ts:38-40`
```typescript
then('review contains no blockers', async () => {
  expect(res.review.toLowerCase()).not.toContain('blocker');
});
```

[11] `blackbox/review.representative-dirty.acceptance.test.ts:42-49`
```typescript
then('review detects function keyword violation', async () => {
  const reviewLower = res.review.toLowerCase();
  expect(reviewLower).toContain('blocker');
  expect(
    reviewLower.includes('function') ||
    reviewLower.includes('arrow') ||
    reviewLower.includes('keyword'),
  ).toBe(true);
});
```

---

## pattern.10 = metrics validation [EXTEND]

### what
asserts metrics object contains expected file counts.

### relation to wish
must extend to validate refs count in metrics.

### citations

[12] `src/domain.operations/review/stepReview.caseBrain.grok-code-fast-1.case1.integration.test.ts:62-65`
```typescript
then('metrics.files shows correct counts', async () => {
  expect(result.metrics.files.rulesCount).toBe(2);
  expect(result.metrics.files.targetsCount).toBe(1);
});
```

---

## pattern.11 = timeout for brain invocations [REUSE]

### what
sets jest timeout to 3 minutes for tests that invoke brain APIs.

### relation to wish
can reuse same timeout for refs tests with brain invocation.

### citations

[13] `src/domain.operations/review/stepReview.caseBrain.grok-code-fast-1.case1.integration.test.ts:5`
```typescript
jest.setTimeout(180000);
```

---

## pattern.12 = fixture files (clean vs dirty) [EXTEND]

### what
separate fixture files for clean (compliant) and dirty (violates rules) code.

### relation to wish
must add ref fixture files that rules can reference.

### citations

[14] `blackbox/.test/assets/codebase-mechanic/src/clean.ts:1-11`
```typescript
/**
 * .what = calculates the total price for a list of items
 * .why = centralizes price calculation logic for invoices
 */
export const calculateTotal = (input: { items: Array<{ price: number }> }) => {
  // sum all item prices
  const total = input.items.reduce((sum, item) => sum + item.price, 0);
  return total;
};
```

[15] `blackbox/.test/assets/codebase-mechanic/src/dirty.ts:1-8`
```typescript
export function calculateTotal(items: Array<{ price: number }>) {
  // Uses function keyword (violates arrow-only rule)
  let total = 0;
  for (const item of items) {
    total += item.price;
  }
  return total;
}
```

---

## pattern.13 = git repo setup for diff tests [REUSE]

### what
creates temp git repo with commits for diff-based tests.

### relation to wish
can reuse if refs tests need git context.

### citations

[16] `src/domain.operations/review/stepReview.integration.test.ts:41-61`
```typescript
const setupGitRepo = async (): Promise<{ repoDir: string }> => {
  const repoDir = path.join(
    os.tmpdir(),
    `bhrain-review-test-${Date.now()}-${Math.random().toString(36).slice(2)}`,
  );

  // Copy static assets to temp directory
  await fs.cp(ASSETS_TYPESCRIPT, repoDir, { recursive: true });

  // Initialize git repo
  execSync('git init', { cwd: repoDir, stdio: 'pipe' });
  execSync('git add .', { cwd: repoDir, stdio: 'pipe' });
  execSync('git commit -m "initial"', {
    cwd: repoDir,
    stdio: 'pipe',
    env: GIT_ENV,
  });
  execSync('git branch -M main', { cwd: repoDir, stdio: 'pipe' });

  return { repoDir };
};
```

---

## pattern.14 = test file name convention [REUSE]

### what
acceptance tests named `review.[goal]-[state].acceptance.test.ts`.

### relation to wish
can follow same convention for refs tests (e.g., `review.refs-single.acceptance.test.ts`).

### citations

[17] `blackbox/` (file names)
```
review.representative-clean.acceptance.test.ts
review.representative-dirty.acceptance.test.ts
review.exhaustive-dirty.acceptance.test.ts
```

---

## pattern.15 = error capture with getError [REUSE]

### what
`getError` from `test-fns` captures thrown errors for assertion.

### relation to wish
can reuse for tests that verify error cases (invalid refs, zero matches).

### citations

[18] `src/domain.operations/review/compileReviewPrompt.test.ts` (usage pattern)
```typescript
then('throws BadRequestError', async () => {
  const error = await getError(async () =>
    compileReviewPrompt({ ...input, focus: 'push' })
  );
  expect(error).toBeInstanceOf(BadRequestError);
  expect(error.message).toContain('exceeds 75%');
});
```

---

## summary

| pattern | action | reason |
|---------|--------|--------|
| pattern.1 acceptance test structure | REUSE | same bdd pattern |
| pattern.2 test assets directory | EXTEND | add ref fixtures |
| pattern.3 invokeReviewSkill helper | EXTEND | add refs parameter |
| pattern.4 useThen for shared results | REUSE | same pattern |
| pattern.5 genTempDir with clone | REUSE | same pattern |
| pattern.6 rhachet roles link setup | REUSE | same setup |
| pattern.7 logOutputHead utility | REUSE | same utility |
| pattern.8 cli output validation | REUSE | same assertions |
| pattern.9 review content validation | REUSE | same assertions |
| pattern.10 metrics validation | EXTEND | add refs count |
| pattern.11 timeout for brain | REUSE | same timeout |
| pattern.12 fixture files | EXTEND | add ref fixtures |
| pattern.13 git repo setup | REUSE | if needed |
| pattern.14 test file name convention | REUSE | same convention |
| pattern.15 error capture | REUSE | for error cases |
