# roadmap: review output devexp

## phase 0: foundation â€” pure leaf operations

**prereqs:** read `.agent/repo=ehmpathy/role=mechanic/briefs/` for code patterns

### 0.1 sanitizeBranchName

- [ ] create `src/domain.operations/review/sanitizeBranchName.ts`
  - pure function, no dependencies
  - converts branch names to filesystem-safe strings
  - replaces `/` with `.` (preserves hierarchy readability)
  - replaces other special chars with `-`
  - collapses consecutive special chars, trims start/end

- [ ] create `src/domain.operations/review/sanitizeBranchName.test.ts`
  - case: `"main"` â†’ `"main"`
  - case: `"feat/my-feature"` â†’ `"feat.my-feature"`
  - case: `"user/john/task-123"` â†’ `"user.john.task-123"`
  - case: `"feat/my@feature#1"` â†’ `"feat.my-feature-1"`

**verify:** `npm run test:unit -- sanitizeBranchName`

---

## phase 1: default path generation

**prereqs:** phase 0 complete

### 1.1 genDefaultReviewOutputPath

- [ ] create `src/domain.operations/review/genDefaultReviewOutputPath.ts`
  - async function (needs git command)
  - gets current branch via `git rev-parse --abbrev-ref HEAD`
  - sanitizes branch via `sanitizeBranchName`
  - generates filesystem-safe ISO timestamp
  - returns `.review/${branchSafe}/${isotime}.output.md`

- [ ] create `src/domain.operations/review/genDefaultReviewOutputPath.integration.test.ts`
  - verify path starts with `.review/`
  - verify path ends with `.output.md`
  - verify branch segment is sanitized
  - verify timestamp format is filesystem-safe

**verify:** `npm run test:integration -- genDefaultReviewOutputPath`

---

## phase 2: stepReview mkdir behavior

**prereqs:** none (independent of phases 0-1)

### 2.1 update stepReview output parent validation

- [ ] update `src/domain.operations/review/stepReview.ts`
  - locate output parent validation block (lines 180-191)
  - replace `throw BadRequestError` with `fs.mkdir({ recursive: true })`
  - remove the try/catch around `fs.access`

**before:**
```ts
try {
  await fs.access(outputParentAbsolute);
} catch {
  throw new BadRequestError('output path parent directory does not exist', {
    outputParent: outputParentAbsolute,
  });
}
```

**after:**
```ts
await fs.mkdir(outputParentAbsolute, { recursive: true });
```

### 2.2 add stepReview mkdir integration test

- [ ] add test case to `src/domain.operations/review/stepReview.integration.test.ts`
  - given: output path with absent parent directory
  - when: stepReview is invoked
  - then: parent directories are created
  - then: review is written to specified path

**verify:** `npm run test:integration -- stepReview`

---

## phase 3: CLI integration

**prereqs:** phases 0, 1, 2 complete

### 3.1 update review CLI entrypoint

- [ ] update `src/contract/cli/review.ts`
  - import `genDefaultReviewOutputPath`
  - update `parseArgs` return type: `output: string | undefined`
  - remove "error: --output is required" validation block
  - add default path resolution before stepReview call:
    ```ts
    const outputResolved = options.output ?? await genDefaultReviewOutputPath({ cwd: process.cwd() });
    if (!options.output) {
      console.log(`ðŸ“„ output: ${outputResolved}`);
    }
    ```
  - pass `outputResolved` to stepReview

- [ ] update help text in `printHelp`
  - change `--output <path>     output file path for the review (required)`
  - to `--output <path>     output file path (default: .review/$branch/$isotime.output.md)`

**verify:** `npm run build && bash dist/domain.roles/reviewer/skills/review.sh --help`

---

## phase 4: acceptance tests

**prereqs:** phases 0-3 complete, read `.behavior/v2026_02_03.review-output-devexp/2.1.criteria.blackbox.md`

### 4.1 acceptance test: default output path

- [ ] create `blackbox/review.output-default.acceptance.test.ts`
  - given: mechanic codebase fixture
  - when: review skill invoked without --output flag
  - then: cli completes successfully (exit code 0)
  - then: review file exists at `.review/$branch/$isotime.output.md`
  - then: stdout contains the output path

### 4.2 acceptance test: mkdir on absent parent

- [ ] create `blackbox/review.output-mkdir.acceptance.test.ts`
  - given: mechanic codebase fixture
  - when: review skill invoked with --output to absent parent dir
  - then: cli completes successfully (exit code 0)
  - then: parent directory is created
  - then: review file exists at specified path

**verify:** `npm run test:acceptance:locally -- review.output`

---

## phase 5: verification & cleanup

### 5.1 full test suite

- [ ] `npm run test:types`
- [ ] `npm run test:lint`
- [ ] `npm run test:unit`
- [ ] `npm run test:integration`
- [ ] `npm run test:acceptance:locally`

### 5.2 manual smoke test

- [ ] invoke review without --output, verify default path works
  ```sh
  npx rhachet run --skill review --rules ".agent/**/briefs/*.md" --paths "src/contract/cli/review.ts"
  ```
- [ ] verify review file created at `.review/$branch/$isotime.output.md`
- [ ] invoke review with --output to absent dir, verify mkdir works
  ```sh
  npx rhachet run --skill review --rules ".agent/**/briefs/*.md" --paths "src/contract/cli/review.ts" --output ".reviews/test/v1.md"
  ```
- [ ] verify `.reviews/test/v1.md` created

### 5.3 cleanup

- [ ] remove any temporary test files created in smoke test
- [ ] ensure `.review/` and `.reviews/` are in `.gitignore`

---

## dependency graph

```
phase 0: sanitizeBranchName (pure leaf)
    â”‚
    â–¼
phase 1: genDefaultReviewOutputPath (depends on phase 0)
    â”‚
    â”‚   phase 2: stepReview mkdir (independent)
    â”‚       â”‚
    â–¼       â–¼
phase 3: CLI integration (depends on phases 0, 1, 2)
    â”‚
    â–¼
phase 4: acceptance tests (depends on phase 3)
    â”‚
    â–¼
phase 5: verification & cleanup
```

## acceptance criteria checklist

from `.behavior/v2026_02_03.review-output-devexp/2.1.criteria.blackbox.md`:

- [ ] usecase.1: default output path when --output is omitted
  - [ ] review succeeds without error
  - [ ] review written to `.review/$branch/$isotime.output.md`
  - [ ] output path printed to stdout
  - [ ] `.review/` directory created if absent

- [ ] usecase.2: explicit output path with absent parent directory
  - [ ] parent directory created automatically
  - [ ] review written to specified path
  - [ ] nested paths work (recursive mkdir)

- [ ] usecase.3: explicit output path with present parent directory
  - [ ] no error thrown
  - [ ] review written to specified path

- [ ] usecase.4: default output path format
  - [ ] branch segment reflects current branch
  - [ ] slashes become dots (e.g., `feat/my-feature` â†’ `feat.my-feature`)
  - [ ] other special chars become dashes
  - [ ] isotime is filesystem-safe
