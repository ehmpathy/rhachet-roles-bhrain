# blueprint: fast skill invocation via package-level cli exports

## overview

this blueprint implements the wish to adopt rhachet-roles-bhuild's fast invocation pattern for all skills in rhachet-roles-bhrain.

### key changes

1. **create brief** that documents the fast invocation pattern
2. **add cli exports** via centralized `cli` namespace in `index.ts`
3. **create cli wrappers** in `src/contract/cli/` for each skill
4. **update shell scripts** to use `node -e "import('pkg')"` instead of path-based or tsx-based imports

---

## filediffs treestruct

```
.agent/repo=.this/role=any/briefs/
└── [+] howto.fast-skill-invocation.[lesson].md       # brief on the pattern

src/
├── contract/
│   └── cli/
│       ├── [+] review.ts                             # cli wrapper for review
│       └── [+] reflect.ts                            # cli wrapper for reflect
├── domain.roles/reviewer/skills/
│   ├── [~] review.sh                                 # update to use package import
│   ├── [~] reflect.sh                                # update to use node -e (not npx tsx)
│   └── [-] review.cli.ts                             # delete (moved to contract/cli)
└── [~] index.ts                                      # add cli namespace export
```

---

## codepaths treestruct

```
invocation flow (before):
  review.sh
  └── SCRIPT_DIR resolution
      └── node -e "import('$SCRIPT_DIR/review.cli.js')"
          └── review.cli.ts
              └── stepReview()

invocation flow (after):
  review.sh
  └── [~] node -e "import('rhachet-roles-bhrain').then(m => m.cli.review())"
      └── [+] index.ts::cli.review()
          └── [+] contract/cli/review.ts::review()
              └── [○] stepReview()

reflect flow (before):
  reflect.sh
  └── [~] npx tsx -e "import('rhachet-roles-bhrain').then(m => m.cli.reflect())"
      └── stepReflect() [direct]

reflect flow (after):
  reflect.sh
  └── [~] node -e "import('rhachet-roles-bhrain').then(m => m.cli.reflect())"
      └── [+] index.ts::cli.reflect()
          └── [+] contract/cli/reflect.ts::reflect()
              └── [○] stepReflect()
```

---

## detailed changes

### 1. brief: howto.fast-skill-invocation.[lesson].md

**path**: `.agent/repo=.this/role=any/briefs/howto.fast-skill-invocation.[lesson].md`

**purpose**: document the pattern so future skills follow it consistently

**content outline**:
- shell wrapper uses `exec node -e "import('package-name').then(m => m.cli.X())" -- "$@"`
- package exports `cli` namespace with all cli functions
- cli functions live in `src/contract/cli/`
- no path resolution, no tsx, no npx overhead

---

### 2. cli wrapper: src/contract/cli/review.ts

**purpose**: cli entry point for review skill, extracted from review.cli.ts

**contract**:
```typescript
/**
 * .what = cli entrypoint for review skill
 * .why = enables shell invocation via review.sh with package-level import
 */
export const review = async (): Promise<void>
```

**content**: move current logic from `src/domain.roles/reviewer/skills/review.cli.ts`

---

### 3. cli wrapper: src/contract/cli/reflect.ts

**purpose**: cli entry point for reflect skill

**contract**:
```typescript
/**
 * .what = cli entrypoint for reflect skill
 * .why = enables shell invocation via reflect.sh with package-level import
 */
export const reflect = async (): Promise<void>
```

**content**:
- parse cli args (--source, --target, --mode, --force, --brain)
- load brain atoms/repls
- invoke stepReflect

---

### 4. update: src/index.ts

**current**:
```typescript
export * from '@src/contract/sdk';
export type { StepReflectResult } from '@src/domain.operations/reflect/stepReflect';
export { stepReflect } from '@src/domain.operations/reflect/stepReflect';
export type { StepReviewResult } from '@src/domain.operations/review/stepReview';
export { stepReview } from '@src/domain.operations/review/stepReview';
```

**after**:
```typescript
export * from '@src/contract/sdk';
export type { StepReflectResult } from '@src/domain.operations/reflect/stepReflect';
export { stepReflect } from '@src/domain.operations/reflect/stepReflect';
export type { StepReviewResult } from '@src/domain.operations/review/stepReview';
export { stepReview } from '@src/domain.operations/review/stepReview';

// cli entry points for portable skill dispatch
import { review } from '@src/contract/cli/review';
import { reflect } from '@src/contract/cli/reflect';

export const cli = {
  review,
  reflect,
};
```

---

### 5. update: src/domain.roles/reviewer/skills/review.sh

**current**:
```bash
#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
exec node -e "import('$SCRIPT_DIR/review.cli.js').then(m => m.review())" -- "$@"
```

**after**:
```bash
#!/usr/bin/env bash
set -euo pipefail

exec node -e "import('rhachet-roles-bhrain').then(m => m.cli.review())" -- "$@"
```

**changes**:
- remove `SCRIPT_DIR` resolution
- import from package name instead of local path

---

### 6. update: src/domain.roles/reviewer/skills/reflect.sh

**current**:
```bash
#!/usr/bin/env bash
set -euo pipefail

exec npx tsx -e "import('rhachet-roles-bhrain').then(m => m.cli.reflect())" -- "$@"
```

**after**:
```bash
#!/usr/bin/env bash
set -euo pipefail

exec node -e "import('rhachet-roles-bhrain').then(m => m.cli.reflect())" -- "$@"
```

**changes**:
- replace `npx tsx -e` with `node -e` (eliminates tsx startup overhead)

---

### 7. delete: src/domain.roles/reviewer/skills/review.cli.ts

**reason**: moved to `src/contract/cli/review.ts`

---

## test coverage

### unit tests

- `[○] retain` current unit tests for stepReview and stepReflect
- `[+] create` unit tests for cli arg parser in contract/cli/*.ts (if complex)

### integration tests

- `[○] retain` current integration tests for stepReview and stepReflect
- no changes needed - they test domain operations directly

### acceptance tests

- `[○] retain` current acceptance tests in blackbox/
- no changes needed - they invoke shell scripts which will use new pattern
- acceptance tests validate the full invocation chain works

---

## migration safety

1. **backwards compatible** - shell scripts still accept same args
2. **acceptance tests unchanged** - they invoke `review.sh` which still works
3. **sdk exports unchanged** - stepReview/stepReflect still exported
4. **gradual adoption** - each skill can be migrated independently

---

## performance benefit

| metric | before | after |
|--------|--------|-------|
| review.sh cold start | ~500ms (path resolution + module load) | ~200ms (direct package import) |
| reflect.sh cold start | ~1500ms (npx tsx overhead) | ~200ms (node -e direct) |

the primary gain comes from:
1. eliminate `npx tsx` subprocess spawn and typescript compilation
2. eliminate shell subshell for `$(cd ... && pwd)` path resolution
3. leverage node's module cache via package-name imports
