# roadmap: --refs for review skill

## overview

checklist-style roadmap for implementation of `--refs` support in the review skill.

each phase has:
- ordered dependencies (what must be done before)
- briefs to read before start
- behavioral acceptance criteria
- verification steps

---

## phase.0: infra — repeated flags

### dependencies
- none (first phase)

### briefs to read
- `.behavior/v2026_01_27.review-refs/3.1.research.patterns._.code.prod.v1.i1.md` — pattern.2 (cli argument parser)

### checklist

- [ ] extend `src/infra/cli/getCliArgs.ts`
  - [ ] accumulate repeated flags into arrays (e.g., `--refs x --refs y` → `['x', 'y']`)
  - [ ] preserve backwards compat for single-value flags

### acceptance criteria

```
given('--refs specified once')
  when('getCliArgs parses the args')
    then('refs is a string')

given('--refs specified multiple times')
  when('getCliArgs parses the args')
    then('refs is an array of strings')

given('--rules specified multiple times')
  when('getCliArgs parses the args')
    then('rules is an array of strings')
      sothat('pattern is consistent across all file args')
```

### verification

```sh
npm run test:types
npm run test:unit -- getCliArgs
```

---

## phase.1: contract — cli schema

### dependencies
- phase.0 (repeated flags must work first)

### briefs to read
- `.behavior/v2026_01_27.review-refs/3.1.research.patterns._.code.prod.v1.i1.md` — pattern.1 (cli argument schema)
- `.behavior/v2026_01_27.review-refs/3.3.blueprint.v1.i1.md` — contracts section

### checklist

- [ ] extend `src/contract/cli/review.ts`
  - [ ] add `refs: z.union([z.string(), z.array(z.string())]).optional()` to schema
  - [ ] pass `refs` to stepReview call

### acceptance criteria

```
given('--refs passed to cli')
  when('schema validates args')
    then('refs field is present in parsed args')

given('--refs not passed to cli')
  when('schema validates args')
    then('refs field is undefined')
      sothat('backwards compat is preserved')
```

### verification

```sh
npm run test:types
npm run build
```

---

## phase.2: prompt — refs section

### dependencies
- none (can be done in parallel with phase.0 and phase.1)

### briefs to read
- `.behavior/v2026_01_27.review-refs/3.1.research.patterns._.code.prod.v1.i1.md` — pattern.6 (prompt compilation structure), pattern.9 (compileReviewPrompt input shape)
- `.behavior/v2026_01_27.review-refs/3.3.blueprint.v1.i1.md` — prompt template extension section

### checklist

- [ ] extend `src/domain.operations/review/compileReviewPrompt.ts`
  - [ ] add `refs: Array<{ path: string; content: string }>` to input (required, empty array when no refs)
  - [ ] build `<refs>` section from refs array
  - [ ] inject refs section into prompt template (between rules and target)
  - [ ] add instruction #6 about refs in CRITICAL INSTRUCTIONS
  - [ ] include refs in token estimation

- [ ] create `src/domain.operations/review/compileReviewPrompt.test.ts`
  - [ ] test refs section generation with refs
  - [ ] test empty refs array produces no refs section
  - [ ] test token estimation includes refs content

### acceptance criteria

```
given('refs array with 2 files')
  when('compileReviewPrompt is called')
    then('prompt contains <refs> section')
    then('refs section contains both file paths and contents')
    then('token estimate includes refs content')

given('refs array is empty')
  when('compileReviewPrompt is called')
    then('prompt does not contain <refs> section')
      sothat('backwards compat is preserved')
```

### verification

```sh
npm run test:types
npm run test:unit -- compileReviewPrompt
```

---

## phase.3: stepReview — enumeration and metrics

### dependencies
- phase.1 (cli must pass refs to stepReview)
- phase.2 (compileReviewPrompt must accept refs)

### briefs to read
- `.behavior/v2026_01_27.review-refs/3.1.research.patterns._.code.prod.v1.i1.md` — pattern.3 (glob resolution), pattern.5 (file enumeration), pattern.7 (metrics display), pattern.10 (error messages)
- `.behavior/v2026_01_27.review-refs/3.3.blueprint.v1.i1.md` — error handle section

### checklist

- [ ] extend `src/domain.operations/review/stepReview.ts`
  - [ ] add `refs?: string | string[]` to input type
  - [ ] enumerate ref files via `enumFilesFromGlob()` (reuse pattern)
  - [ ] validate refs exist — fail-fast on zero matches
    - [ ] if explicit path: show "ref not found" with suggestions
    - [ ] if glob: show "no refs matched glob" with hint
  - [ ] read ref file contents
  - [ ] pass refs array to `compileReviewPrompt()`
  - [ ] display refs count in metrics.expected.files tree
  - [ ] include refs in input.scope.json artifact

### acceptance criteria

```
given('--refs set to a single file that exists')
  when('stepReview is called')
    then('ref file is enumerated')
    then('ref content is passed to compileReviewPrompt')
    then('metrics.expected.files.refs shows 1')

given('--refs set to a glob that matches 3 files')
  when('stepReview is called')
    then('all 3 ref files are enumerated')
    then('metrics.expected.files.refs shows 3')

given('--refs set to a non-existent file')
  when('stepReview is called')
    then('BadRequestError is thrown')
    then('error message contains "ref not found"')

given('--refs set to a glob that matches zero files')
  when('stepReview is called')
    then('BadRequestError is thrown')
    then('error message contains "no refs matched glob"')

given('--refs not provided')
  when('stepReview is called')
    then('refs array is empty')
    then('metrics.expected.files does not show refs line')
      sothat('backwards compat is preserved')
```

### verification

```sh
npm run test:types
npm run test:integration -- stepReview
```

---

## phase.4: tests — fixtures and acceptance

### dependencies
- phase.3 (all prod code must be complete)

### briefs to read
- `.behavior/v2026_01_27.review-refs/2.criteria.blackbox.md` — all 8 usecases
- `.behavior/v2026_01_27.review-refs/1.vision.md` — expected cli output format
- `.behavior/v2026_01_27.review-refs/3.1.research.patterns._.code.test.v1.i1.md` — all test patterns

### checklist

- [ ] create test fixtures
  - [ ] `blackbox/.test/assets/codebase-mechanic/behavior/getWeather/criteria.blackbox.md`
  - [ ] `blackbox/.test/assets/codebase-mechanic/behavior/getWeather/criteria.blueprint.md`

- [ ] extend `blackbox/.test/invokeReviewSkill.ts`
  - [ ] add `refs?: string` to input type
  - [ ] add `--refs` to command construction

- [ ] create `blackbox/review.refs-single.acceptance.test.ts`
  - [ ] usecase.1: single ref file
  - [ ] usecase.3: ref content accessible to rules

- [ ] create `blackbox/review.refs-glob.acceptance.test.ts`
  - [ ] usecase.2: glob pattern refs
  - [ ] usecase.7: multiple --refs via repeated flags

- [ ] create `blackbox/review.refs-error.acceptance.test.ts`
  - [ ] usecase.5: invalid ref path
  - [ ] usecase.6: glob matches zero files

- [ ] verify usecase.4 (backwards compat)
  - [ ] confirm prior acceptance tests still pass without --refs

- [ ] verify usecase.8 (repeated flags for --rules and --paths)
  - [ ] confirm repeated --rules works
  - [ ] confirm repeated --paths works

### acceptance criteria

```
given('all acceptance tests')
  when('npm run test:acceptance:locally is run')
    then('all tests pass')
      sothat('all 8 usecases are verified')
```

### verification

```sh
npm run test:acceptance:locally
```

---

## phase.5: validation — full suite

### dependencies
- phase.4 (all tests must be written)

### briefs to read
- `.behavior/v2026_01_27.review-refs/2.criteria.blackbox.md` — verify all usecases covered
- `.behavior/v2026_01_27.review-refs/1.vision.md` — verify output matches vision

### checklist

- [ ] run full test suite
  - [ ] `npm run test:types`
  - [ ] `npm run test:lint`
  - [ ] `npm run test:unit`
  - [ ] `npm run test:integration`
  - [ ] `npm run test:acceptance:locally`

- [ ] verify all usecases covered
  - [ ] usecase.1: single ref file ✓
  - [ ] usecase.2: glob pattern refs ✓
  - [ ] usecase.3: ref content accessible ✓
  - [ ] usecase.4: backwards compat ✓
  - [ ] usecase.5: invalid ref path error ✓
  - [ ] usecase.6: glob zero matches error ✓
  - [ ] usecase.7: multiple --refs ✓
  - [ ] usecase.8: repeated flags for --rules/--paths ✓

- [ ] manual smoke test
  - [ ] run review with single --refs
  - [ ] run review with glob --refs
  - [ ] run review without --refs
  - [ ] verify metrics output matches vision

### acceptance criteria

```
given('all phases complete')
  when('full test suite runs')
    then('all tests pass')
    then('all 8 usecases verified')
    then('output matches vision episodes')
```

### verification

```sh
npm run test
```

---

## summary

| phase | description | depends on | key files |
|-------|-------------|------------|-----------|
| 0 | infra: repeated flags | — | getCliArgs.ts |
| 1 | contract: cli schema | 0 | review.ts |
| 2 | prompt: refs section | — | compileReviewPrompt.ts |
| 3 | stepReview: enumeration | 1, 2 | stepReview.ts |
| 4 | tests: fixtures + acceptance | 3 | blackbox/*.acceptance.test.ts |
| 5 | validation: full suite | 4 | — |

phases 0, 1, 2 can be done in parallel (2 has no dependencies).
phase 3 requires 1 and 2.
phases 4 and 5 are sequential after 3.

