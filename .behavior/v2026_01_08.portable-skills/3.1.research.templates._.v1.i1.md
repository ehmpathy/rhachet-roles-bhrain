# research.templates for portable-skills

template analysis from [PR #27: rhachet-roles-bhuild](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files) and the rhachet-roles-bhuild repo

---

## template overview

### files added/modified in PR #27

| file | purpose | lines |
|------|---------|-------|
| `.agent/repo=.this/role=any/briefs/portable-skills-pattern.md` | pattern documentation | +135 |
| `.claude/settings.json` | hook configuration (direct file paths) | +17/-17 |
| `.github/workflows/.test.yml` | workflow (build before integration) | +5 |
| `blackbox/.test/infra/genConsumerRepo.ts` | test infra: consumer repo simulator | +91 |
| `blackbox/.test/infra/runRhachetSkill.ts` | test infra: skill execution wrapper | +66 |
| `blackbox/.test/infra/runRolesInit.ts` | test infra: roles init wrapper | +53 |
| `blackbox/.test/infra/genTestGitRepo.ts` | test infra: git repo factory | +52 |
| `blackbox/.test/infra/genBehaviorFixture.ts` | test infra: behavior artifact factory | +49 |
| `blackbox/.test/infra/index.ts` | test infra: barrel export | +5 |
| `.gitignore` | ignore backup files | +2 |

### real implementation templates (from repo main branch)

| file | purpose | key pattern |
|------|---------|-------------|
| `src/contract/cli/bind.behavior.ts` | CLI entry point | zod schema, getCliArgs, rhachet passthrough args |
| `src/domain.roles/behaver/skills/bind.behavior.sh` | shell dispatcher | `exec npx tsx -e "import(...)"` one-liner |
| `src/index.ts` | package exports | `export const cli = { ... }` namespace |
| `src/infra/cli/getCliArgs.ts` | arg parse utility | argv detection, zod validation, rhachet arg support |

---

## pattern 1: isomorphic shell dispatch

### template code

```bash
#!/usr/bin/env bash
set -euo pipefail
exec npx tsx -e "import('rhachet-roles-bhuild').then(m => m.cli.mySkill())" -- "$@"
```
— [PR #27: portable-skills-pattern.md, lines 22-25](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

### real example: bind.behavior.sh

```bash
#!/usr/bin/env bash
######################################################################
# .what = bind, unbind, or query branch-to-behavior bound
# .how  = thin dispatcher to TypeScript implementation
######################################################################

set -euo pipefail

exec npx tsx -e "import('rhachet-roles-bhuild').then(m => m.cli.bindBehavior())" -- "$@"
```
— [src/domain.roles/behaver/skills/bind.behavior.sh](https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/src/domain.roles/behaver/skills/bind.behavior.sh)

### key elements

1. **shebang**: `#!/usr/bin/env bash` for cross-platform compatibility
2. **strict mode**: `set -euo pipefail` for fail-fast behavior
3. **exec**: replaces shell process with target (no subprocess overhead)
4. **npx tsx**: executes typescript inline without compilation step
5. **dynamic import**: `import('package-name')` uses node module resolution
6. **arg passthrough**: `-- "$@"` forwards all args to the cli

### relation to wish

> "replicate the changes made in those diffs onto this repo... leverage the lessons learned there for how to make skills more portable"
> — [0.wish.md](../../0.wish.md)

this pattern directly addresses portability by location-independent package imports.

---

## pattern 2: devDependencies self-reference

### template code

```json
{
  "devDependencies": {
    "rhachet-roles-bhuild": "file:."
  }
}
```
— [PR #27: portable-skills-pattern.md, lines 40-44](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

### rationale from template

> "the self-reference belongs in `devDependencies` because:
> - only needed at development time (for the import to resolve to repo root)
> - at runtime (when consumed as npm dependency), standard node_modules resolution works
> - not a runtime dependency of the package itself"
> — [PR #27: portable-skills-pattern.md, lines 36-39](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

### resolution contexts

| context | how resolution works |
|---------|---------------------|
| **local development** | `devDependencies` self-reference (`"rhachet-roles-bhuild": "file:."`) makes the package resolvable to repo root |
| **published / consumed** | standard node_modules resolution finds the installed package |

— [PR #27: portable-skills-pattern.md, lines 29-32](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

---

## pattern 3: cli entry point structure

### real example: src/contract/cli/bind.behavior.ts

```typescript
/**
 * .what = bind, unbind, or query branch-to-behavior bound
 *
 * .why  = explicit user control over which behavior applies to current branch
 */

import { basename } from 'path';
import { z } from 'zod';

import { getBehaviorDir } from '@src/domain.operations/behavior';
import {
  delBranchBehaviorBind,
  getBranchBehaviorBind,
  getCurrentBranch,
  setBranchBehaviorBind,
} from '@src/domain.operations/behavior/bind';
import { getCliArgs } from '@src/infra/cli';

// ────────────────────────────────────────────────────────────────────
// schema
// ────────────────────────────────────────────────────────────────────

const schemaOfArgs = z.object({
  named: z.object({
    // skill-specific args
    behavior: z.string().optional(),
    dir: z.string().optional(),
    // rhachet passthrough args (optional, ignored)
    repo: z.string().optional(),
    role: z.string().optional(),
    skill: z.string().optional(),
    s: z.string().optional(),
  }),
  ordered: z.array(z.string()).default([]),
});

// ────────────────────────────────────────────────────────────────────
// exported CLI entry point
// ────────────────────────────────────────────────────────────────────

export const bindBehavior = (): void => {
  const { named, ordered } = getCliArgs({ schema: schemaOfArgs });

  // action is first ordered arg
  const action = ordered[0];
  const cwd = named.dir ?? process.cwd();

  // ... dispatch logic for set|get|del actions
};
```
— [src/contract/cli/bind.behavior.ts](https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/src/contract/cli/bind.behavior.ts)

### arg parse features from template

> "arg parse via `getCliArgs({ schema: schemaOfArgs })` provides:
> - automatic rhachet arg strip (`--repo`, `--role`, `--skill`, `-s`, `--`)
> - Zod validation with typed output
> - schema must follow `{ named, ordered }` shape:
>   - `named`: object with --flag and --key value args
>   - `ordered`: array of positional args
> - error messages on invalid args"
> — [PR #27: portable-skills-pattern.md, lines 78-84](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

### key schema requirement

rhachet passthrough args **must** be declared as optional in the schema:

```typescript
const schemaOfArgs = z.object({
  named: z.object({
    // ... skill-specific args
    // rhachet passthrough args (optional, ignored)
    repo: z.string().optional(),
    role: z.string().optional(),
    skill: z.string().optional(),
    s: z.string().optional(),
  }),
  ordered: z.array(z.string()).default([]),
});
```

---

## pattern 4: src/index.ts export structure

### real example: src/index.ts

```typescript
export * from './contract/sdk';

// CLI entry points for portable skill dispatch
import { bindBehavior } from './contract/cli/bind.behavior';
import { bootBehavior } from './contract/cli/boot.behavior';
import { decomposeBehavior } from './contract/cli/decompose.behavior';
import { initBehavior } from './contract/cli/init.behavior';
import { reviewBehavior } from './contract/cli/review.behavior';

export const cli = {
  bindBehavior,
  bootBehavior,
  decomposeBehavior,
  initBehavior,
  reviewBehavior,
};
```
— [src/index.ts](https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/src/index.ts)

### key constraints

- all cli entry points **must** export from `src/index.ts` under `cli.*` namespace
- each skill shell script references its entry point as `m.cli.<skillName>()`

---

## pattern 5: getCliArgs utility

### real example: src/infra/cli/getCliArgs.ts

```typescript
/**
 * .what = parse and validate CLI args against a Zod schema
 *
 * .why  = provides type-safe arg parse across all CLI entry points
 *         with Zod validation. rhachet args (repo, role, skill, s) should
 *         be declared as optional in the schema so they are parsed and ignored.
 */
export const getCliArgs = <T extends CliSchemaWithRhachetArgs>(input: {
  schema: T;
  argv?: string[];
}): z.infer<T> => {
  // drop script filename from argv if present
  //
  // rhachet skills use `tsx -e "import('pkg').then(m => m.cli.X())"` which
  // has no script filename - argv[1] is already the first user arg.
  //
  // direct invocation like `tsx src/contract/cli/bind.behavior.ts` puts
  // the script path in argv[1], which we need to skip.
  const argvFirstIsScriptFilename = process.argv[1]?.includes('/cli/');
  const argvWithoutScriptFilename = argvFirstIsScriptFilename
    ? process.argv.slice(2)
    : process.argv.slice(1);
  const argv = input.argv ?? argvWithoutScriptFilename;
  const raw = getCliArgsRaw(argv);

  // validate against schema
  const result = input.schema.safeParse(raw);

  if (!result.success) {
    const errors = result.error.issues
      .map((issue) => {
        const path = issue.path.join('.');
        return `  ${path}: ${issue.message}`;
      })
      .join('\n');
    console.error('error: invalid arguments');
    console.error(errors);
    process.exit(1);
  }

  return result.data;
};
```
— [src/infra/cli/getCliArgs.ts](https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/src/infra/cli/getCliArgs.ts)

### key insight: argv detection

the utility detects whether invoked via:
- **package import** (`tsx -e "import('pkg')..."`) — argv[1] is first user arg
- **direct file** (`tsx src/contract/cli/X.ts`) — argv[1] is script path, skip it

---

## pattern 6: directory structure

### template structure

```
src/
├── contract/
│   └── cli/
│       └── my-skill.ts       # CLI entry point
├── domain.operations/
│   └── my-operation/
│       ├── index.ts          # public interface
│       ├── step1.ts          # decomposed operations
│       └── step2.ts
├── domain.roles/
│   └── my-role/
│       └── skills/
│           └── my-skill.sh   # thin dispatcher
└── infra/
    └── cli/
        └── getCliArgs.ts     # arg parse utility
```
— [PR #27: portable-skills-pattern.md, lines 100-113](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

### separation of concerns

- `contract/cli/` — cli entry points (arg parse, invocation)
- `domain.operations/` — complex business logic (testable, composable)
- `domain.roles/*/skills/` — thin shell dispatchers (one-liners)
- `infra/cli/` — shared utilities (arg parse, schema validation)

---

## pattern 7: hook configuration (direct file paths)

### before (cli dispatch)

```json
{
  "type": "command",
  "command": "./node_modules/.bin/rhachet roles init --repo ehmpathy --role mechanic --command claude.hooks/sessionstart.notify-permissions",
  "timeout": 5
}
```
— [PR #27: .claude/settings.json, removed lines](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

### after (direct file path)

```json
{
  "type": "command",
  "command": ".agent/repo=ehmpathy/role=mechanic/inits/claude.hooks/sessionstart.notify-permissions.sh",
  "timeout": 5
}
```
— [PR #27: .claude/settings.json, added lines](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

### key changes

1. hooks now reference files directly in `.agent/` symlinked structure
2. `rhachet roles boot` handles role initialization instead of `roles init --command`
3. order changed: `.this/any` boots first, then `ehmpathy/mechanic`, then notification hook

---

## pattern 8: test infrastructure for portability

### genConsumerRepo.ts — simulates npm consumer

```typescript
/**
 * .what = creates a temporary git repo to simulate a consumer repo
 * .why  = tests portability when package is consumed as a dependency
 *
 * sets up:
 *   - git repo with initial commit
 *   - package.json
 *   - node_modules/rhachet-roles-bhuild (copied from dist)
 *   - rhachet.use.ts that references the package
 */
export const genConsumerRepo = (input?: {
  prefix?: string;
  withClaudeDir?: boolean;
}): ConsumerRepo => {
```
— [PR #27: genConsumerRepo.ts, lines 12-24](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

### key setup steps

```typescript
// add rhachet-roles-bhuild as file dependency that points to current project
packageJson.dependencies = {
  ...packageJson.dependencies,
  'rhachet-roles-bhuild': `file:${process.cwd()}`,
  rhachet: '^1.15.0',
};
```
— [PR #27: genConsumerRepo.ts, lines 54-59](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

```typescript
// create rhachet.use.ts (must exist before roles link)
const rhachetUseContent = `
import type { InvokeHooks, RoleRegistry } from 'rhachet';
import { getRoleRegistry as getRoleRegistryBhuild, getInvokeHooks as getInvokeHooksBhuild } from 'rhachet-roles-bhuild';

export const getRoleRegistries = (): RoleRegistry[] => [getRoleRegistryBhuild()];
export const getInvokeHooks = (): InvokeHooks[] => [getInvokeHooksBhuild()];
`.trim();
```
— [PR #27: genConsumerRepo.ts, lines 70-77](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

### runRhachetSkill.ts — executes skills as consumer would

```typescript
/**
 * .what = runs a rhachet skill via npx rhachet run
 * .why  = tests the full flow as a consumer would use it
 */
export const runRhachetSkill = (input: {
  repo: string;
  role?: string;
  skill: string;
  args?: string;
  repoDir: string;
  timeout?: number;
}): SkillResult => {
```
— [PR #27: runRhachetSkill.ts, lines 12-23](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

---

## pattern 9: workflow changes

### build before integration tests

```yaml
- name: build
  run: npm run build

- name: test:integration
  run: THOROUGH=true npm run test:integration
```
— [PR #27: .test.yml, lines 174-178](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

### rationale

integration tests that run skills need the built `dist/` output so the self-reference resolves correctly.

---

## key constraints (from template)

> "- CLI entry points MUST be exported from `src/index.ts` under `cli.*`
> - CLI entry points MUST handle rhachet passthrough args (`--repo`, `--skill`, `--role`, `--`)
> - package.json MUST have the self-reference in devDependencies for development to work"
> — [PR #27: portable-skills-pattern.md, lines 133-135](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)

---

## relation to wish: map template to this repo

| template component | action for this repo |
|--------------------|---------------------|
| `portable-skills-pattern.md` brief | create in `.agent/repo=.this/role=any/briefs/` |
| `devDependencies` self-reference | add `"rhachet-roles-bhrain": "file:."` to package.json |
| shell dispatch pattern | update skill `.sh` files to use `exec npx tsx -e "import(...)"` |
| `src/contract/cli/` entry points | create cli entry points with zod schemas |
| `src/index.ts` cli exports | ensure exports `cli.*` namespace |
| `src/infra/cli/getCliArgs.ts` | copy/adapt arg parse utility |
| hook configuration | update `.claude/settings.json` to use direct file paths |
| test infrastructure | copy/adapt `blackbox/.test/infra/` utilities |
| workflow build step | add `npm run build` before integration tests |

---

## sources cited

1. [PR #27: portable-skills-pattern.md](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)
2. [src/contract/cli/bind.behavior.ts](https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/src/contract/cli/bind.behavior.ts)
3. [src/domain.roles/behaver/skills/bind.behavior.sh](https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/src/domain.roles/behaver/skills/bind.behavior.sh)
4. [src/index.ts](https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/src/index.ts)
5. [src/infra/cli/getCliArgs.ts](https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/src/infra/cli/getCliArgs.ts)
6. [PR #27: genConsumerRepo.ts](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)
7. [PR #27: runRhachetSkill.ts](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)
8. [PR #27: .claude/settings.json](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)
9. [PR #27: .github/workflows/.test.yml](https://github.com/ehmpathy/rhachet-roles-bhuild/pull/27/files)
