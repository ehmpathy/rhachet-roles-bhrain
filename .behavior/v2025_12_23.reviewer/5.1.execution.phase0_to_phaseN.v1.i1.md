# execution: reviewer role implementation

## status: complete

all phases from the roadmap have been successfully implemented.

---

## phase 0: test assets ✅

- [x] step 0.1: create test asset directories
  - `src/domain.operations/review/.test/assets/example.globs/`
  - `src/domain.operations/review/.test/assets/example.repo/`

- [x] step 0.2: populate example.globs fixtures
  - `foo.ts`, `bar.ts`, `baz.js`
  - `nested/qux.ts`, `nested/quux.js`

- [x] step 0.3: populate example.repo fixtures
  - `src/valid.ts`, `src/invalid.ts`
  - `rules/rule.no-console.md`, `rules/rule.no-any.md`

---

## phase 1: pure transforms ✅

- [x] step 1.1: implement estimateTokenCount
  - `src/domain.operations/review/estimateTokenCount.ts`
  - `src/domain.operations/review/estimateTokenCount.test.ts`

- [x] step 1.2: implement compileReviewPrompt
  - `src/domain.operations/review/compileReviewPrompt.ts`
  - `src/domain.operations/review/compileReviewPrompt.test.ts`
  - supports --soft and --push modes
  - implements 60% warning and 75% failfast thresholds

- [x] step 1.3: implement formatReviewOutput
  - `src/domain.operations/review/formatReviewOutput.ts`
  - `src/domain.operations/review/formatReviewOutput.test.ts`
  - formats blockers before nitpicks

---

## phase 2: integration operations ✅

- [x] step 2.1: implement enumFilesFromGlob
  - `src/domain.operations/review/enumFilesFromGlob.ts`
  - `src/domain.operations/review/enumFilesFromGlob.integration.test.ts`
  - supports positive and negative glob patterns

- [x] step 2.2: implement enumFilesFromDiffs
  - `src/domain.operations/review/enumFilesFromDiffs.ts`
  - `src/domain.operations/review/enumFilesFromDiffs.integration.test.ts`
  - supports since-main, since-commit, since-staged

- [x] step 2.3: implement invokeClaudeCode
  - `src/domain.operations/review/invokeClaudeCode.ts`
  - `src/domain.operations/review/invokeClaudeCode.integration.test.ts`
  - invokes claude-code cli with json output

---

## phase 3: logging infrastructure ✅

- [x] step 3.1: implement writeInputArtifacts
  - `src/domain.operations/review/writeInputArtifacts.ts`
  - `src/domain.operations/review/writeInputArtifacts.integration.test.ts`
  - writes `input.args.json` and `input.prompt.md`

- [x] step 3.2: implement writeOutputArtifacts
  - `src/domain.operations/review/writeOutputArtifacts.ts`
  - `src/domain.operations/review/writeOutputArtifacts.integration.test.ts`
  - writes `output.response.json` and `output.review.md`

---

## phase 4: core skill implementation ✅

- [x] step 4.1: implement stepReview core flow
  - `src/roles/reviewer/skills/review/stepReview.ts`
  - wires all domain operations together

- [x] step 4.2: implement input validation failfasts
  - validates at least one of --rules, --diffs, --paths specified
  - validates combined scope is non-empty
  - validates output parent directory exists

- [x] step 4.3: implement stepReview.integration.test.ts
  - `src/roles/reviewer/skills/review/stepReview.integration.test.ts`
  - covers all validation failfasts
  - verifies file enumeration

---

## phase 5: skill definition and role registration ✅

- [x] step 5.1: implement skill definition
  - `src/roles/reviewer/skills/review/stepReview.skill.ts`
  - wraps stepReview as rhachet skill

- [x] step 5.2: implement reviewer role
  - `src/roles/reviewer/getReviewerRole.ts`
  - defines role with slug "reviewer"

- [x] step 5.3: register reviewer role in registry
  - updated `src/roles/getRoleRegistry.ts`
  - ROLE_REVIEWER added to roles array

---

## phase 6: shell entrypoint ✅

- [x] step 6.1: create review.sh entrypoint
  - `src/roles/reviewer/skills/review/review.sh`
  - `src/roles/reviewer/skills/review/stepReview.cli.ts`
  - parses CLI args and invokes stepReview

---

## phase 7: documentation and briefs ✅

- [x] step 7.1: create reviewer briefs
  - `src/roles/reviewer/briefs/review.tactics.md`
  - documents modes, thresholds, and artifacts

---

## test results

```
test:types   ✅ passed
test:unit    ✅ 20 passed
test:integration ✅ 26 passed, 1 skipped
```

---

## files created

### domain operations
- `src/domain.operations/review/estimateTokenCount.ts`
- `src/domain.operations/review/compileReviewPrompt.ts`
- `src/domain.operations/review/formatReviewOutput.ts`
- `src/domain.operations/review/enumFilesFromGlob.ts`
- `src/domain.operations/review/enumFilesFromDiffs.ts`
- `src/domain.operations/review/invokeClaudeCode.ts`
- `src/domain.operations/review/writeInputArtifacts.ts`
- `src/domain.operations/review/writeOutputArtifacts.ts`

### reviewer role
- `src/roles/reviewer/getReviewerRole.ts`
- `src/roles/reviewer/skills/review/stepReview.ts`
- `src/roles/reviewer/skills/review/stepReview.skill.ts`
- `src/roles/reviewer/skills/review/stepReview.cli.ts`
- `src/roles/reviewer/skills/review/review.sh`
- `src/roles/reviewer/briefs/review.tactics.md`

### test assets
- `src/domain.operations/review/.test/assets/example.globs/*`
- `src/domain.operations/review/.test/assets/example.repo/*`

### tests
- `src/domain.operations/review/*.test.ts`
- `src/domain.operations/review/*.integration.test.ts`
- `src/roles/reviewer/skills/review/stepReview.integration.test.ts`
