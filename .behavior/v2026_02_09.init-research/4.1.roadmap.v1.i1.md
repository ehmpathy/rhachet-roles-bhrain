# roadmap: init.research skill

## overview

this roadmap executes the blueprint in `.behavior/v2026_02_09.init-research/3.3.blueprint.v1.i1.md`

phases are ordered by dependency — each phase builds on prior phases.

---

## phase 0: templates

**prereqs**: none

**read before start**:
- `.behavior/v2026_02_09.init-research/3.3.blueprint.v1.i1.md` (templates content section)

### checklist

- [ ] create `src/domain.operations/research/init/templates/` directory
- [ ] create `0.wish.md` template
- [ ] create `1.1.probes.aim.internal.stone` template
- [ ] create `1.2.probes.aim.external.stone` template
- [ ] create `1.3.probes.aim.blend.stone` template
- [ ] create `2.probes.emit.stone` template
- [ ] create `3.1.probes.absorb.kernels.stone` template
- [ ] create `3.2.probes.absorb.clusters.stone` template
- [ ] create `3.3.probes.absorb.gaps.stone` template
- [ ] create `4.probes.remit.stone` template
- [ ] create `5.1.briefs.curate.blueprint.stone` template
- [ ] create `5.2.briefs.curate.execute.stone` template

### acceptance criteria

```
given('templates directory exists')
  when('all template files are present')
    then('each template contains $RESEARCH_DIR_REL variable for substitution')
    then('0.wish.md contains "wish =" placeholder')
    then('stone files contain phase-specific instructions')
```

### verification

```sh
ls src/domain.operations/research/init/templates/
# expect: 12 files (0.wish.md + 11 .stone files)

grep -l '\$RESEARCH_DIR_REL' src/domain.operations/research/init/templates/*.stone
# expect: all .stone files listed
```

---

## phase 1: domain operations (bind)

**prereqs**: none (parallel with phase 0)

**read before start**:
- `.behavior/v2026_02_09.init-research/3.1.research.patterns._.code.prod.v1.i1.md`
- `.behavior/v2026_02_09.init-research/3.1.research.patterns._.code.test.v1.i1.md`

### checklist

- [ ] create `src/domain.operations/research/init/` directory structure
- [ ] create `setResearchBind.ts` — bind branch to research directory
- [ ] create `setResearchBind.test.ts` — unit tests
- [ ] create `getResearchBind.ts` — get bound research for current branch
- [ ] create `getResearchBind.test.ts` — unit tests
- [ ] create `delResearchBind.ts` — unbind research from branch
- [ ] create `delResearchBind.test.ts` — unit tests
- [ ] create `.test/setup.ts` — fixture paths
- [ ] create `.test/assets/research.empty/` — fixture directory
- [ ] create `.test/assets/research.bound/` — fixture directory with pre-bound research

### acceptance criteria

```
given('setResearchBind')
  when('branch is main or master')
    then('throws BadRequestError')
  when('no prior bind exists')
    then('creates .bind/{branchFlat}.{name}.flag')
  when('same research already bound')
    then('returns idempotently')
  when('different research already bound')
    then('throws BadRequestError')

given('getResearchBind')
  when('no bind exists for branch')
    then('returns null')
  when('bind exists for branch')
    then('returns { researchDir, branch }')

given('delResearchBind')
  when('bind exists')
    then('removes flag file')
  when('bind does not exist')
    then('returns { deleted: false }')
```

### verification

```sh
npm run test:unit -- setResearchBind.test.ts
npm run test:unit -- getResearchBind.test.ts
npm run test:unit -- delResearchBind.test.ts
# expect: all tests pass
```

---

## phase 2: domain operations (init)

**prereqs**: phase 0 (templates), phase 1 (bind operations)

**read before start**:
- `.behavior/v2026_02_09.init-research/3.1.research.patterns._.code.prod.v1.i1.md`
- `.behavior/v2026_02_09.init-research/3.1.research.patterns._.code.test.v1.i1.md`
- `.behavior/v2026_02_09.init-research/3.1.research.templates._.v1.i1.md`

### checklist

- [ ] create `initResearchDir.ts` — main domain operation
- [ ] create `initResearchDir.test.ts` — unit tests
- [ ] verify template enumeration logic
- [ ] verify findsert semantics (create if absent, skip if present)
- [ ] verify `$RESEARCH_DIR_REL` substitution
- [ ] verify `setResearchBind` integration

### acceptance criteria

```
given('initResearchDir')
  when('research directory does not exist')
    then('creates .research/v{isodate}.{name}/')
    then('findserts all template files')
    then('substitutes $RESEARCH_DIR_REL in template content')
    then('calls setResearchBind')
    then('returns { researchDir, created: [...], kept: [] }')
  when('research directory already exists')
    then('keeps extant files')
    then('findserts absent files')
    then('returns { researchDir, created: [...], kept: [...] }')
```

### verification

```sh
npm run test:unit -- initResearchDir.test.ts
# expect: all tests pass
```

---

## phase 3: integration tests

**prereqs**: phase 1, phase 2

**read before start**:
- `.behavior/v2026_02_09.init-research/3.1.research.patterns._.code.test.v1.i1.md`

### checklist

- [ ] create `initResearchDir.integration.test.ts`
- [ ] create `setResearchBind.integration.test.ts`
- [ ] test filesystem operations end-to-end
- [ ] test git branch detection
- [ ] test temp directory cleanup

### acceptance criteria

```
given('initResearchDir.integration')
  when('run against temp directory')
    then('creates real files on disk')
    then('template content is correct after substitution')
    then('.bind/ flag file is created')

given('setResearchBind.integration')
  when('run in git repo on feature branch')
    then('creates flag file with correct branch name')
  when('run on main branch')
    then('throws BadRequestError')
```

### verification

```sh
npm run test:integration -- initResearchDir.integration.test.ts
npm run test:integration -- setResearchBind.integration.test.ts
# expect: all tests pass
```

---

## phase 4: librarian role

**prereqs**: none (parallel with phases 0-3)

**read before start**:
- `.behavior/v2026_02_09.init-research/3.1.research.patterns._.code.prod.v1.i1.md`

### checklist

- [ ] create `src/domain.roles/librarian/getLibrarianRole.ts`
- [ ] update `src/domain.roles/librarian/.readme.[seed].md` with skill info
- [ ] create `src/domain.roles/librarian/skills/` directory
- [ ] create `src/domain.roles/librarian/skills/init.research.sh` shell entrypoint
- [ ] create portable symlink `src/domain.roles/librarian/briefs/knowledge` → `../../thinker/briefs/knowledge`
- [ ] register librarian role in role registry (if applicable)

### acceptance criteria

```
given('getLibrarianRole')
  when('called')
    then('returns Role with slug "librarian"')
    then('skills.dirs includes skills/')
    then('briefs.dirs includes briefs/')

given('init.research.sh')
  when('executed')
    then('invokes cli.research.init via node -e import pattern')
```

### verification

```sh
# verify role definition compiles
npm run build:compile

# verify shell entrypoint is executable
ls -la src/domain.roles/librarian/skills/init.research.sh
# expect: -rwxr-xr-x

# verify symlink
ls -la src/domain.roles/librarian/briefs/knowledge
# expect: knowledge -> ../../thinker/briefs/knowledge
```

---

## phase 5: cli entrypoint

**prereqs**: phase 2 (initResearchDir), phase 4 (librarian role)

**read before start**:
- `.behavior/v2026_02_09.init-research/3.1.research.patterns._.code.prod.v1.i1.md`

### checklist

- [ ] create `src/contract/cli/initResearch.ts`
- [ ] implement `parseArgs` for `--name`, `--dir`, `--open`, `--help`
- [ ] implement `printHelp` function
- [ ] implement validation before expensive operations
- [ ] invoke `initResearchDir` domain operation
- [ ] update `src/contract/cli/index.ts` to export `cli.research.init`

### acceptance criteria

```
given('initResearch cli')
  when('--help flag is present')
    then('prints help and exits')
  when('--name is absent')
    then('prints error and exits')
  when('--name is provided')
    then('invokes initResearchDir with { name, dir }')
    then('prints tree of created files')
  when('--open is provided')
    then('opens 0.wish.md in specified editor')
```

### verification

```sh
# verify cli compiles
npm run build

# verify cli export
node -e "import('rhachet-roles-bhrain/cli').then(m => console.log(typeof m.cli.research.init))"
# expect: function
```

---

## phase 6: acceptance tests

**prereqs**: phases 0-5 complete

**read before start**:
- `.behavior/v2026_02_09.init-research/2.1.criteria.blackbox.md`
- `.behavior/v2026_02_09.init-research/3.1.research.patterns._.code.test.v1.i1.md`

### checklist

- [ ] create `blackbox/.test/invokeResearchSkill.ts` helper
- [ ] create `blackbox/.test/assets/research-fixture/` fixture directory
- [ ] create `blackbox/init.research.acceptance.test.ts`
- [ ] test full skill invocation via `rhachet roles link` → shell entrypoint
- [ ] test idempotency (run twice, second run keeps files)
- [ ] test error cases (main branch, pre-bound different research)

### acceptance criteria

```
given('[case1] empty directory')
  when('[t0] init.research --name consensus-algorithms')
    then('.research/v{date}.consensus-algorithms/ is created')
    then('0.wish.md template is present')
    then('all .stone templates are present')
    then('.bind/{user}.consensus-algorithms.flag is present')

given('[case2] research already bound')
  when('[t0] init.research with same name')
    then('returns idempotently without error')
  when('[t1] init.research with different name')
    then('returns error about pre-bound research')

given('[case3] protected branch')
  when('[t0] init.research on main branch')
    then('returns error about protected branch')
```

### verification

```sh
npm run test:acceptance:locally -- init.research.acceptance.test.ts
# expect: all tests pass
```

---

## phase 7: build validation

**prereqs**: phases 0-6 complete

### checklist

- [ ] run full build
- [ ] run all test suites
- [ ] verify `rhachet roles link --role librarian` works
- [ ] verify skill invocation works end-to-end

### verification

```sh
npm run build
npm run test:types
npm run test:lint
npm run test:unit
npm run test:integration
npm run test:acceptance:locally

# manual verification
npx rhachet roles link --role librarian
npx rhachet run --repo bhrain --role librarian --skill init.research --name test-research
ls .research/
# expect: v{date}.test-research/ directory with all templates
```

---

## summary

| phase | description | depends on |
|-------|-------------|------------|
| 0 | templates | — |
| 1 | bind operations | — |
| 2 | init operation | 0, 1 |
| 3 | integration tests | 1, 2 |
| 4 | librarian role | — |
| 5 | cli entrypoint | 2, 4 |
| 6 | acceptance tests | 0-5 |
| 7 | build validation | 0-6 |

phases 0, 1, and 4 can run in parallel.
phases 2 and 3 are sequential after 0 and 1.
phase 5 requires 2 and 4.
phases 6 and 7 are final validation.
