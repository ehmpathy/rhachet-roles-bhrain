# blueprint criteria = mechanism bounds

these are the constraints on what contracts and composition must exist to deliver the blackbox experience

---

## blackbox criteria satisfied

- usecase.1 = review skill with brain choice ✓
- usecase.2 = reflect skill with brain choice ✓
- usecase.3 = brain discovery and validation ✓
- usecase.4 = programmatic brain choice via context ✓
- usecase.5 = backward compatibility ✓
- boundary.1 = supported brain providers ✓
- boundary.2 = brain reference format ✓
- boundary.3 = default brain ✓
- boundary.4 = error messages ✓
- boundary.5 = metrics consistency ✓

---

## subcomponent contracts

### genContextBrain (from rhachet)

given('genContextBrain contract')
  then('exposes: genContextBrain() => ContextBrain')
  then('ContextBrain contains registered brain atoms and repls from all providers')
  then('enables lookup of brains by provider/family/model ref')

### genContextBrainChoice (new)

> **note:** eventually, genContextBrainChoice should be part of genContextBrain in rhachet core.
> for now, place it in `src/_topublish/rhachet/` to stage for upstream contribution.

given('genContextBrainChoice contract')
  then('exposes: genContextBrainChoice(input: { brain: string, context: ContextBrain }) => ContextBrainChoice')
  then('parses brain ref in format {provider}/{family}/{model}')
  then('resolves brain from context.brain registry')
  then('returns context with brain.choice set to resolved BrainAtom | BrainRepl')
  then('throws BadRequestError when brain ref is invalid')
  then('throws BadRequestError when api key is absent for provider')
  then('lists available brains in error message')

given('ContextBrainChoice shape')
  then('extends ContextBrain')
  then('adds brain.choice: BrainAtom | BrainRepl')
  then('brain.choice.ask() returns a response')
  then('brain.choice.act() executes with tools')

### brain provider packages (from rhachet ecosystem)

given('rhachet-brain-xai contract')
  then('exports BrainAtom and BrainRepl for xai models')
  then('requires XAI_API_KEY environment variable')
  then('supports xai/grok/code-fast-1 model')
  then('supports xai/grok/3 model')

given('rhachet-brain-anthropic contract')
  then('exports BrainAtom and BrainRepl for anthropic models')
  then('requires ANTHROPIC_API_KEY environment variable')
  then('supports anthropic/claude/sonnet model')
  then('supports anthropic/claude/haiku model')

given('rhachet-brain-openai contract')
  then('exports BrainAtom and BrainRepl for openai models')
  then('requires OPENAI_API_KEY environment variable')
  then('supports openai/gpt/4o model')
  then('supports openai/gpt/4o-mini model')

### stepReview (updated)

given('stepReview contract')
  then('accepts optional brain?: string input')
  then('defaults brain to xai/grok/code-fast-1 when not provided')
  then('uses context.brain.choice for llm calls')
  then('output format remains identical to prior version')
  then('metrics reflect correct price rates for chosen brain')

### stepReflect (updated)

given('stepReflect contract')
  then('accepts optional brain?: string input')
  then('defaults brain to xai/grok/code-fast-1 when not provided')
  then('uses context.brain.choice for llm calls')
  then('output format remains identical to prior version')
  then('metrics reflect correct price rates for chosen brain')

### cli.review and cli.reflect (updated)

given('cli.review contract')
  then('accepts --brain flag from command line')
  then('passes brain to stepReview')
  then('shows available brains when --brain help')

given('cli.reflect contract')
  then('accepts --brain flag from command line')
  then('passes brain to stepReflect')
  then('shows available brains when --brain help')

---

## composition boundaries

given('skill invocation flow')
  then('cli parses --brain flag')
  then('cli calls genContextBrain to load all provider brains')
  then('cli calls genContextBrainChoice to resolve chosen brain')
  then('cli passes context with brain.choice to stepReview or stepReflect')
  then('step uses context.brain.choice.ask() or .act() for llm calls')

given('brain resolution flow')
  then('genContextBrainChoice receives brain ref string')
  then('genContextBrainChoice parses ref into provider/family/model')
  then('genContextBrainChoice looks up brain in context.brain registry')
  then('genContextBrainChoice validates api key is present')
  then('genContextBrainChoice returns context with brain.choice set')

given('error flow for invalid brain')
  then('genContextBrainChoice detects invalid ref')
  then('genContextBrainChoice throws BadRequestError with available brains list')
  then('cli catches error and displays to user')

given('error flow for absent api key')
  then('genContextBrainChoice detects absent api key for provider')
  then('genContextBrainChoice throws BadRequestError with env var name')
  then('cli catches error and displays to user')

---

## test coverage criteria

given('genContextBrainChoice')
  then('has unit tests for brain ref parse')
  then('has unit tests for brain lookup')
  then('has unit tests for api key validation')
  then('has unit tests for error messages')

given('stepReview with brain choice')
  then('has integration test for default brain')
  then('has integration test for explicit brain choice')
  then('has integration test for invalid brain error')
  then('prior integration tests continue to pass')

given('stepReflect with brain choice')
  then('has integration test for default brain')
  then('has integration test for explicit brain choice')
  then('has integration test for invalid brain error')
  then('prior integration tests continue to pass')

given('cli --brain flag')
  then('has acceptance test for --brain flag parse')
  then('has acceptance test for --brain help output')
