# roadmap: reviewer role implementation

## overview

ordered execution plan for implementing `src/roles/reviewer` per the blueprint in `3.3.blueprint.v1.i1.md`.

each step includes:
- `[x]` checklist format
- dependencies on prior steps
- behavioral acceptance criteria (from `2.criteria.md`)
- verification command or assertion

---

## phase 0: test assets

> **goal**: establish test fixtures before any code is written

### step 0.1: create test asset directories

- [ ] create `src/domain.operations/review/.test/assets/example.globs/`
- [ ] create `src/domain.operations/review/.test/assets/example.repo/`

**depends on**: nothing

**acceptance**:
- directories exist

**verify**:
```sh
ls -la src/domain.operations/review/.test/assets/
```

---

### step 0.2: populate example.globs fixtures

- [ ] create `foo.ts` with valid typescript
- [ ] create `bar.ts` with valid typescript
- [ ] create `baz.js` with valid javascript
- [ ] create `nested/qux.ts` with valid typescript
- [ ] create `nested/quux.js` with valid javascript

**depends on**: step 0.1

**acceptance**:
- glob `**/*.ts` matches 3 files (foo.ts, bar.ts, nested/qux.ts)
- glob `**/*.js` matches 2 files (baz.js, nested/quux.js)
- glob `**/*` matches all 5 files

**verify**:
```sh
find src/domain.operations/review/.test/assets/example.globs -type f | sort
```

---

### step 0.3: populate example.repo fixtures

- [ ] create `src/valid.ts` (clean file, no violations)
- [ ] create `src/invalid.ts` (file with console.log, any type)
- [ ] create `rules/rule.no-console.md` (forbid console.log)
- [ ] create `rules/rule.no-any.md` (forbid any type)
- [ ] initialize git repo: `git init && git add . && git commit -m "initial"`
- [ ] rename `.git` to `.git.template` (to avoid git-in-git issues)

**depends on**: step 0.1

**acceptance**:
- `.git.template/` exists (not `.git/`)
- `rules/*.md` matches 2 files
- `src/*.ts` matches 2 files

**verify**:
```sh
ls -la src/domain.operations/review/.test/assets/example.repo/
ls src/domain.operations/review/.test/assets/example.repo/rules/
ls src/domain.operations/review/.test/assets/example.repo/src/
```

---

## phase 1: domain operations (pure transforms)

> **goal**: implement pure-function domain operations (no fs, git, network)

### step 1.1: implement estimateTokenCount

- [ ] create `src/domain.operations/review/estimateTokenCount.ts`
- [ ] implement token estimation (heuristic or tiktoken)
- [ ] create `src/domain.operations/review/estimateTokenCount.test.ts`

**depends on**: nothing

**acceptance** (criteria usecase.6):
- `estimateTokenCount({ content: '' })` returns 0
- longer content returns proportionally higher counts
- code with special characters accounts for tokenization

**verify**:
```sh
npm run test:unit -- estimateTokenCount.test.ts
```

---

### step 1.2: implement compileReviewPrompt

- [ ] create `src/domain.operations/review/compileReviewPrompt.ts`
- [ ] implement prompt compilation for `--hard` mode (inject content)
- [ ] implement prompt compilation for `--soft` mode (paths only)
- [ ] implement 60% warning threshold
- [ ] implement 75% failfast threshold
- [ ] include context window percentage in output
- [ ] include cost estimate in output
- [ ] create `src/domain.operations/review/compileReviewPrompt.test.ts`

**depends on**: step 1.1 (uses estimateTokenCount)

**acceptance** (criteria usecase.5, usecase.6):
- `--soft` mode: prompt contains file paths, not contents; instructs brain to open files
- `--hard` mode: prompt contains file contents injected
- `--hard` mode with >75% context: throws BadRequestError with clear message recommending reduce scope or --soft
- `--hard` mode with >60% context: emits warning, continues execution
- output includes `tokenEstimate`, `contextWindowPercent`, `costEstimate`, `warnings[]`

**verify**:
```sh
npm run test:unit -- compileReviewPrompt.test.ts
```

---

### step 1.3: implement formatReviewOutput

- [ ] create `src/domain.operations/review/formatReviewOutput.ts`
- [ ] format output following `.ref.[feedback].v1.[given].by_human.md` template
- [ ] blockers appear before nitpicks
- [ ] create `src/domain.operations/review/formatReviewOutput.test.ts`

**depends on**: nothing

**acceptance** (criteria usecase.9):
- output follows feedback template format
- blockers sorted before nitpicks
- empty findings produce "no issues found" message

**verify**:
```sh
npm run test:unit -- formatReviewOutput.test.ts
```

---

## phase 2: domain operations (integration)

> **goal**: implement domain operations that touch real boundaries (fs, git, cli)

### step 2.1: implement enumFilesFromGlob

- [ ] create `src/domain.operations/review/enumFilesFromGlob.ts`
- [ ] support positive glob patterns
- [ ] support negative glob patterns with `!` prefix
- [ ] support multiple glob patterns (union)
- [ ] return sorted, deduplicated paths
- [ ] create `src/domain.operations/review/enumFilesFromGlob.integration.test.ts`

**depends on**: step 0.2 (example.globs fixtures)

**acceptance** (criteria usecase.1, usecase.3):
- positive glob matches files correctly
- negative `!` pattern excludes files
- zero matches returns empty array
- multiple globs are unioned together

**verify**:
```sh
npm run test:integration -- enumFilesFromGlob.integration.test.ts
```

---

### step 2.2: implement enumFilesFromDiffs

- [ ] create `src/domain.operations/review/enumFilesFromDiffs.ts`
- [ ] implement `uptil-main`: `git diff main --name-only`
- [ ] implement `uptil-commit`: `git diff HEAD --name-only`
- [ ] implement `uptil-staged`: `git diff --staged --name-only`
- [ ] create `src/domain.operations/review/enumFilesFromDiffs.integration.test.ts`
- [ ] tests use `setupTestRepo()` to clone example.repo into tmp

**depends on**: step 0.3 (example.repo fixtures)

**acceptance** (criteria usecase.2):
- `uptil-main`: returns files changed between HEAD and main
- `uptil-commit`: returns staged + unstaged changes
- `uptil-staged`: returns only staged files
- clean repo returns empty array

**verify**:
```sh
npm run test:integration -- enumFilesFromDiffs.integration.test.ts
```

---

### step 2.3: implement invokeClaudeCode

- [ ] create `src/domain.operations/review/invokeClaudeCode.ts`
- [ ] invoke `claude -p "$prompt" --output-format json`
- [ ] capture and parse response
- [ ] extract review content from response
- [ ] create `src/domain.operations/review/invokeClaudeCode.integration.test.ts`

**depends on**: nothing (uses real claude-code cli)

**acceptance** (criteria usecase.10):
- invokes claude-code cli with prompt
- captures response as structured output
- returns `{ response: object, review: string }`

**verify**:
```sh
npm run test:integration -- invokeClaudeCode.integration.test.ts
```

---

## phase 3: logging infrastructure

> **goal**: implement artifact logging for auditability

### step 3.1: implement writeInputArtifacts

- [ ] create `src/domain.operations/review/writeInputArtifacts.ts`
- [ ] write `input.args.json` with schema: `{ args, scope, metrics }`
- [ ] write `input.prompt.md` with exact compiled prompt
- [ ] create timestamp-based log directory `.log/bhrain/review/$timestamp/`

**depends on**: nothing

**acceptance** (criteria usecase.7):
- `input.args.json` contains original input arguments
- `input.args.json` contains all evaluated paths for --rules, --paths, --diffs
- `input.args.json` contains stats on total tokens
- `input.prompt.md` contains exact prompt sent to brain
- log directory uses ISO timestamp format

**verify**:
```sh
# manual verification after running stepReview
ls .log/bhrain/review/
cat .log/bhrain/review/*/input.args.json | jq .
```

---

### step 3.2: implement writeOutputArtifacts

- [ ] create `src/domain.operations/review/writeOutputArtifacts.ts`
- [ ] write `output.response.json` with exact brain response
- [ ] write `output.review.md` with formatted review markdown

**depends on**: step 3.1 (uses same log directory)

**acceptance** (criteria usecase.8):
- `output.response.json` contains exact brain response
- `output.review.md` follows feedback template format

**verify**:
```sh
# manual verification after running stepReview
cat .log/bhrain/review/*/output.response.json | jq .
cat .log/bhrain/review/*/output.review.md
```

---

## phase 4: core skill implementation

> **goal**: wire domain operations into stepReview skill

### step 4.1: implement stepReview core flow

- [ ] create `src/roles/reviewer/skills/review/stepReview.ts`
- [ ] implement input parsing and validation
- [ ] implement file enumeration (rules, diffs, paths)
- [ ] implement union of diffs + paths into combined targets
- [ ] implement scope empty check (failfast)
- [ ] implement prompt compilation
- [ ] implement artifact logging (input)
- [ ] implement claude-code invocation
- [ ] implement artifact logging (output)
- [ ] implement output formatting and writing

**depends on**: steps 1.1-1.3, 2.1-2.3, 3.1-3.2

**acceptance** (covers multiple criteria):
- `--rules` glob enumerates rule files (usecase.1)
- `--diffs` range enumerates changed files (usecase.2)
- `--paths` glob enumerates target files (usecase.3)
- output written to `--output` path (usecase.4)
- `--soft` mode: paths only in prompt (usecase.5)
- `--hard` mode: contents injected (usecase.6)
- logs written to `.log/bhrain/review/$timestamp/` (usecase.7, usecase.8)
- output follows feedback template (usecase.9)
- brain invoked via claude-code cli (usecase.10)

**verify**:
```sh
# smoke test with real invocation
npx tsx src/roles/reviewer/skills/review/stepReview.ts \
  --rules "rules/*.md" \
  --paths "src/*.ts" \
  --output "/tmp/review.md" \
  --mode hard
```

---

### step 4.2: implement input validation failfasts

- [ ] failfast if no --rules, --diffs, or --paths specified (usecase.11)
- [ ] failfast if combined scope resolves to zero files (usecase.12)
- [ ] failfast if multiple --diffs args provided (usecase.2)
- [ ] failfast if --output parent directory does not exist (usecase.4)
- [ ] failfast if --rules glob matches zero files (usecase.1)

**depends on**: step 4.1

**acceptance** (criteria usecase.1, usecase.2, usecase.4, usecase.11, usecase.12):
- no inputs: BadRequestError "must specify at least one of --rules, --diffs, or --paths"
- empty scope: BadRequestError "combined scope resolves to zero files"
- multiple --diffs: BadRequestError "only one --diffs is allowed"
- missing output parent: BadRequestError "output path parent directory does not exist"
- --rules zero matches: BadRequestError "glob was ineffective"

**verify**:
```sh
npm run test:integration -- stepReview.integration.test.ts
```

---

### step 4.3: implement stepReview.integration.test.ts

- [ ] create `src/roles/reviewer/skills/review/stepReview.integration.test.ts`
- [ ] test case: valid inputs with --hard mode
- [ ] test case: --diffs uptil-main with real changes
- [ ] test case: empty scope failfast
- [ ] test case: multiple --diffs failfast
- [ ] test case: missing output parent failfast
- [ ] test case: no inputs failfast
- [ ] test case: multiple --paths unioned
- [ ] test case: --paths combined with --diffs

**depends on**: step 4.1, step 4.2

**acceptance**: all 12 criteria usecases covered

**verify**:
```sh
npm run test:integration -- stepReview.integration.test.ts
```

---

## phase 5: skill definition and role registration

> **goal**: expose stepReview as a rhachet skill

### step 5.1: implement skill definition

- [ ] create `src/roles/reviewer/skills/review/stepReview.skill.ts`
- [ ] define skill with `genRoleSkill()`
- [ ] declare threads: `rules`, `diffs`, `paths`, `output`, `mode`
- [ ] implement `assess` for input validation
- [ ] implement `instantiate` for file enumeration

**depends on**: step 4.1

**acceptance**:
- skill slug is `review`
- skill can be invoked via rhachet cli
- input validation occurs before execution

**verify**:
```sh
npx rhachet run --repo bhrain --skill review --help
```

---

### step 5.2: implement reviewer role

- [ ] create `src/roles/reviewer/getReviewerRole.ts`
- [ ] define role with `Role.build()`
- [ ] register review skill

**depends on**: step 5.1

**acceptance**:
- role slug is `reviewer`
- role contains review skill

**verify**:
```sh
npx rhachet roles list --repo bhrain | grep reviewer
```

---

### step 5.3: register reviewer role in registry

- [ ] update `src/roles/getRoleRegistry.ts`
- [ ] import `ROLE_REVIEWER` from `./reviewer/getReviewerRole`
- [ ] add `ROLE_REVIEWER` to roles array

**depends on**: step 5.2

**acceptance**:
- reviewer role appears in `npx rhachet roles list`
- review skill invocable via `npx rhachet run --repo bhrain --skill review`

**verify**:
```sh
npx rhachet roles list --repo bhrain
npx rhachet run --repo bhrain --skill review --help
```

---

## phase 6: shell entrypoint

> **goal**: enable direct shell invocation for review skill

### step 6.1: create review.sh entrypoint

- [ ] create `src/roles/reviewer/skills/review/review.sh`
- [ ] parse CLI args: `--rules`, `--diffs`, `--paths`, `--output`, `--mode`
- [ ] invoke stepReview with parsed args
- [ ] handle errors with clear output

**depends on**: step 4.1

**acceptance**:
- `./review.sh --rules "*.md" --paths "*.ts" --output /tmp/out.md` works
- errors printed with clear messages

**verify**:
```sh
./src/roles/reviewer/skills/review/review.sh \
  --rules "rules/*.md" \
  --paths "src/*.ts" \
  --output "/tmp/review.md" \
  --mode hard
```

---

## phase 7: documentation and briefs

> **goal**: document reviewer role for future maintainers

### step 7.1: create reviewer briefs

- [ ] create `src/roles/reviewer/briefs/review.tactics.md`
- [ ] document review patterns and criteria
- [ ] document --soft vs --hard mode tradeoffs

**depends on**: nothing

**acceptance**:
- briefs explain reviewer purpose
- briefs explain mode selection criteria

**verify**:
```sh
cat src/roles/reviewer/briefs/review.tactics.md
```

---

## verification: full acceptance test

> **goal**: verify all 12 criteria usecases pass

### final verification

- [ ] run all unit tests
- [ ] run all integration tests
- [ ] smoke test end-to-end flow

**verify**:
```sh
npm run test:unit
npm run test:integration
npx rhachet run --repo bhrain --skill review \
  --rules ".agent/**/*mechanic/**/rule.*.md" \
  --diffs uptil-main \
  --output ".behavior/v2025_12_23.reviewer/7.review.[feedback].v1.[given].by_robot.md"
```

---

## criteria coverage matrix

| usecase | step(s) | verified by |
|---------|---------|-------------|
| usecase.1 (--rules glob) | 2.1, 4.2 | enumFilesFromGlob.integration.test.ts |
| usecase.2 (--diffs range) | 2.2, 4.2 | enumFilesFromDiffs.integration.test.ts |
| usecase.3 (--paths glob) | 2.1, 4.1 | enumFilesFromGlob.integration.test.ts |
| usecase.4 (--output path) | 4.1, 4.2 | stepReview.integration.test.ts |
| usecase.5 (--soft mode) | 1.2 | compileReviewPrompt.test.ts |
| usecase.6 (--hard mode) | 1.1, 1.2 | compileReviewPrompt.test.ts |
| usecase.7 (input artifacts) | 3.1 | stepReview.integration.test.ts |
| usecase.8 (output artifacts) | 3.2 | stepReview.integration.test.ts |
| usecase.9 (review format) | 1.3 | formatReviewOutput.test.ts |
| usecase.10 (claude-code) | 2.3 | invokeClaudeCode.integration.test.ts |
| usecase.11 (no inputs) | 4.2 | stepReview.integration.test.ts |
| usecase.12 (empty scope) | 4.2 | stepReview.integration.test.ts |

---

## dependency graph

```
phase 0 (test assets)
├── step 0.1 ─┬─> step 0.2
│             └─> step 0.3

phase 1 (pure transforms)
├── step 1.1 ─────────────────────────────────────┐
├── step 1.2 (depends on 1.1) ───────────────────>│
└── step 1.3 ────────────────────────────────────>│
                                                  │
phase 2 (integration)                             │
├── step 2.1 (depends on 0.2) ───────────────────>│
├── step 2.2 (depends on 0.3) ───────────────────>│
└── step 2.3 ────────────────────────────────────>│
                                                  │
phase 3 (logging)                                 │
├── step 3.1 ────────────────────────────────────>│
└── step 3.2 (depends on 3.1) ───────────────────>│
                                                  v
phase 4 (core skill) ─────────────────────> step 4.1
├── step 4.2 (depends on 4.1)                     │
└── step 4.3 (depends on 4.1, 4.2)                │
                                                  v
phase 5 (skill registration)                step 5.1
├── step 5.2 (depends on 5.1)                     │
└── step 5.3 (depends on 5.2)                     │
                                                  v
phase 6 (shell entrypoint) ─────────────────> step 6.1

phase 7 (docs) ─────────────────────────────> step 7.1
```

---

## estimated checkpoints

| checkpoint | steps completed | verification |
|------------|-----------------|--------------|
| fixtures ready | 0.1, 0.2, 0.3 | `ls .test/assets/` |
| pure transforms ready | 1.1, 1.2, 1.3 | `npm run test:unit` |
| integration ops ready | 2.1, 2.2, 2.3 | `npm run test:integration` |
| logging ready | 3.1, 3.2 | manual log inspection |
| core skill ready | 4.1, 4.2, 4.3 | `npm run test:integration` |
| skill registered | 5.1, 5.2, 5.3 | `npx rhachet roles list` |
| shell entrypoint ready | 6.1 | `./review.sh --help` |
| fully documented | 7.1 | code review |
