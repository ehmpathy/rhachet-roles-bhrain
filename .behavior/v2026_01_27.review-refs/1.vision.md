# vision: --refs for review skill

enable rules to reference external documents, so reviewers can cross-check against specs, criteria, or any context the rule author deems relevant.

---

## multiple values syntax

for `--rules`, `--paths`, and `--refs` â€” support multiple values via repeated flags:

```sh
npx rhachet run --skill review \
    --rules .agent/**/rules/rule.style.md \
    --rules .agent/**/rules/rule.coverage.md \
    --paths src/**/*.ts \
    --paths test/**/*.ts \
    --refs .behavior/*/2.criteria.blackbox.md \
    --refs .style-guides/*.md
```

each flag can be specified multiple times. each value can be a glob or explicit path.

---

## episode 1: verify test coverage against criteria doc

the user has a behavior criteria doc and wants to verify their tests cover all criteria.

```sh
$ cat .agent/repo=.this/rules/rule.verify-coverage.md
severity = blocker
domain = behavior

what = verify that all criteria in the referenced blackbox doc have test coverage

enumerate each criteria and mark as "covered" or "BLOCKER: not covered"
```

```sh
$ npx rhachet run --skill review \
    --rules .agent/repo=.this/rules/rule.verify-coverage.md \
    --paths src/**/*.test.ts \
    --refs .behavior/v2026_01_27/2.criteria.blackbox.md
```

```
ğŸ”­ metrics.expected
   â”œâ”€ files
   â”‚  â”œâ”€ rules: 1
   â”‚  â”œâ”€ targets: 12
   â”‚  â””â”€ refs: 1
   â””â”€ cost
      â””â”€ estimate: $0.02

ğŸ¦‰ let's review!
   â””â”€ elapsed: 4.2s âœ“

âœ¨ metrics.realized
   â””â”€ cost
      â””â”€ total: $0.019

ğŸŒŠ output
   â”œâ”€ review: .log/bhrain/review/2026-01-27T.../output.review.md
   â””â”€ summary
      â”œâ”€ 2 blockers ğŸ”´
      â””â”€ 0 nitpicks
```

**output.review.md:**
```markdown
# blocker.1: usecase.5 not covered

**rule**: .agent/repo=.this/rules/rule.verify-coverage.md
**ref**: .behavior/v2026_01_27/2.criteria.blackbox.md

usecase.5 (invalid ref path) has no test coverage in the evaluated test files.

---

# blocker.2: usecase.6 not covered

**rule**: .agent/repo=.this/rules/rule.verify-coverage.md
**ref**: .behavior/v2026_01_27/2.criteria.blackbox.md

usecase.6 (glob matches zero files) has no test coverage in the evaluated test files.
```

---

## episode 2: review prose against multiple style guide refs

the user wants to review chapter drafts against multiple style guides via glob.

```sh
$ npx rhachet run --skill review \
    --rules .agent/repo=.this/rules/rule.prose-style.md \
    --paths chapters/*.md \
    --refs .style-guides/*.md
```

```
ğŸ”­ metrics.expected
   â”œâ”€ files
   â”‚  â”œâ”€ rules: 1
   â”‚  â”œâ”€ targets: 3
   â”‚  â””â”€ refs: 3
   â””â”€ cost
      â””â”€ estimate: $0.01

ğŸ¦‰ let's review!
   â””â”€ elapsed: 3.1s âœ“

âœ¨ metrics.realized
   â””â”€ cost
      â””â”€ total: $0.009

ğŸŒŠ output
   â”œâ”€ review: .log/bhrain/review/2026-01-27T.../output.review.md
   â””â”€ summary
      â”œâ”€ 1 blocker ğŸ”´
      â””â”€ 1 nitpick ğŸŸ 
```

**output.review.md:**
```markdown
# blocker.1: passive voice in key statement

**rule**: .agent/repo=.this/rules/rule.prose-style.md

**locations**:
- chapters/chapter2.md:87

per tone.md: avoid passive voice in key statements. "was created" should be "created".

---

# nitpick.1: prefer "use" over "utilize"

**rule**: .agent/repo=.this/rules/rule.prose-style.md

**locations**:
- chapters/chapter2.md:42

per vocabulary.md: prefer simple words. "utilize" should be "use".
```

---

## episode 3: multiple refs via repeated flags

the user needs to reference both criteria and architecture docs.

```sh
$ npx rhachet run --skill review \
    --rules .agent/repo=.this/rules/rule.verify-impl.md \
    --paths src/domain.operations/**/*.ts \
    --refs .behavior/v2026_01_27/2.criteria.blackbox.md \
    --refs .behavior/v2026_01_27/2.criteria.blueprint.md \
    --refs docs/architecture.md
```

```
ğŸ”­ metrics.expected
   â”œâ”€ files
   â”‚  â”œâ”€ rules: 1
   â”‚  â”œâ”€ targets: 8
   â”‚  â””â”€ refs: 3
   â””â”€ cost
      â””â”€ estimate: $0.03

ğŸ¦‰ let's review!
   â””â”€ elapsed: 5.7s âœ“

ğŸŒŠ output
   â”œâ”€ review: .log/bhrain/review/2026-01-27T.../output.review.md
   â””â”€ summary
      â”œâ”€ 0 blockers
      â”œâ”€ 0 nitpicks
      â””â”€ all good ğŸ‘
```

---

## episode 4: error â€” ref path does not exist

the user specifies a ref that doesn't exist.

```sh
$ npx rhachet run --skill review \
    --rules .agent/repo=.this/rules/rule.verify-coverage.md \
    --paths src/**/*.ts \
    --refs .behavior/v2026_01_27/criteria.blackbox.md
```

```
â›ˆï¸ review failed

ref not found: .behavior/v2026_01_27/criteria.blackbox.md

did you mean?
  â€¢ .behavior/v2026_01_27/2.criteria.blackbox.md
```

---

## episode 5: error â€” glob matches no files

the user specifies a glob that resolves to zero matches.

```sh
$ npx rhachet run --skill review \
    --rules .agent/repo=.this/rules/rule.verify-coverage.md \
    --paths src/**/*.ts \
    --refs .behavior/v2025_01_01/*.md
```

```
â›ˆï¸ review failed

no refs matched glob: .behavior/v2025_01_01/*.md

hint: verify the path exists and contains .md files
```

---

## episode 6: no refs (backwards compat)

the user invokes review without --refs, as before.

```sh
$ npx rhachet run --skill review \
    --rules .agent/repo=.this/rules/rule.code-style.md \
    --paths src/**/*.ts
```

```
ğŸ”­ metrics.expected
   â”œâ”€ files
   â”‚  â”œâ”€ rules: 1
   â”‚  â””â”€ targets: 47
   â””â”€ cost
      â””â”€ estimate: $0.04

ğŸ¦‰ let's review!
   â””â”€ elapsed: 6.3s âœ“

ğŸŒŠ output
   â”œâ”€ review: .log/bhrain/review/2026-01-27T.../output.review.md
   â””â”€ summary
      â”œâ”€ 0 blockers
      â””â”€ 1 nitpick ğŸŸ 
```

works as before â€” no refs in metrics, no change to prior behavior.
