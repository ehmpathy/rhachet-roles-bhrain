# blueprint: review output devexp

## summary

improve the review skill's output path handle to:
1. default `--output` to `.review/$branch/$isotime.output.md` when omitted
2. auto-create parent directories when `--output` is specified but parent is absent

## filediffs

```
src/
â”œâ”€â”€ contract/cli/
â”‚   â””â”€â”€ [~] review.ts                           # make --output optional, add default path generation
â”œâ”€â”€ domain.operations/review/
â”‚   â”œâ”€â”€ [~] stepReview.ts                       # replace error on absent parent with mkdir recursive
â”‚   â”œâ”€â”€ [+] genDefaultReviewOutputPath.ts       # generate default output path from branch + timestamp
â”‚   â”œâ”€â”€ [+] genDefaultReviewOutputPath.test.ts  # unit tests for default path generation
â”‚   â”œâ”€â”€ [+] sanitizeBranchName.ts               # convert branch names to filesystem-safe strings
â”‚   â””â”€â”€ [+] sanitizeBranchName.test.ts          # unit tests for branch sanitization
blackbox/
â”œâ”€â”€ [+] review.output-default.acceptance.test.ts    # acceptance test: default output path
â””â”€â”€ [+] review.output-mkdir.acceptance.test.ts      # acceptance test: mkdir on absent parent
```

## codepaths

### sanitizeBranchName.ts

```
[+] sanitizeBranchName
    input: { branch: string }
    output: string

    .what = converts branch name to filesystem-safe string
    .why = branches like "feat/my-feature" contain slashes that would create subdirs

    logic:
    - replace "/" with "." (preserves hierarchy readability)
    - replace other unsafe chars with "-"
    - collapse multiple consecutive "-" or "."
    - trim start/end "-" or "."
```

### genDefaultReviewOutputPath.ts

```
[+] genDefaultReviewOutputPath
    input: { cwd: string }
    output: string

    .what = generates default review output path
    .why = enables omission of --output with sensible default

    logic:
    - get current git branch via `git rev-parse --abbrev-ref HEAD`
    - sanitize branch name via sanitizeBranchName
    - generate ISO timestamp (filesystem-safe: colons replaced with dashes)
    - return `.review/${branchSanitized}/${isotime}.output.md`
```

### review.ts (cli)

```
[â—‹] parseArgs
    - retain current parse logic
    - output remains in return type (now potentially undefined)

[~] review (entrypoint)
    - remove "error: --output is required" check
    - if output is undefined:
        - call genDefaultReviewOutputPath({ cwd: process.cwd() })
        - assign result to options.output
    - pass resolved output to stepReview
    - print "ðŸ“„ output: ${outputPath}" to stdout when default is used
```

### stepReview.ts

```
[~] output parent validation block (lines 180-191)
    before:
      validate output parent directory exists
      throw BadRequestError if absent

    after:
      ensure output parent directory exists
      await fs.mkdir(outputParentAbsolute, { recursive: true })
      (no error thrown; directory created if absent)
```

## contracts

### genDefaultReviewOutputPath

```ts
/**
 * .what = generates default review output path from git branch and timestamp
 * .why = enables --output omission with organized default location
 */
export const genDefaultReviewOutputPath = async (
  input: { cwd: string },
): Promise<string> => {
  // get current git branch
  const branch = await getCurrentGitBranch({ cwd: input.cwd });

  // sanitize branch for filesystem
  const branchSafe = sanitizeBranchName({ branch });

  // generate filesystem-safe ISO timestamp
  const isotime = new Date().toISOString().replace(/[:.]/g, '-');

  // compose path
  return `.review/${branchSafe}/${isotime}.output.md`;
};
```

### sanitizeBranchName

```ts
/**
 * .what = converts branch name to filesystem-safe string
 * .why = branches with slashes like "feat/my-feature" would create subdirs
 */
export const sanitizeBranchName = (
  input: { branch: string },
): string => {
  return input.branch
    .replace(/\//g, '.')              // slashes to dots (preserves hierarchy readability)
    .replace(/[^a-zA-Z0-9-_.]/g, '-') // other unsafe chars to dashes
    .replace(/[-_.]{2,}/g, (m) => m[0]) // collapse consecutive special chars
    .replace(/^[-_.]|[-_.]$/g, '');   // trim start/end special chars
};
```

## test coverage

### unit tests

**sanitizeBranchName.test.ts**
```
given('a branch name')
  when('branch is "main"')
    then('returns "main"')
  when('branch is "feat/my-feature"')
    then('returns "feat.my-feature"')
  when('branch is "user/john/task-123"')
    then('returns "user.john.task-123"')
  when('branch contains special chars "feat/my@feature#1"')
    then('returns "feat.my-feature-1"')
```

**genDefaultReviewOutputPath.test.ts**
```
given('a git repository')
  when('current branch is "main"')
    then('path contains "main" as branch segment')
    then('path starts with ".review/"')
    then('path ends with ".output.md"')
  when('current branch is "feat/new-task"')
    then('path contains "feat.new-task" (sanitized)')
```

### integration tests

**stepReview mkdir behavior** (add to stepReview.integration.test.ts)
```
given('output path with absent parent')
  when('stepReview is invoked')
    then('parent directories are created')
    then('review is written to specified path')
```

### acceptance tests

**review.output-default.acceptance.test.ts**
```
given('mechanic codebase')
  when('review skill invoked without --output')
    then('cli completes successfully')
    then('review is written to .review/$branch/$isotime.output.md')
    then('output path is printed to stdout')
```

**review.output-mkdir.acceptance.test.ts**
```
given('mechanic codebase')
  when('review skill invoked with --output to absent parent')
    then('cli completes successfully')
    then('parent directory is created')
    then('review is written to specified path')
```

## sequence diagram

```
user invokes: review.sh --rules "..." --paths "..."

review.ts (cli)
  â”‚
  â”œâ”€ parseArgs(process.argv)
  â”‚   â””â”€ options.output = undefined (not specified)
  â”‚
  â”œâ”€ if (!options.output)
  â”‚   â””â”€ genDefaultReviewOutputPath({ cwd })
  â”‚       â”œâ”€ getCurrentGitBranch â†’ "feat/my-feature"
  â”‚       â”œâ”€ sanitizeBranchName â†’ "feat.my-feature"
  â”‚       â”œâ”€ genIsoTimestamp â†’ "2026-02-03T14-30-00-000Z"
  â”‚       â””â”€ return ".review/feat.my-feature/2026-02-03T14-30-00-000Z.output.md"
  â”‚
  â”œâ”€ console.log("ðŸ“„ output: .review/feat.my-feature/...")
  â”‚
  â””â”€ stepReview({ ..., output: resolvedPath })
      â”‚
      â”œâ”€ resolve outputParentAbsolute
      â”œâ”€ await fs.mkdir(outputParentAbsolute, { recursive: true })  // always, idempotent
      â”‚
      â””â”€ ... rest of review logic ...
          â”‚
          â””â”€ await fs.writeFile(outputAbsolute, formattedReview)
```

## implementation notes

1. **git branch detection**: use `execAsync('git rev-parse --abbrev-ref HEAD')` â€” same pattern as enumFilesFromDiffs

2. **mkdir is idempotent**: `fs.mkdir({ recursive: true })` is safe to call even if dir exists â€” no conditional needed

3. **output printed to stdout**: when the default path is used, print the resolved path so users know where to find their review

4. **timestamp precision**: use full ISO with milliseconds for uniqueness across rapid invocations

5. **detached HEAD**: when in detached HEAD state, `git rev-parse --abbrev-ref HEAD` returns "HEAD" â€” sanitizes fine
