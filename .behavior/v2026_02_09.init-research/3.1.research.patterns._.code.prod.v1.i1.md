# research: production code patterns for init.research

## summary

the rhachet-roles-bhrain codebase has established patterns for roles, skills, CLI entrypoints, and domain operations. init.research will [REUSE] most patterns and [EXTEND] the librarian role.

---

## pattern.1 = role definition

### getReviewerRole.ts

**[REUSE]** role definition via `Role.build()` with briefs and skills directories [1]

```typescript
export const ROLE_REVIEWER: Role = Role.build({
  slug: 'reviewer',
  name: 'Reviewer',
  purpose: 'review artifacts against declared rules',
  readme: { uri: __dirname + '/readme.md' },
  traits: [],
  skills: {
    dirs: [{ uri: __dirname + '/skills' }],
    refs: [],
  },
  briefs: {
    dirs: [{ uri: __dirname + '/briefs' }],
  },
});
```

**init.research adaptation**: create `getLibrarianRole.ts` with skills and briefs directories

---

## pattern.2 = shell skill entrypoint

### review.sh

**[REUSE]** shell wrapper that invokes node via package import [2]

```bash
#!/usr/bin/env bash
set -euo pipefail
exec node -e "import('rhachet-roles-bhrain/cli').then(m => m.cli.review())" -- "$@"
```

> "enables direct invocation from CLI, CI/CD, git hooks via location-independent package import"

**init.research adaptation**: create `init.research.sh` that invokes `cli.initResearch()`

---

## pattern.3 = CLI entrypoint

### contract/cli/review.ts

**[REUSE]** CLI entrypoint pattern with arg parse, help display, and domain operation invocation [3]

key components:
- `parseArgs()` — simple arg parser without external dependencies
- `isNodeEvalMode()` — detects `node -e` invocation mode
- `printHelp()` — displays usage information
- validation before expensive operations
- invokes domain operation (`stepReview`)

```typescript
export const review = async (): Promise<void> => {
  const options = parseArgs(process.argv);
  if (hasHelpFlag(process.argv)) {
    await printHelp();
    return;
  }
  // validate, then invoke domain operation
  await stepReview({ ... }, { brain });
};
```

**init.research adaptation**: create `contract/cli/initResearch.ts` with similar pattern

---

## pattern.4 = CLI export structure

### contract/cli/index.ts

**[EXTEND]** CLI export namespace for fast startup [4]

```typescript
export const cli = {
  review,
  reflect,
  route: {
    bind: routeBind,
    stone: { get, set, del, judge },
  },
};
```

> "fast cli entrypoint for skill invocation, avoids heavy imports until needed"

**init.research adaptation**: add `initResearch` to the cli export

---

## pattern.5 = domain operation structure

### domain.operations/review/

**[REUSE]** domain operation folder structure [5]

```
domain.operations/review/
├── stepReview.ts                    # main operation
├── stepReview.integration.test.ts   # integration tests
├── compileReviewPrompt.ts           # helper operations
├── enumFilesFromGlob.ts             # utility operations
├── genDefaultReviewOutputPath.ts    # output path generation
├── writeInputArtifacts.ts           # artifact write
├── writeOutputArtifacts.ts          # artifact write
└── .test/                           # test assets
```

**init.research adaptation**: create `domain.operations/research/init/` with similar structure

---

## pattern.6 = route bind operations

### domain.operations/route/bind/

**[REUSE]** bind operations for branch-to-route association [6]

```
route/bind/
├── getRouteBind.ts
├── getRouteBindByBranch.ts
├── setRouteBind.ts
├── delRouteBind.ts
```

> branch bind creates `.bind/` directory with flag files

**init.research adaptation**: reuse route bind operations for research directory bind

---

## pattern.7 = route stone operations

### domain.operations/route/

**[REUSE]** stone operations for thoughtroute management [7]

```
route/
├── stepRouteStoneGet.ts    # get next stone(s)
├── stepRouteStoneSet.ts    # mark stone as passed
├── stepRouteStoneDel.ts    # delete stone result
├── stones/                 # stone discovery
├── guard/                  # guard evaluation
├── judges/                 # judge execution
```

**init.research adaptation**: reuse stone operations for research thoughtroute

---

## pattern.8 = librarian role structure

### domain.roles/librarian/

**[EXTEND]** librarian role with briefs but no skills yet [8]

```
librarian/
├── .readme.[seed].md           # role purpose
└── briefs/
    └── define.brief-name-pattern.[article].md
```

> "librarian = curator of context, master of briefs"

**init.research adaptation**: add `skills/` directory with `init.research.sh`

---

## pattern summary

| pattern | file/directory | action | notes |
|---------|----------------|--------|-------|
| role definition | `getReviewerRole.ts` | [REUSE] | create `getLibrarianRole.ts` |
| shell entrypoint | `review.sh` | [REUSE] | create `init.research.sh` |
| cli entrypoint | `contract/cli/review.ts` | [REUSE] | create `initResearch.ts` |
| cli export | `contract/cli/index.ts` | [EXTEND] | add `initResearch` |
| domain operation | `domain.operations/review/` | [REUSE] | create `research/init/` |
| route bind | `domain.operations/route/bind/` | [REUSE] | use for research bind |
| route stones | `domain.operations/route/` | [REUSE] | use for research thoughtroute |
| librarian role | `domain.roles/librarian/` | [EXTEND] | add skills directory |

---

## citations

| # | source | description |
|---|--------|-------------|
| 1 | `src/domain.roles/reviewer/getReviewerRole.ts` | role definition pattern |
| 2 | `src/domain.roles/reviewer/skills/review.sh` | shell skill entrypoint pattern |
| 3 | `src/contract/cli/review.ts` | cli entrypoint pattern |
| 4 | `src/contract/cli/index.ts` | cli export structure |
| 5 | `src/domain.operations/review/` | domain operation folder structure |
| 6 | `src/domain.operations/route/bind/` | route bind operations |
| 7 | `src/domain.operations/route/` | route stone operations |
| 8 | `src/domain.roles/librarian/` | librarian role structure |
