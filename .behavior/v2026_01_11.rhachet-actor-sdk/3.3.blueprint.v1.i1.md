# blueprint: brain choice for review and reflect skills

this blueprint describes how to implement brain choice for review and reflect skills via rhachet's BrainAtom and BrainRepl interfaces.

---

## overview

### scope
- enable `--brain` flag for review and reflect cli skills
- replace direct claude cli spawn with `context.brain.choice.ask()` and `.act()`
- default brain: `xai/grok/code-fast-1`
- remove `rapid` flag in favor of explicit brain selection
- remove local price rate and usage extraction logic (defer to rhachet interfaces)

### out of scope
- BrainArch1 directory (ignore completely)
- price rate calculation (todo: expose via rhachet on responses)
- usage extraction logic (todo: expose via rhachet on responses)

---

## phase.0 = genContextBrainChoice contract

### summary
create the `genContextBrainChoice` function that resolves a brain ref to `context.brain.choice`.

### files to create

#### `src/_topublish/rhachet/genContextBrainChoice.ts`
```typescript
/**
 * .what = resolves a brain ref to context.brain.choice
 * .why = enables skills to access a chosen brain via context.brain.choice.ask() and .act()
 *
 * .note = this is staged for upstream contribution to rhachet core
 */
export const genContextBrainChoice = async (input: {
  brain: string; // format: {provider}/{family}/{model}
  context: ContextBrain;
}): Promise<ContextBrainChoice> => {
  // parse brain ref
  // lookup brain in context.brain registry
  // validate api key is present
  // return context with brain.choice set
};
```

**contract:**
- parse brain ref in format `{provider}/{family}/{model}`
- resolve brain from `context.brain` registry
- validate api key is present for provider
- throw `BadRequestError` with available brains list on invalid ref
- throw `BadRequestError` with env var name on absent api key

#### `src/_topublish/rhachet/genContextBrainChoice.test.ts`
unit tests for:
- brain ref parse (valid and invalid formats)
- brain lookup (found and not found)
- api key validation (present and absent)
- error messages (lists available brains)

### dependencies
- `rhachet` (for `genContextBrain`, `ContextBrain`)
- `rhachet-brain-xai` (for xai brains)
- `rhachet-brain-anthropic` (for anthropic brains)
- `rhachet-brain-openai` (for openai brains)

---

## phase.1 = cli brain flag

### summary
add `--brain` flag to review and reflect cli entrypoints.

### files to modify

#### `src/contract/cli/review.ts`
```typescript
const schemaOfArgs = z.object({
  named: z.object({
    // prior args...
    brain: z.string().optional(), // add brain arg
  }),
  ordered: z.array(z.string()).default([]),
});

// in main():
const brain = args.named.brain ?? 'xai/grok/code-fast-1';
```

#### `src/contract/cli/reflect.ts`
```typescript
const schemaOfArgs = z.object({
  named: z.object({
    // prior args...
    brain: z.string().optional(), // add brain arg
    // remove rapid since replaced by brain selection
  }),
  ordered: z.array(z.string()).default([]),
});

// in main():
const brain = args.named.brain ?? 'xai/grok/code-fast-1';
```

### tests
- unit tests for cli arg schema parse
- acceptance test for `--brain help` output (lists available brains)

---

## phase.2 = stepReview with brain choice

### summary
update `stepReview` to accept `brain?: string` and use `context.brain.choice` for llm calls.

### files to modify

#### `src/domain.operations/review/stepReview.ts`
```typescript
export const stepReview = async (input: {
  rules: string | string[];
  diffs?: string;
  paths?: string | string[];
  output: string;
  focus: 'pull' | 'hard';
  cwd?: string;
  brain?: string; // add brain input
}): Promise<StepReviewResult> => {
  const brain = input.brain ?? 'xai/grok/code-fast-1';

  // load brain context
  const contextBrain = await genContextBrain();
  const contextBrainChoice = await genContextBrainChoice({
    brain,
    context: contextBrain,
  });

  // replace invokeClaudeCode with context.brain.choice.ask()
  const brainResult = await contextBrainChoice.brain.choice.ask({
    prompt: compiledPrompt,
    // ...
  });
};
```

#### `src/domain.operations/review/invokeClaudeCode.ts`
- mark as deprecated or remove
- replace all usages with `context.brain.choice.ask()`

### files to create

#### `src/domain.operations/review/stepReview.caseBrainChoice.integration.test.ts`
integration tests for:
- default brain (`xai/grok/code-fast-1`)
- explicit brain choice (`anthropic/claude/sonnet`)
- invalid brain error with available brains list
- metrics structure (tokens present, cost commented out with todo)

### tests
- unit tests: prompt compilation unchanged
- integration tests: brain choice flows
- acceptance tests: cli with `--brain` flag

---

## phase.3 = stepReflect with brain choice

### summary
update `stepReflect` to accept `brain?: string` and use `context.brain.choice` for llm calls.

### files to modify

#### `src/domain.operations/reflect/stepReflect.ts`
```typescript
export const stepReflect = async (input: {
  source: string;
  target: string;
  mode?: 'soft' | 'hard';
  force?: boolean;
  brain?: string; // add brain input (replaces rapid)
}): Promise<StepReflectResult> => {
  const brain = input.brain ?? 'xai/grok/code-fast-1';

  // load brain context
  const contextBrain = await genContextBrain();
  const contextBrainChoice = await genContextBrainChoice({
    brain,
    context: contextBrain,
  });

  // replace invokeClaudeCodeForReflect with context.brain.choice.act()
  // step1 and step2 both use brain.choice
};
```

#### `src/domain.operations/reflect/invokeClaudeCodeForReflect.ts`
- mark as deprecated or remove
- replace all usages with `context.brain.choice.act()`

#### `src/domain.operations/reflect/step2/compileReflectStep2Prompt.ts`
- remove `rapid?: boolean` input
- remove haiku-specific SET_UPDATE disable logic
- prompt now uniform for all brains

### files to create

#### `src/domain.operations/reflect/stepReflect.caseBrainChoice.integration.test.ts`
integration tests for:
- default brain (`xai/grok/code-fast-1`)
- explicit brain choice (`anthropic/claude/sonnet`)
- invalid brain error with available brains list
- metrics structure (tokens present, cost commented out with todo)

### files to modify (test files)

#### `src/domain.operations/reflect/stepReflect.casePriorRules.haiku.integration.test.ts`
- rename to `stepReflect.casePriorRules.grok.integration.test.ts`
- change `rapid: true` to `brain: 'xai/grok/code-fast-1'`
- update assertions for grok capabilities

#### `src/domain.operations/reflect/stepReflect.casePriorRules.sonnet.integration.test.ts`
- change `rapid: false` to `brain: 'anthropic/claude/sonnet'`
- update timeout appropriately

### tests
- unit tests: prompt compilation no longer depends on rapid
- integration tests: brain choice flows with grok default
- acceptance tests: cli with `--brain` flag

---

## phase.4 = remove deprecated patterns

### summary
clean up deprecated code after brain choice is implemented.

### files to remove or deprecate

#### remove price rate logic (comment out with todo)
- `src/domain.operations/reflect/metrics/computeMetricsExpected.ts:22-30`
  - comment out cost calculation
  - add: `// todo: expose prices via rhachet BrainAtom and BrainRepl on responses`
- `src/domain.operations/reflect/metrics/computeMetricsRealized.ts:77-96`
  - comment out cost calculation
  - add: `// todo: expose prices via rhachet BrainAtom and BrainRepl on responses`
- `src/domain.operations/review/stepReview.ts:358-368`
  - comment out realizedCosts calculation
  - add: `// todo: expose prices via rhachet BrainAtom and BrainRepl on responses`

#### remove usage extraction logic (comment out with todo)
- `src/domain.operations/reflect/invokeClaudeCodeForReflect.ts:10-15,174-185`
  - comment out ReflectClaudeUsage interface and extraction
  - add: `// todo: expose usage via rhachet BrainAtom and BrainRepl on responses`

#### remove rapid flag logic
- `src/domain.operations/reflect/stepReflect.ts`: remove `rapid?: boolean` input
- `src/domain.operations/reflect/step2/compileReflectStep2Prompt.ts`: remove `rapid?: boolean` input and haiku-specific logic
- `src/contract/cli/reflect.ts`: remove `rapid` from schema

---

## phase.5 = backward compatibility

### summary
ensure prior workflows continue to work.

### requirements
- `stepReview()` without `brain` arg works (uses default)
- `stepReflect()` without `brain` arg works (uses default)
- cli without `--brain` flag works (uses default)
- output format identical to prior version
- log structure identical to prior version

### tests
- all prior integration tests continue to pass
- all prior acceptance tests continue to pass

---

## test coverage matrix

### unit tests

| component | tests |
|-----------|-------|
| `genContextBrainChoice` | parse brain ref, lookup brain, api key validation, error messages |
| `stepReview` input schema | brain arg optional with default |
| `stepReflect` input schema | brain arg optional with default |
| `compileReflectStep2Prompt` | no longer varies by rapid flag |
| cli arg schemas | brain arg parse |

### integration tests

| component | tests |
|-----------|-------|
| `genContextBrainChoice` | resolve xai/anthropic/openai brains from registry |
| `stepReview.caseBrainChoice` | default brain, explicit brain, invalid brain error |
| `stepReflect.caseBrainChoice` | default brain, explicit brain, invalid brain error |
| `stepReflect.casePriorRules.grok` | grok capabilities (replaces haiku test) |
| `stepReflect.casePriorRules.sonnet` | sonnet capabilities (updated to use brain arg) |

### acceptance tests

| feature | tests |
|---------|-------|
| review cli | `--brain xai/grok/code-fast-1`, `--brain anthropic/claude/sonnet`, `--brain help` |
| reflect cli | `--brain xai/grok/code-fast-1`, `--brain anthropic/claude/sonnet`, `--brain help` |
| backward compat | prior workflows without `--brain` flag |

---

## implementation order

1. **phase.0**: genContextBrainChoice contract (foundation)
2. **phase.1**: cli brain flag (user interface)
3. **phase.2**: stepReview with brain choice (first skill)
4. **phase.3**: stepReflect with brain choice (second skill)
5. **phase.4**: remove deprecated patterns (cleanup)
6. **phase.5**: backward compatibility verification (validation)

---

## dependencies to install

```json
{
  "dependencies": {
    "rhachet": "^x.x.x",
    "rhachet-brain-xai": "^x.x.x",
    "rhachet-brain-anthropic": "^x.x.x",
    "rhachet-brain-openai": "^x.x.x"
  }
}
```

---

## environment variables required

| provider | env var |
|----------|---------|
| xai | `XAI_API_KEY` |
| anthropic | `ANTHROPIC_API_KEY` |
| openai | `OPENAI_API_KEY` |

---

## brain ref format

```
{provider}/{family}/{model}
```

| brain ref | provider | family | model |
|-----------|----------|--------|-------|
| `xai/grok/code-fast-1` | xai | grok | code-fast-1 |
| `xai/grok/3` | xai | grok | 3 |
| `anthropic/claude/sonnet` | anthropic | claude | sonnet |
| `anthropic/claude/haiku` | anthropic | claude | haiku |
| `openai/gpt/4o` | openai | gpt | 4o |
| `openai/gpt/4o-mini` | openai | gpt | 4o-mini |

---

## error message format

```
brain not found: {invalid-ref}

available brains:
  xai/grok/code-fast-1
  xai/grok/3
  anthropic/claude/sonnet (requires ANTHROPIC_API_KEY)
  anthropic/claude/haiku (requires ANTHROPIC_API_KEY)
  openai/gpt/4o (requires OPENAI_API_KEY)
  openai/gpt/4o-mini (requires OPENAI_API_KEY)
```

---

## summary

| phase | focus | key deliverable |
|-------|-------|-----------------|
| phase.0 | foundation | `genContextBrainChoice` with tests |
| phase.1 | user interface | `--brain` cli flag |
| phase.2 | first skill | `stepReview` with brain choice |
| phase.3 | second skill | `stepReflect` with brain choice |
| phase.4 | cleanup | remove deprecated patterns |
| phase.5 | validation | backward compatibility verified |
