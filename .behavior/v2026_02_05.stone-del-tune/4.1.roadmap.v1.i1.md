
# roadmap: route.stone.del tune

## phase 0: asStoneGlob â€” fuzzy pattern transform

**read before start:**
- `.behavior/v2026_02_05.stone-del-tune/3.3.blueprint.v1.i1.md` (contracts for asStoneGlob + isStoneInGlob)

### steps

- [ ] create `src/domain.operations/route/stones/asStoneGlob.ts`
  - [ ] implement `asStoneGlob({ pattern })` â€” returns `{ glob, raw }`
    - if pattern contains `*` or `?`, return as-is
    - otherwise wrap with `*...*`
  - [ ] implement `isStoneInGlob({ name, glob })` â€” glob-to-regex match
    - extract logic from `matchGlob` in `stepRouteStoneDel.ts`

- [ ] create `src/domain.operations/route/stones/asStoneGlob.test.ts`
  - [ ] `research` â†’ glob = `*research*`
  - [ ] `*.research.*` â†’ glob = `*.research.*` (pass through)
  - [ ] `*` â†’ glob = `*` (pass through)
  - [ ] `3.1.research.domain._.v1` â†’ glob = `*3.1.research.domain._.v1*`
  - [ ] isStoneInGlob: `3.1.research.domain._.v1` matches `*research*`
  - [ ] isStoneInGlob: `1.vision` does not match `*research*`

### verify

```sh
npm run test:unit -- asStoneGlob
```
- [ ] all unit tests pass


## phase 1: stepRouteStoneDel â€” new contract with mode + fuzzy pattern

**read before start:**
- `.behavior/v2026_02_05.stone-del-tune/3.3.blueprint.v1.i1.md` (stepRouteStoneDel contract)
- `.behavior/v2026_02_05.stone-del-tune/2.1.criteria.blackbox.md` (usecase.1â€“3)

### steps

- [ ] update `src/domain.operations/route/stepRouteStoneDel.ts`
  - [ ] add `mode: 'plan' | 'apply'` to input
  - [ ] replace inline `matchGlob` with `asStoneGlob` + `isStoneInGlob` from phase 0
  - [ ] plan mode: classify each matched stone via `getAllStoneArtifacts`, return stones array with `delete`/`retain` status, no disk mutation
  - [ ] apply mode: retain prior deletion logic, return stones array with `deleted`/`retained` status
  - [ ] update return shape: add `pattern`, `patternRaw`, `stones[]`; rename `skipped` â†’ `retained`
  - [ ] remove inline `matchGlob` function (now in asStoneGlob.ts)

### verify

```sh
npm run build:compile
```
- [ ] compiles without type errors (tests may fail â€” updated in phase 3)


## phase 2: formatRouteStoneEmit â€” treestruct output for del

**read before start:**
- `.behavior/v2026_02_05.stone-del-tune/1.vision.md` (output examples)
- `.behavior/v2026_02_05.stone-del-tune/3.3.blueprint.v1.i1.md` (formatRouteStoneEmit contract)

### steps

- [ ] update `src/domain.operations/route/formatRouteStoneEmit.ts`
  - [ ] add `HEADER_DEL = "ðŸ¦‰ hoo needs 'em"`
  - [ ] update header selection: del gets its own header
  - [ ] replace old del variant in `FormatInput` union with new shape (mode, pattern, patternRaw, route, stones[], countDelete, countRetain)
  - [ ] implement new del format:
    - `ðŸ¦‰ hoo needs 'em` header
    - `ðŸ—¿ route.stone.del --mode {plan|apply}` operation line
    - `â”œâ”€ pattern = {glob} (from "{raw}")` â€” only show `(from ...)` when glob differs from raw
    - `â”œâ”€ route = {route}`
    - `â”œâ”€ stones` branch with nested `â”‚  â”œâ”€ âœ“/âŠ˜ {name} ({status})` lines
    - `â”œâ”€ delete/deleted = N`
    - `â””â”€ retain/retained = N (artifact found)` â€” omit if count is 0
    - plan mode: append `\nrerun with --mode apply to execute`
  - [ ] retain get + set variants unchanged

### verify

```sh
npm run build:compile
```
- [ ] compiles without type errors


## phase 3: update unit + integration tests

**read before start:**
- `.behavior/v2026_02_05.stone-del-tune/2.1.criteria.blackbox.md` (all usecases)

### steps

- [ ] update `src/domain.operations/route/stepRouteStoneDel.test.ts`
  - [ ] update all calls to pass `mode: 'apply'` (prior behavior)
  - [ ] update assertions: `skipped` â†’ `retained`, check `stones[]` array, check `pattern`/`patternRaw`
  - [ ] add plan mode cases: verify no files removed, verify stones have `delete`/`retain` status
  - [ ] add fuzzy pattern case: `stone: 'research'` matches research stones
  - [ ] update emit assertions: check for `ðŸ¦‰` header and treestruct format

- [ ] update `src/domain.operations/route/stepRouteStoneDel.integration.test.ts`
  - [ ] update all calls to pass `mode: 'apply'`
  - [ ] update assertions: `skipped` â†’ `retained`
  - [ ] add plan mode case: verify no disk changes, stones classified correctly
  - [ ] update emit assertions: check treestruct format

### verify

```sh
npm run test:unit -- stepRouteStoneDel
npm run test:integration -- stepRouteStoneDel
```
- [ ] all unit tests pass
- [ ] all integration tests pass


## phase 4: cli â€” parse --mode arg

**read before start:**
- `.behavior/v2026_02_05.stone-del-tune/3.3.blueprint.v1.i1.md` (cli codepath)

### steps

- [ ] update `src/contract/cli/route.ts`
  - [ ] update `printDelHelp()`: add `--mode <plan|apply>` option with note that plan is default
  - [ ] update `routeStoneDel()`: parse `--mode` from argv, default to `'plan'`
  - [ ] pass `mode` to `stepRouteStoneDel`

### verify

```sh
npm run build:compile
```
- [ ] compiles without type errors


## phase 5: acceptance tests

**read before start:**
- `.behavior/v2026_02_05.stone-del-tune/2.1.criteria.blackbox.md` (all usecases)

### steps

- [ ] update `blackbox/driver.route.del.acceptance.test.ts`
  - [ ] [case1] plan mode default: invoke without `--mode`, verify no files removed, stdout has `ðŸ¦‰` header + `ðŸ—¿` treestruct + `rerun with --mode apply`
  - [ ] [case2] apply mode: invoke with `--mode apply`, verify files removed, stdout has treestruct with `(deleted)`/`(retained)`
  - [ ] [case3] fuzzy pattern: invoke with `--stone research`, verify matches research stones (fixture may need research-named stones)
  - [ ] [case4] retain with artifact: verify `(retain, artifact found)` in plan, `(retained, artifact found)` in apply
  - [ ] update all prior stdout assertions from `deleted:`/`skipped` flat format to treestruct format

### verify

```sh
npm run build && npm run test:acceptance:locally -- driver.route.del
```
- [ ] all acceptance tests pass


## phase 6: full verification

### verify

```sh
npm run build
npm run test:types
npm run test:lint
npm run test:unit
npm run test:integration
npm run test:acceptance:locally
```
- [ ] all checks pass

