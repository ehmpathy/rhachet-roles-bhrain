# roadmap: drive-spinners

## overview

seven phases, ordered by dependency. each phase is independently verifiable before the next begins.

```
phase 0: domain objects          â† no deps
phase 1: formatGuardTree         â† depends on phase 0
phase 2: genContextCliEmit       â† depends on phase 0
phase 3: progress event emission â† depends on phase 0
phase 4: context propagation     â† depends on phase 3
phase 5: stdout guard tree       â† depends on phase 1
phase 6: cli glue                â† depends on phases 2, 4, 5
phase 7: acceptance tests        â† depends on all phases
```

---

## phase 0: domain objects

**goal**: declare the two new domain types that the rest of the feature depends on

**read before**:
- `.behavior/v2026_02_04.drive-spinners/3.3.blueprint.v1.i1.md` â€” domain decomposition section

**checklist**:
- [ ] create `src/domain.objects/Driver/GuardProgressEvent.ts`
  - declare `GuardProgressEvent` interface with `stone`, `step`, `inflight`, `outcome`
- [ ] create `src/domain.objects/Driver/ContextCliEmit.ts`
  - declare `ContextCliEmit` interface with `cliEmit.onGuardProgress`
- [ ] export both from the domain.objects barrel (if one exists for Driver/)

**acceptance criteria**:
```
given('GuardProgressEvent and ContextCliEmit are declared')
  when('npm run test:types')
    then('type check passes with no errors')
  when('a procedure declares context: ContextCliEmit')
    then('onGuardProgress is required (not optional)')
    then('onGuardProgress accepts a GuardProgressEvent')
```

**verification**: `npm run test:types`

---

## phase 1: formatGuardTree (pure format)

**goal**: pure function that produces the guard tree string from result data â€” no side effects, no i/o

**read before**:
- `.behavior/v2026_02_04.drive-spinners/1.vision.md` â€” contract inputs & outputs section (stdout final emit)
- `.behavior/v2026_02_04.drive-spinners/2.2.criteria.blackbox.matrix.md` â€” matrices 1-3 (stdout guard tree, review lines, judge lines)
- `.behavior/v2026_02_04.drive-spinners/3.3.blueprint.v1.i1.md` â€” formatGuardTree section

**depends on**: phase 0

**checklist**:
- [ ] create `src/domain.operations/route/guard/formatGuardTree.ts`
  - pure function: guard results â†’ multi-line tree string with box-draw characters
  - format artifact filenames under `artifacts` section
  - format reviews with `r{index}: {cmd}` labels + result sub-branches
  - format judges with `j{index}: {cmd}` labels + result sub-branches
  - show `Â· cached` for cached items (no duration, no detail sub-branches)
  - show `finished {dur}s âœ“` for fresh completed reviews
  - show `finished {dur}s âœ“` or `finished {dur}s âœ—` for fresh judges
  - show blocker/nitpick counts with `ðŸ”´`/`ðŸŸ ` only when count > 0
  - show judge reason only when judge failed
  - show `passage = allowed` or `passage = blocked` with reason
- [ ] create `src/domain.operations/route/guard/formatGuardTree.test.ts`
  - [case1] reviews+judges, allowed, all fresh â€” full tree with `finished âœ“`, blocker counts
  - [case2] reviews+judges, blocked, all fresh â€” tree with `finished âœ—`, reason line
  - [case3] some cached reviews â€” cached shows `Â· cached`, fresh shows `finished âœ“`
  - [case4] all cached â€” all show `Â· cached`
  - [case5] unguarded stone â€” omits guard section, shows `allowed (unguarded)`
  - [case6] artifacts only guard â€” shows artifacts, omits reviews/judges
  - [case7] multiple artifacts â€” each listed under artifacts section
  - [case8] review with nitpicks only â€” omit blocker line, show `2 nitpicks ðŸŸ `
  - [case9] review with both blockers and nitpicks â€” both lines with indicators
  - [case10] cached judge that had failed â€” shows `Â· cached`, omits reason
  - [case11] passage line with reason â€” `passage = blocked` + `reason = ...`
  - all cases use snapshot assertions to lock exact tree format

**acceptance criteria**:
```
given('formatGuardTree with fresh reviews and judges')
  when('called with 2 reviews (0 blockers, 3 blockers) and 1 judge (passed)')
    then('output matches snapshot with âœ“ marks, blocker counts, and passage = allowed')

given('formatGuardTree with cached items')
  when('called with all cached reviews and judges')
    then('all items show Â· cached with no duration or detail lines')

given('formatGuardTree with no guard')
  when('called with no guard input')
    then('output omits guard section and shows passage = allowed (unguarded)')
```

**verification**: `npm run test:unit -- formatGuardTree`

---

## phase 2: genContextCliEmit (stderr orchestrator)

**goal**: construct a `ContextCliEmit` that drives stderr progress output via `\r` overwrite on the last line

**read before**:
- `.behavior/v2026_02_04.drive-spinners/1.vision.md` â€” stderr phase 2 (active line) section
- `.behavior/v2026_02_04.drive-spinners/3.1.research.claims._.v1.i1.md` â€” claims about single-line approach, non-tty fallback
- `.behavior/v2026_02_04.drive-spinners/3.3.blueprint.v1.i1.md` â€” genContextCliEmit section

**depends on**: phase 0

**checklist**:
- [ ] create `src/domain.operations/route/guard/genContextCliEmit.ts`
  - accepts `{ stderr: NodeJS.WriteStream }`
  - returns `{ context: ContextCliEmit; done: () => void }`
  - on inflight event (`endedAt = null`): start spinner interval at 80ms, overwrite last line via `\r`
  - on finished event (`endedAt` + `outcome`): clear interval, overwrite spinner with result, print detail lines
  - braille frames: `['â ‹', 'â ™', 'â ¹', 'â ¸', 'â ¼', 'â ´', 'â ¦', 'â §', 'â ‡', 'â ']`
  - pad replacement lines with end-spaces to prevent stale characters
  - non-tty fallback: skip `\r` overwrites, print static lines instead
  - `done()` clears any active interval and writes a final newline
- [ ] create `src/domain.operations/route/guard/genContextCliEmit.test.ts`
  - [case1] inflight event â€” stderr shows `inflight {elapsed}s â ¹` on last line
  - [case2] finished event after inflight â€” spinner line overwritten with `finished {dur}s âœ“`
  - [case3] non-tty mode â€” no `\r` overwrites, static line prints only
  - [case4] judge finished with failure â€” shows `finished {dur}s âœ—`

**acceptance criteria**:
```
given('a tty stderr stream')
  when('onGuardProgress receives an inflight event')
    then('stderr last line shows inflight {elapsed}s with braille spinner')
  when('onGuardProgress receives a finished event')
    then('spinner line is overwritten with finished {dur}s âœ“ or âœ—')
    then('detail lines (blockers, nitpicks, reason) print below')

given('a non-tty stderr stream')
  when('onGuardProgress receives events')
    then('no \\r overwrites occur')
    then('static lines print instead')
```

**verification**: `npm run test:unit -- genContextCliEmit`

---

## phase 3: progress event emission

**goal**: update `runStoneGuardReviews` and `runStoneGuardJudges` to accept `context: ContextCliEmit` and emit `GuardProgressEvent`s before and after each review/judge

**read before**:
- `.behavior/v2026_02_04.drive-spinners/2.2.criteria.blackbox.matrix.md` â€” matrix 4 (stderr live progress)
- `.behavior/v2026_02_04.drive-spinners/3.3.blueprint.v1.i1.md` â€” runStoneGuardReviews and runStoneGuardJudges sections

**depends on**: phase 0

**checklist**:
- [ ] update `src/domain.operations/route/guard/runStoneGuardReviews.ts`
  - accept `context: ContextCliEmit` as second arg
  - before each `runOneStoneGuardReview`: emit `{ step: { phase: 'review', index }, inflight: { beganAt, endedAt: null }, outcome: null }`
  - after each `runOneStoneGuardReview`: emit `{ step: { phase: 'review', index }, inflight: { beganAt, endedAt }, outcome: { path, review: { blockers, nitpicks } } }`
  - for cached reviews (those in `doneIndices`): no events emitted
- [ ] update `src/domain.operations/route/judges/runStoneGuardJudges.ts`
  - accept `context: ContextCliEmit` as second arg
  - before each `runOneStoneGuardJudge`: emit `{ step: { phase: 'judge', index }, inflight: { beganAt, endedAt: null }, outcome: null }`
  - after each `runOneStoneGuardJudge`: emit `{ step: { phase: 'judge', index }, inflight: { beganAt, endedAt }, outcome: { path, judge: { decision, reason } } }`
  - for cached judges (those in `priorPassedByIndex`): no events emitted
- [ ] update all callers of these procedures to pass `context: { cliEmit: { onGuardProgress: () => {} } }` where needed (tests, etc)

**acceptance criteria**:
```
given('a guarded stone with 2 reviews (1 cached, 1 fresh)')
  when('runStoneGuardReviews completes')
    then('onGuardProgress is called twice for the fresh review (inflight then finished)')
    then('onGuardProgress is not called for the cached review')

given('a guarded stone with 2 judges (1 cached, 1 fresh)')
  when('runStoneGuardJudges completes')
    then('onGuardProgress is called twice for the fresh judge (inflight then finished)')
    then('onGuardProgress is not called for the cached judge')
```

**verification**: `npm run test:types && npm run test:integration -- runStoneGuardReviews` and `npm run test:integration -- runStoneGuardJudges`

---

## phase 4: context propagation

**goal**: thread `ContextCliEmit` through the call chain from `stepRouteStoneSet` â†’ `setStoneAsPassed` â†’ reviews/judges, and collect guard result data for stdout emit

**read before**:
- `.behavior/v2026_02_04.drive-spinners/3.3.blueprint.v1.i1.md` â€” setStoneAsPassed and stepRouteStoneSet sections, execution sequence

**depends on**: phase 3

**checklist**:
- [ ] update `src/domain.operations/route/stones/setStoneAsPassed.ts`
  - accept `context: ContextCliEmit` as second arg
  - propagate `context` to `runStoneGuardReviews` and `runStoneGuardJudges`
  - collect guard progress data (review/judge results) and pass to `formatRouteStoneEmit` via the new guard field
- [ ] update `src/domain.operations/route/stepRouteStoneSet.ts`
  - accept `context: ContextCliEmit` as second arg
  - propagate context to `setStoneAsPassed`
- [ ] update all callers/tests of these procedures to pass `context: { cliEmit: { onGuardProgress: () => {} } }`

**acceptance criteria**:
```
given('stepRouteStoneSet called with ContextCliEmit')
  when('a guarded stone has fresh reviews')
    then('onGuardProgress receives events in correct order (inflight â†’ finished per review, then inflight â†’ finished per judge)')
  when('a guarded stone has all cached reviews')
    then('onGuardProgress receives no events')
```

**verification**: `npm run test:types && npm run test:integration -- setStoneAsPassed` and `npm run test:integration -- stepRouteStoneSet`

---

## phase 5: stdout guard tree

**goal**: add the guard tree section to the final stdout emit via `formatRouteStoneEmit`

**read before**:
- `.behavior/v2026_02_04.drive-spinners/1.vision.md` â€” stdout (final emit) section
- `.behavior/v2026_02_04.drive-spinners/2.1.criteria.blackbox.md` â€” usecase.1 (guard progress tree in stdout)
- `.behavior/v2026_02_04.drive-spinners/2.2.criteria.blackbox.matrix.md` â€” matrices 1-3
- `.behavior/v2026_02_04.drive-spinners/3.3.blueprint.v1.i1.md` â€” formatRouteStoneEmit section

**depends on**: phase 1 (formatGuardTree)

**checklist**:
- [ ] update `src/domain.operations/route/formatRouteStoneEmit.ts`
  - add new union variant for `'passed'` action that includes optional `guard` field
  - when `guard` is present, delegate to `formatGuardTree` for the tree section
  - include artifact paths, review results, judge results in the guard data
- [ ] update collocated tests for `formatRouteStoneEmit`
  - add test cases for the new guard tree variant
  - snapshot assertions to lock the exact stdout format

**acceptance criteria**:
```
given('formatRouteStoneEmit with guard data')
  when('passage is allowed with fresh reviews and judges')
    then('stdout contains guard section with artifacts, reviews (âœ“), judges (âœ“), passage = allowed')
  when('passage is blocked with a failed judge')
    then('stdout contains guard section with âœ—, reason, passage = blocked')
  when('some reviews are cached')
    then('cached reviews show Â· cached, fresh reviews show finished âœ“')
  when('no guard data')
    then('stdout omits guard section (backward compatible)')
```

**verification**: `npm run test:unit -- formatRouteStoneEmit`

---

## phase 6: cli glue

**goal**: construct `ContextCliEmit` in the cli layer and thread it through the call chain; emit stderr plan tree before execution

**read before**:
- `.behavior/v2026_02_04.drive-spinners/1.vision.md` â€” stderr phase 1 (plan tree) and phase 2 (active line)
- `.behavior/v2026_02_04.drive-spinners/3.3.blueprint.v1.i1.md` â€” route.ts routeStoneSet section, execution sequence, risks and mitigations

**depends on**: phases 2, 4, 5

**checklist**:
- [ ] update `src/contract/cli/route.ts`
  - construct `ContextCliEmit` via `genContextCliEmit({ stderr: process.stderr })`
  - emit phase 1 plan tree to stderr (static print of guard tree with `Â· queued` / `Â· cached` indicators)
  - pass `{ cliEmit: progress.context.cliEmit }` as context to `stepRouteStoneSet`
  - call `progress.done()` in a finally block to clean up spinner interval
  - print `result.emit.stdout` to stdout after completion
- [ ] manual smoke test: run `route.stone.set` on a guarded stone and verify both stderr progress and stdout tree

**acceptance criteria**:
```
given('route.stone.set on a guarded stone with reviews and judges')
  when('execution begins')
    then('stderr shows plan tree with Â· queued indicators')
  when('a review starts')
    then('stderr last line shows inflight {elapsed}s with spinner')
  when('a review finishes')
    then('stderr shows finished {dur}s âœ“ and detail lines')
  when('execution completes')
    then('stdout shows full guard tree with results')
    then('no spinner artifacts remain in output')
```

**verification**: manual smoke test + `npm run test:types`

---

## phase 7: acceptance tests

**goal**: end-to-end verification of the full guard tree output via acceptance tests

**read before**:
- `.behavior/v2026_02_04.drive-spinners/2.1.criteria.blackbox.md` â€” all usecases
- `.behavior/v2026_02_04.drive-spinners/2.2.criteria.blackbox.matrix.md` â€” all matrices

**depends on**: all prior phases

**checklist**:
- [ ] update `driver.route.set.acceptance.test.ts`
  - [case-new-1] stdout guard tree on passage allowed â€” guarded stone, reviews pass, judges pass â†’ stdout contains `finished âœ“`, `passage = allowed`
  - [case-new-2] stdout guard tree on passage blocked â€” guarded stone, judge fails â†’ stdout contains `finished âœ—`, `passage = blocked`, `reason = ...`
  - [case-new-3] stderr plan tree emitted â€” guarded stone â†’ stderr contains `Â· queued` indicators
  - [case-new-4] stdout guard tree with cached reviews â€” second run (same artifacts) â†’ stdout shows `Â· cached`

**acceptance criteria**:
```
given('a guarded stone with reviews and judges')
  when('setStoneAsPassed completes with passage allowed')
    then('stdout contains guard section with artifacts, reviews, and judges')
    then('each review shows âœ“ finished {duration}s')
    then('each review shows blocker count with ðŸ”´ when blockers > 0')
    then('each judge shows âœ“ finished {duration}s')
    then('stdout contains passage = allowed')

  when('setStoneAsPassed completes with passage blocked')
    then('each failed judge shows âœ— finished {duration}s')
    then('stdout contains passage = blocked')
    then('stdout contains reason')

given('a guarded stone with cached reviews')
  when('second run with same artifacts')
    then('cached reviews show Â· cached')
    then('fresh reviews show âœ“ finished {duration}s')
```

**verification**: `npm run test:acceptance:locally -- driver.route.set`

---

## summary

| phase | what | files | depends on | verification |
|-------|------|-------|-----------|--------------|
| 0 | domain objects | `GuardProgressEvent.ts`, `ContextCliEmit.ts` | â€” | `test:types` |
| 1 | formatGuardTree | `formatGuardTree.ts`, `.test.ts` | 0 | `test:unit` |
| 2 | genContextCliEmit | `genContextCliEmit.ts`, `.test.ts` | 0 | `test:unit` |
| 3 | progress emission | `runStoneGuardReviews.ts`, `runStoneGuardJudges.ts` | 0 | `test:integration` |
| 4 | context propagation | `setStoneAsPassed.ts`, `stepRouteStoneSet.ts` | 3 | `test:integration` |
| 5 | stdout guard tree | `formatRouteStoneEmit.ts` | 1 | `test:unit` |
| 6 | cli glue | `route.ts` | 2, 4, 5 | smoke test + `test:types` |
| 7 | acceptance tests | `driver.route.set.acceptance.test.ts` | all | `test:acceptance:locally` |

phases 1, 2, 3 can proceed in parallel after phase 0 completes.
