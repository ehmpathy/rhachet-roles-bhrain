# roadmap: route.bind

## overview

this roadmap covers the execution of the route.bind blueprint across 5 phases. each phase has ordered dependencies, acceptance criteria, and verification steps.

---

## phase 0: infrastructure setup

> **read before start:**
> - `.behavior/v2026_02_05.driver-route-bind/3.3.blueprint.v1.i1.md` (blueprint)
> - `.behavior/v2026_02_05.driver-route-bind/3.1.research.patterns._.code.test.v1.i1.md` (test patterns)
> - `.behavior/v2026_02_05.driver-route-bind/3.1.research.patterns._.code.prod.v1.i1.md` (prod patterns)

### checklist

- [ ] **0.1** extend `invokeRouteSkill()` skill union in `blackbox/.test/invokeRouteSkill.ts`
  - add `'route.bind'` to the skill type union
  - acceptance: `'route.bind'` is a valid skill argument with no type errors

- [ ] **0.2** create `route.bind.sh` shell entrypoint in `src/domain.roles/driver/skills/`
  - follow the fast-cli-subpath pattern: `node -e "import('rhachet-roles-bhrain/cli').then(m => m.cli.route.bind())" -- "$@"`
  - acceptance: file exists, is executable, follows the pattern of `route.stone.get.sh`

### verification

```sh
npm run test:types
```

---

## phase 1: domain operations (bind core)

> **read before start:**
> - `.behavior/v2026_02_05.driver-route-bind/3.3.blueprint.v1.i1.md` (operation details section)
> - `.behavior/v2026_02_05.driver-route-bind/3.1.research.domain._.v1.i1.md` (domain terms)
> - `.behavior/v2026_02_05.driver-route-bind/3.1.research.patterns._.code.prod.v1.i1.md` (prod patterns)
> - `.behavior/v2026_02_05.driver-route-bind/3.1.research.patterns._.code.test.v1.i1.md` (test patterns)

### checklist

- [ ] **1.1** create `getRouteBindByBranch.ts` + `getRouteBindByBranch.test.ts`
  - location: `src/domain.operations/route/bind/`
  - reuse: `sanitizeBranchName()` from `src/domain.operations/review/`, `enumFilesFromGlob()` from `src/utils/`
  - unit test cases:
    - zero flag files → returns null
    - one flag file → returns correct route path (derives parent of `.route/`)
    - multiple flag files → throws disambiguation error
    - branch name is flattened correctly (`/` → `.`)
  - acceptance: all unit tests pass

- [ ] **1.2** create `setRouteBind.ts` + `setRouteBind.test.ts`
  - location: `src/domain.operations/route/bind/`
  - depends on: 1.1 (`getRouteBindByBranch` for pre-bind scan)
  - unit test cases:
    - creates flag file with correct format (`branch:` + `bound_by:`) and correct location (`<route>/.route/.bind.<flat>.flag`)
    - idempotent on same route (second call returns same result, no error)
    - rejects different route when already bound (error: "already bound to X")
    - rejects protected branches (main, master)
    - rejects absent route directory
  - acceptance: all unit tests pass

- [ ] **1.3** create `getRouteBind.ts`
  - location: `src/domain.operations/route/bind/`
  - depends on: 1.1 (thin wrapper over `getRouteBindByBranch({ branch: null })`)
  - no separate test file needed — tested via `getRouteBindByBranch` tests
  - acceptance: types compile clean

- [ ] **1.4** create `delRouteBind.ts` + `delRouteBind.test.ts`
  - location: `src/domain.operations/route/bind/`
  - unit test cases:
    - removes flag file when bound → returns `{ deleted: true }`
    - idempotent when not bound → returns `{ deleted: false }`, no error
  - acceptance: all unit tests pass

### verification

```sh
npm run test:types
npm run test:unit -- getRouteBindByBranch
npm run test:unit -- setRouteBind
npm run test:unit -- delRouteBind
```

---

## phase 2: cli layer

> **read before start:**
> - `.behavior/v2026_02_05.driver-route-bind/3.3.blueprint.v1.i1.md` (contracts section)
> - `.behavior/v2026_02_05.driver-route-bind/3.1.research.patterns._.code.prod.v1.i1.md` (prod patterns)

### checklist

- [ ] **2.1** add `routeBind()` cli entrypoint to `src/contract/cli/route.ts`
  - dispatch logic: `--get` → `getRouteBind()`, `--del` → `delRouteBind()`, `--route` → `setRouteBind()`
  - stdout messages: bind confirms route path, get shows "bound to: X" or "not bound", del confirms unbind
  - follows the same pattern as `routeStoneGet()` / `routeStoneSet()` / etc.
  - acceptance: `routeBind` function exists and compiles

- [ ] **2.2** add `route.bind` to cli exports
  - update `src/contract/cli/index.ts`: add `bind: routeBind` to `cli.route`
  - update `src/index.ts`: ensure `cli.route.bind` is exported
  - acceptance: `import('rhachet-roles-bhrain/cli').then(m => m.cli.route.bind)` resolves to a function

### verification

```sh
npm run test:types
npm run build
```

---

## phase 3: auto-resolve integration

> **read before start:**
> - `.behavior/v2026_02_05.driver-route-bind/3.3.blueprint.v1.i1.md` (auto-resolve integration section)
> - `.behavior/v2026_02_05.driver-route-bind/2.1.criteria.blackbox.md` (usecases 4-6: auto-resolve)

### checklist

- [ ] **3.1** modify `routeStoneGet()` to auto-resolve `--route` from bind
  - replace the `if (!options.route) { error; exit(1) }` block
  - new logic: if `--route` absent → call `getRouteBindByBranch({ branch: null })` → use bind route or error with guidance
  - explicit `--route` still wins (the fallback only fires when absent)
  - acceptance: compiles, pre-bind tests still pass with explicit `--route`

- [ ] **3.2** modify `routeStoneSet()` to auto-resolve `--route` from bind
  - same pattern as 3.1
  - acceptance: compiles, pre-bind tests still pass with explicit `--route`

- [ ] **3.3** modify `routeStoneDel()` to auto-resolve `--route` from bind
  - same pattern as 3.1
  - acceptance: compiles, pre-bind tests still pass with explicit `--route`

- [ ] **3.4** modify `routeStoneJudge()` to auto-resolve `--route` from bind
  - same pattern as 3.1
  - acceptance: compiles, pre-bind tests still pass with explicit `--route`

### verification

```sh
npm run test:types
npm run build
npm run test:acceptance:locally -- driver.route.stone
```

verify no regressions: all pre-bind acceptance tests (that use explicit `--route`) still pass.

---

## phase 4: acceptance tests

> **read before start:**
> - `.behavior/v2026_02_05.driver-route-bind/2.1.criteria.blackbox.md` (all 8 usecases)
> - `.behavior/v2026_02_05.driver-route-bind/3.3.blueprint.v1.i1.md` (test coverage section)
> - `.behavior/v2026_02_05.driver-route-bind/3.1.research.patterns._.code.test.v1.i1.md` (test patterns)

### checklist

- [ ] **4.1** write `driver.route.bind.acceptance.test.ts` — usecases 1-3: bind, get, del
  - location: `blackbox/`
  - reuse: `genTempDirForRhachet()`, `invokeRouteSkill()`
  - test cases (per blueprint):
    - `[case1]` route with stones: bind → idempotent rebind → get → del → idempotent del → get after del
    - `[case2]` route path not found: error with path in message, nonzero exit
    - `[case3]` protected branch (main): error "cannot bind route on protected branch", nonzero exit
    - `[case4]` bind to different route when already bound: error "already bound to X", nonzero exit
  - acceptance: all 4 cases pass

- [ ] **4.2** write `driver.route.bind.autoresolve.acceptance.test.ts` — usecases 4-8: auto-resolve, ambiguity, episode
  - location: `blackbox/`
  - reuse: `genTempDirForRhachet()`, `invokeRouteSkill()`
  - test cases (per blueprint):
    - `[case1]` bound route with stones: full episode — bind → get next → set passed → get next (advances) → explicit override → del → get next fails
    - `[case2]` branch with no bind: error "no route bound to this branch", nonzero exit
    - `[case3]` multiple routes bound (ambiguity): error "multiple routes bound", nonzero exit
  - acceptance: all 3 cases pass

### verification

```sh
npm run build
npm run test:acceptance:locally -- driver.route.bind
```

---

## phase 5: full verification

> **read before start:**
> - `.behavior/v2026_02_05.driver-route-bind/2.1.criteria.blackbox.md` (full criteria reference)

### checklist

- [ ] **5.1** run all unit tests
  - acceptance: zero failures

- [ ] **5.2** run all acceptance tests (bind + pre-bind)
  - acceptance: zero failures, no regressions on `driver.route.stone.*` tests

- [ ] **5.3** run type check
  - acceptance: zero type errors

- [ ] **5.4** run lint + format
  - acceptance: zero violations

- [ ] **5.5** manual smoke test: bind the current branch and verify
  ```sh
  npm run build
  npx rhachet roles link --role driver
  bash .agent/repo=bhrain/role=driver/skills/route.bind.sh --route .behavior/v2026_02_05.driver-route-bind
  bash .agent/repo=bhrain/role=driver/skills/route.stone.get.sh --stone @next-one
  bash .agent/repo=bhrain/role=driver/skills/route.bind.sh --get
  bash .agent/repo=bhrain/role=driver/skills/route.bind.sh --del
  ```
  - acceptance: bind succeeds, stone get auto-resolves without `--route`, get shows bound path, del unbinds

### verification

```sh
npm run test:types
npm run test:lint
npm run test:format
npm run test:unit
npm run test:acceptance:locally
```

---

## dependency graph

```
phase 0 (infrastructure setup)
  ├── 0.1 extend invokeRouteSkill union
  └── 0.2 create route.bind.sh
        │
        ▼
phase 1 (domain operations)
  ├── 1.1 getRouteBindByBranch + tests
  ├── 1.2 setRouteBind + tests         ← depends on 1.1
  ├── 1.3 getRouteBind                 ← depends on 1.1
  └── 1.4 delRouteBind + tests
        │
        ▼
phase 2 (cli layer)
  ├── 2.1 routeBind() cli entrypoint   ← depends on 1.1, 1.2, 1.3, 1.4
  └── 2.2 cli exports update           ← depends on 2.1
        │
        ▼
phase 3 (auto-resolve integration)
  ├── 3.1 routeStoneGet auto-resolve   ← depends on 1.1
  ├── 3.2 routeStoneSet auto-resolve   ← depends on 1.1
  ├── 3.3 routeStoneDel auto-resolve   ← depends on 1.1
  └── 3.4 routeStoneJudge auto-resolve ← depends on 1.1
        │
        ▼
phase 4 (acceptance tests)
  ├── 4.1 bind/get/del tests           ← depends on phase 2
  └── 4.2 auto-resolve tests           ← depends on phase 3
        │
        ▼
phase 5 (full verification)
  └── 5.1-5.5 all checks               ← depends on phase 4
```
